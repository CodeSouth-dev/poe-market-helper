<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path of Exile Market Helper</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #ffd700;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: #cccccc;
            font-size: 1.1em;
        }

        .search-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.9em;
        }

        input[type="text"], select {
            padding: 12px;
            border: 2px solid #444;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            font-size: 16px;
            min-width: 200px;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .error {
            background: rgba(255,0,0,0.2);
            color: #ffcccc;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff0000;
        }

        .results-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-title {
            color: #ffd700;
            font-size: 1.5em;
        }

        .results-meta {
            color: #cccccc;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9em;
            color: #cccccc;
            margin-top: 5px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .results-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .results-table tr:hover {
            background: rgba(255,255,255,0.1);
        }

        .price {
            font-weight: bold;
            color: #90EE90;
        }

        .no-results {
            text-align: center;
            color: #cccccc;
            font-style: italic;
            padding: 40px;
        }

        .favorites-section {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .favorites-header {
            color: #ffd700;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .favorite-info {
            flex-grow: 1;
        }

        .favorite-name {
            font-weight: bold;
            color: #ffffff;
        }

        .favorite-meta {
            font-size: 0.8em;
            color: #cccccc;
        }

        .favorite-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4444ff, #0000cc);
            color: white;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            input[type="text"], select {
                min-width: unset;
                width: 100%;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-table {
                font-size: 0.9em;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Path of Exile Market Helper</h1>
            <p class="subtitle">Live market data from poe.ninja</p>
        </header>

        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="itemName">Item Name:</label>
                    <input type="text" id="itemName" placeholder="e.g., Tabula Rasa, Divine Orb, Shaper's Touch" required>
                </div>
                
                <div class="form-group">
                    <label for="league">League:</label>
                    <select id="league">
                        <option value="Crucible">Crucible</option>
                        <option value="Hardcore Crucible">Hardcore Crucible</option>
                        <option value="Standard">Standard</option>
                        <option value="Hardcore">Hardcore</option>
                    </select>
                </div>
                
                <button type="submit" id="searchBtn">Search</button>
                <button type="button" id="favoriteBtn" style="display: none;">Add to Favorites</button>
            </form>
        </section>

        <div id="loading" class="loading" style="display: none;">
            üîç Searching poe.ninja...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <!-- Advanced Crafting Chain Builder -->
        <section class="search-section">
            <h2 style="color: #ffd700; margin-bottom: 15px;">üéì Advanced Crafting Chain Builder</h2>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 0.9em;">
                Learn crafting step-by-step with ilvl requirements, mod probabilities, and advanced tactics
            </p>

            <div class="search-form" style="display: block;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="chainBaseItem">Base Item:</label>
                        <input type="text" id="chainBaseItem" placeholder="e.g., Stygian Vise, Vaal Regalia">
                    </div>

                    <div class="form-group">
                        <label for="chainIlvl">Item Level (ilvl):</label>
                        <select id="chainIlvl">
                            <option value="50">ilvl 50 (Low tier)</option>
                            <option value="64">ilvl 64 (T4 mods)</option>
                            <option value="73">ilvl 73 (T3 mods)</option>
                            <option value="81">ilvl 81 (T2 mods)</option>
                            <option value="86" selected>ilvl 86 (T1 mods)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="chainStrategy">Crafting Strategy:</label>
                        <select id="chainStrategy">
                            <option value="alt_regal_multimod">Alt-Regal-Multimod (Beginner)</option>
                            <option value="essence_spam">Essence Spam (Beginner)</option>
                            <option value="fossil_spam">Fossil Spam (Beginner)</option>
                            <option value="alt_regal_annul">Alt-Regal-Annul (Intermediate)</option>
                            <option value="harvest_reforge">Harvest Reforge (Intermediate)</option>
                            <option value="alt_regal_recombinator">Alt-Recombinator (Advanced)</option>
                            <option value="eldritch_crafting">Eldritch Crafting (Advanced)</option>
                            <option value="metacraft_exalt">Metacraft-Exalt (Expert)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="chainLeague">League:</label>
                        <select id="chainLeague">
                            <option value="Crucible">Crucible</option>
                            <option value="Hardcore Crucible">Hardcore Crucible</option>
                            <option value="Standard">Standard</option>
                            <option value="Hardcore">Hardcore</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" id="buildChainBtn">Build Crafting Chain</button>
                    <button type="button" id="showTacticsBtn">Show Advanced Tactics</button>
                    <button type="button" id="showEducationBtn">Crafting Guide</button>
                </div>
            </div>

            <!-- Crafting Chain Results -->
            <div id="craftingChainResults" style="display: none; margin-top: 20px;">
                <h3 style="color: #ffd700; margin-bottom: 10px;">üìã Crafting Chain Steps</h3>
                <div id="chainStepsList" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px;">
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 5px; border-left: 3px solid #ffd700;">
                    <h4 style="color: #ffd700; margin-bottom: 10px;">üí° Educational Notes</h4>
                    <div id="educationalNotes"></div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-value" id="chainTotalCost">-</div>
                        <div class="stat-label">Total Expected Cost</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-value" id="chainSuccessRate">-</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="stat-value" id="chainDifficulty">-</div>
                        <div class="stat-label">Difficulty</div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tactics Modal -->
            <div id="tacticsModal" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px;">
                <h3 style="color: #ffd700; margin-bottom: 15px;">‚öîÔ∏è Advanced Crafting Tactics</h3>
                <div id="tacticsList"></div>
                <button type="button" id="closeTacticsBtn" style="margin-top: 15px;">Close</button>
            </div>

            <!-- Crafting Education Modal -->
            <div id="educationModal" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px;">
                <h3 style="color: #ffd700; margin-bottom: 15px;">üìö Crafting Concepts & Guide</h3>
                <div id="educationContent"></div>
                <button type="button" id="closeEducationBtn" style="margin-top: 15px;">Close</button>
            </div>
        </section>

        <!-- Crafting Profitability Calculator -->
        <section class="search-section">
            <h2 style="color: #ffd700; margin-bottom: 15px;">üí∞ Simple Crafting Profitability Calculator</h2>
            <form class="search-form" id="craftingForm">
                <div class="form-group">
                    <label for="targetItem">Target Item:</label>
                    <input type="text" id="targetItem" placeholder="e.g., Stygian Vise with +100 life" required>
                </div>

                <div class="form-group">
                    <label for="baseItem">Base Item Name:</label>
                    <input type="text" id="baseItem" placeholder="e.g., Stygian Vise" required>
                </div>

                <div class="form-group">
                    <label for="craftLeague">League:</label>
                    <select id="craftLeague">
                        <option value="Crucible">Crucible</option>
                        <option value="Hardcore Crucible">Hardcore Crucible</option>
                        <option value="Standard">Standard</option>
                        <option value="Hardcore">Hardcore</option>
                    </select>
                </div>

                <button type="button" id="addMethodBtn">Add Crafting Method</button>
                <button type="submit" id="calculateBtn">Calculate Profitability</button>
            </form>

            <div id="craftingMethods" style="margin-top: 20px;">
                <h3 style="color: #ffd700; font-size: 1.1em; margin-bottom: 10px;">Crafting Methods:</h3>
                <div id="methodsList"></div>
            </div>
        </section>

        <div id="craftingLoading" class="loading" style="display: none;">
            Calculating profitability...
        </div>

        <div id="craftingError" class="error" style="display: none;"></div>

        <!-- Crafting Results -->
        <section id="craftingResults" class="results-section" style="display: none;">
            <div class="results-header">
                <h2 class="results-title">Profitability Analysis</h2>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="craftMarketPrice">-</div>
                    <div class="stat-label">Market Price</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="craftBestCost">-</div>
                    <div class="stat-label">Best Craft Cost</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="craftProfit" style="color: #90EE90;">-</div>
                    <div class="stat-label">Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="craftRecommendation">-</div>
                    <div class="stat-label">Recommendation</div>
                </div>
            </div>

            <div style="overflow-x: auto; margin-top: 20px;">
                <h3 style="color: #ffd700; margin-bottom: 10px;">Method Comparison:</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Crafting Method</th>
                            <th>Total Cost (Chaos)</th>
                            <th>Expected Attempts</th>
                            <th>Materials</th>
                        </tr>
                    </thead>
                    <tbody id="craftingMethodsTable">
                    </tbody>
                </table>
            </div>
        </section>

        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Search Results</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="minPrice">-</div>
                    <div class="stat-label">Min Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="medianPrice">-</div>
                    <div class="stat-label">Median Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxPrice">-</div>
                    <div class="stat-label">Max Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalListings">-</div>
                    <div class="stat-label">Total Listings</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Base Type</th>
                            <th>Chaos Value</th>
                            <th>Listings</th>
                            <th>Links</th>
                            <th>Variant</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                No items found matching your search.
            </div>
        </section>

        <section class="favorites-section">
            <div class="favorites-header">
                <span>Favorites</span>
                <button type="button" id="refreshFavoritesBtn" class="btn-small">Refresh All</button>
            </div>
            <div id="favoritesList"></div>
            <div id="noFavorites" class="no-results" style="display: none;">
                No favorites added yet. Search for items and add them to your favorites!
            </div>
        </section>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const itemNameInput = document.getElementById('itemName');
        const leagueSelect = document.getElementById('league');
        const searchBtn = document.getElementById('searchBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsMeta = document.getElementById('resultsMeta');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResults = document.getElementById('noResults');
        const favoritesList = document.getElementById('favoritesList');
        const noFavorites = document.getElementById('noFavorites');
        const refreshFavoritesBtn = document.getElementById('refreshFavoritesBtn');

        // State
        let currentSearchResult = null;
        let favorites = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
        });

        // Search form handler
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemName = itemNameInput.value.trim();
            const league = leagueSelect.value;
            
            if (!itemName) {
                showError('Please enter an item name');
                return;
            }

            await searchItem(itemName, league);
        });

        // Add to favorites handler
        favoriteBtn.addEventListener('click', async () => {
            if (!currentSearchResult) return;

            try {
                const itemName = itemNameInput.value.trim();
                const league = leagueSelect.value;
                
                await ipcRenderer.invoke('add-favorite', {
                    name: itemName,
                    league: league
                });

                showSuccess('Added to favorites!');
                favoriteBtn.style.display = 'none';
                await loadFavorites();
            } catch (err) {
                showError(`Failed to add to favorites: ${err.message}`);
            }
        });

        // Refresh favorites handler
        refreshFavoritesBtn.addEventListener('click', async () => {
            refreshFavoritesBtn.disabled = true;
            refreshFavoritesBtn.textContent = 'Refreshing...';
            
            try {
                for (const favorite of favorites) {
                    await searchItem(favorite.name, favorite.league, false);
                }
                showSuccess('All favorites refreshed!');
            } catch (err) {
                showError(`Failed to refresh favorites: ${err.message}`);
            } finally {
                refreshFavoritesBtn.disabled = false;
                refreshFavoritesBtn.textContent = 'Refresh All';
            }
        });

        async function searchItem(itemName, league, showUI = true) {
            try {
                if (showUI) {
                    showLoading();
                    hideError();
                    hideResults();
                }

                searchBtn.disabled = true;
                searchBtn.textContent = 'Searching...';

                const result = await ipcRenderer.invoke('search-item', itemName, league);
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                currentSearchResult = result.data;
                
                if (showUI) {
                    displayResults(result.data);
                    updateFavoriteButton(itemName, league);
                }
            } catch (err) {
                if (showUI) {
                    showError(`Search failed: ${err.message}`);
                }
                console.error('Search error:', err);
            } finally {
                if (showUI) {
                    hideLoading();
                }
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function displayResults(searchResult) {
            const { itemName, league, results, timestamp, minPrice, maxPrice, medianPrice, totalListings } = searchResult;
            
            resultsTitle.textContent = `Results for "${itemName}"`;
            resultsMeta.textContent = `League: ${league} | Updated: ${new Date(timestamp).toLocaleString()}`;
            
            // Update stats
            document.getElementById('minPrice').textContent = minPrice.toFixed(2);
            document.getElementById('medianPrice').textContent = medianPrice.toFixed(2);
            document.getElementById('maxPrice').textContent = maxPrice.toFixed(2);
            document.getElementById('totalListings').textContent = totalListings;
            
            // Clear previous results
            resultsTableBody.innerHTML = '';
            
            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsSection.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            // Populate table
            results.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.baseType || '-')}</td>
                    <td class="price">${item.chaosValue.toFixed(2)}</td>
                    <td>${item.listingCount || item.count || '-'}</td>
                    <td>${item.links || '-'}</td>
                    <td>${escapeHtml(item.variant || '-')}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            
            resultsSection.style.display = 'block';
        }

        async function loadFavorites() {
            try {
                const result = await ipcRenderer.invoke('get-favorites');
                if (result.success) {
                    favorites = result.data;
                    displayFavorites();
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        function displayFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavorites.style.display = 'block';
                return;
            }
            
            noFavorites.style.display = 'none';
            
            favorites.forEach(favorite => {
                const favoriteDiv = document.createElement('div');
                favoriteDiv.className = 'favorite-item';
                
                favoriteDiv.innerHTML = `
                    <div class="favorite-info">
                        <div class="favorite-name">${escapeHtml(favorite.name)}</div>
                        <div class="favorite-meta">
                            League: ${escapeHtml(favorite.league)} | 
                            Added: ${new Date(favorite.addedAt).toLocaleDateString()}
                            ${favorite.lastPrice ? ` | Last Price: ${favorite.lastPrice.toFixed(2)} chaos` : ''}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="btn-small btn-info" onclick="searchFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Search
                        </button>
                        <button class="btn-small btn-danger" onclick="removeFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Remove
                        </button>
                    </div>
                `;
                
                favoritesList.appendChild(favoriteDiv);
            });
        }

        async function searchFavorite(name, league) {
            itemNameInput.value = name;
            leagueSelect.value = league;
            await searchItem(name, league);
        }

        async function removeFavorite(name, league) {
            try {
                await ipcRenderer.invoke('remove-favorite', name);
                showSuccess('Removed from favorites!');
                await loadFavorites();
                updateFavoriteButton(itemNameInput.value.trim(), leagueSelect.value);
            } catch (err) {
                showError(`Failed to remove favorite: ${err.message}`);
            }
        }

        function updateFavoriteButton(itemName, league) {
            const isFavorite = favorites.some(fav => 
                fav.name.toLowerCase() === itemName.toLowerCase() && 
                fav.league === league
            );
            
            favoriteBtn.style.display = currentSearchResult && !isFavorite ? 'inline-block' : 'none';
        }

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'error'; // Reuse error styling but green
            successDiv.style.background = 'rgba(0,255,0,0.2)';
            successDiv.style.color = '#ccffcc';
            successDiv.style.borderColor = '#00ff00';
            successDiv.textContent = message;
            
            error.parentNode.insertBefore(successDiv, error.nextSibling);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-complete functionality (simple implementation)
        const commonItems = [
            'Tabula Rasa', 'Divine Orb', 'Chaos Orb', 'Exalted Orb', 'Ancient Orb',
            'Shaper\'s Touch', 'Goldrim', 'Wanderlust', 'Meginord\'s Girdle',
            'The Baron', 'Belly of the Beast', 'Shavronne\'s Wrappings',
            'Atziri\'s Promise', 'Taste of Hate', 'Dying Sun', 'The Wise Oak'
        ];

        itemNameInput.addEventListener('input', (e) => {
            // Simple auto-suggest could be added here
            // For now, just basic functionality
        });

        // ===== CRAFTING PROFITABILITY CALCULATOR =====

        let craftingMethodsList = [];

        const craftingForm = document.getElementById('craftingForm');
        const addMethodBtn = document.getElementById('addMethodBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const methodsList = document.getElementById('methodsList');
        const craftingLoading = document.getElementById('craftingLoading');
        const craftingError = document.getElementById('craftingError');
        const craftingResults = document.getElementById('craftingResults');

        // Add crafting method button
        addMethodBtn.addEventListener('click', () => {
            showAddMethodDialog();
        });

        // Calculate profitability
        craftingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await calculateProfitability();
        });

        function showAddMethodDialog() {
            const methodType = prompt(
                'Select crafting method:\n\n' +
                '1. Alt Spam\n' +
                '2. Essence Spam\n' +
                '3. Fossil Crafting\n' +
                '4. Chaos Spam\n' +
                '5. Recombinator\n' +
                '6. Harvest Reforge\n\n' +
                'Enter number (1-6):'
            );

            if (!methodType || methodType < 1 || methodType > 6) {
                return;
            }

            const attempts = parseInt(prompt('Average attempts needed:', '10'));
            if (!attempts || attempts < 1) {
                return;
            }

            let method = null;

            switch(methodType) {
                case '1':
                    method = {
                        type: 'alt_spam',
                        name: 'Alteration Spam',
                        attempts,
                        materials: [
                            { name: 'Orb of Alteration', quantity: 1 },
                            { name: 'Orb of Augmentation', quantity: 0.5 }
                        ]
                    };
                    break;
                case '2':
                    const essenceName = prompt('Essence name:', 'Deafening Essence of Greed');
                    method = {
                        type: 'essence',
                        name: 'Essence Spam',
                        attempts,
                        materials: [{ name: essenceName, quantity: 1 }]
                    };
                    break;
                case '3':
                    const fossilNames = prompt('Fossil names (comma-separated):', 'Pristine Fossil, Serrated Fossil');
                    const resonator = prompt('Resonator name:', 'Primitive Chaotic Resonator');
                    const fossils = fossilNames.split(',').map(f => ({ name: f.trim(), quantity: 1 }));
                    method = {
                        type: 'fossil',
                        name: 'Fossil Crafting',
                        attempts,
                        materials: [...fossils, { name: resonator, quantity: 1 }]
                    };
                    break;
                case '4':
                    method = {
                        type: 'chaos_spam',
                        name: 'Chaos Spam',
                        attempts,
                        materials: [{ name: 'Chaos Orb', quantity: 1 }]
                    };
                    break;
                case '5':
                    method = {
                        type: 'recombinator',
                        name: 'Recombinator',
                        attempts: 1,
                        materials: [
                            { name: 'Orb of Scouring', quantity: 2 },
                            { name: 'Orb of Alchemy', quantity: 2 }
                        ]
                    };
                    break;
                case '6':
                    const lifeforce = prompt('Lifeforce type:', 'Sacred Crystallised Lifeforce');
                    const lifeforceAmount = parseInt(prompt('Lifeforce per attempt:', '100'));
                    method = {
                        type: 'harvest',
                        name: 'Harvest Reforge',
                        attempts,
                        materials: [{ name: lifeforce, quantity: lifeforceAmount }]
                    };
                    break;
            }

            if (method) {
                craftingMethodsList.push(method);
                displayCraftingMethods();
            }
        }

        function displayCraftingMethods() {
            if (craftingMethodsList.length === 0) {
                methodsList.innerHTML = '<p style="color: #ccc; font-style: italic;">No methods added yet</p>';
                return;
            }

            methodsList.innerHTML = craftingMethodsList.map((method, index) => `
                <div class="favorite-item" style="margin-bottom: 10px;">
                    <div class="favorite-info">
                        <div class="favorite-name">${escapeHtml(method.name)}</div>
                        <div class="favorite-meta">
                            Attempts: ${method.attempts} |
                            Materials: ${method.materials.map(m => `${m.quantity}x ${m.name}`).join(', ')}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="btn-small btn-danger" onclick="removeCraftingMethod(${index})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        window.removeCraftingMethod = function(index) {
            craftingMethodsList.splice(index, 1);
            displayCraftingMethods();
        };

        async function calculateProfitability() {
            const targetItem = document.getElementById('targetItem').value.trim();
            const baseItem = document.getElementById('baseItem').value.trim();
            const league = document.getElementById('craftLeague').value;

            if (!targetItem || !baseItem) {
                showCraftingError('Please fill in all required fields');
                return;
            }

            if (craftingMethodsList.length === 0) {
                showCraftingError('Please add at least one crafting method');
                return;
            }

            try {
                craftingLoading.style.display = 'block';
                craftingError.style.display = 'none';
                craftingResults.style.display = 'none';
                calculateBtn.disabled = true;
                calculateBtn.textContent = 'Calculating...';

                const result = await ipcRenderer.invoke('calculate-crafting', {
                    targetItem,
                    baseItem,
                    league,
                    methods: craftingMethodsList
                });

                if (!result.success) {
                    throw new Error(result.error);
                }

                displayCraftingResults(result.data);
            } catch (err) {
                showCraftingError(`Calculation failed: ${err.message}`);
            } finally {
                craftingLoading.style.display = 'none';
                calculateBtn.disabled = false;
                calculateBtn.textContent = 'Calculate Profitability';
            }
        }

        function displayCraftingResults(analysis) {
            const {
                targetItem,
                marketPrice,
                bestCraftingMethod,
                allMethods,
                profit,
                profitPercentage,
                isProfitable,
                recommendation
            } = analysis;

            // Update stats
            document.getElementById('craftMarketPrice').textContent = `${marketPrice.toFixed(2)}c`;
            document.getElementById('craftBestCost').textContent = `${bestCraftingMethod.totalCost.toFixed(2)}c`;

            const profitEl = document.getElementById('craftProfit');
            profitEl.textContent = `${profit.toFixed(2)}c (${profitPercentage.toFixed(1)}%)`;
            profitEl.style.color = isProfitable ? '#90EE90' : '#ff6666';

            const recommendationEl = document.getElementById('craftRecommendation');
            recommendationEl.textContent = recommendation.toUpperCase();
            recommendationEl.style.color = recommendation === 'craft' ? '#90EE90' : '#ffaa00';

            // Populate methods table
            const tableBody = document.getElementById('craftingMethodsTable');
            tableBody.innerHTML = allMethods.map(method => {
                const materials = method.breakdown.materialCosts
                    .map(m => `${m.quantity.toFixed(0)}x ${m.material} (${m.totalCost.toFixed(2)}c)`)
                    .join(', ');

                const isBest = method.methodName === bestCraftingMethod.methodName;
                const rowStyle = isBest ? 'background: rgba(144, 238, 144, 0.1); border-left: 3px solid #90EE90;' : '';

                return `
                    <tr style="${rowStyle}">
                        <td>${escapeHtml(method.methodName)}${isBest ? ' ‚≠ê' : ''}</td>
                        <td class="price">${method.totalCost.toFixed(2)}</td>
                        <td>${method.expectedAttempts || 1}</td>
                        <td style="font-size: 0.9em;">${materials}</td>
                    </tr>
                `;
            }).join('');

            craftingResults.style.display = 'block';
        }

        function showCraftingError(message) {
            craftingError.textContent = message;
            craftingError.style.display = 'block';
        }

        // Initialize crafting methods display
        displayCraftingMethods();

        // ===== ADVANCED CRAFTING CHAIN BUILDER =====

        const buildChainBtn = document.getElementById('buildChainBtn');
        const showTacticsBtn = document.getElementById('showTacticsBtn');
        const showEducationBtn = document.getElementById('showEducationBtn');
        const closeTacticsBtn = document.getElementById('closeTacticsBtn');
        const closeEducationBtn = document.getElementById('closeEducationBtn');

        const craftingChainResults = document.getElementById('craftingChainResults');
        const chainStepsList = document.getElementById('chainStepsList');
        const educationalNotes = document.getElementById('educationalNotes');
        const tacticsModal = document.getElementById('tacticsModal');
        const educationModal = document.getElementById('educationModal');

        // Build crafting chain
        buildChainBtn.addEventListener('click', async () => {
            const baseItem = document.getElementById('chainBaseItem').value.trim();
            const ilvl = parseInt(document.getElementById('chainIlvl').value);
            const strategy = document.getElementById('chainStrategy').value;
            const league = document.getElementById('chainLeague').value;

            if (!baseItem) {
                alert('Please enter a base item name');
                return;
            }

            try {
                buildChainBtn.disabled = true;
                buildChainBtn.textContent = 'Building chain...';

                const result = await ipcRenderer.invoke('build-crafting-chain', {
                    baseItem,
                    ilvl,
                    strategy,
                    league
                });

                if (!result.success) {
                    throw new Error(result.error);
                }

                displayCraftingChain(result.data);
            } catch (err) {
                alert(`Failed to build chain: ${err.message}`);
            } finally {
                buildChainBtn.disabled = false;
                buildChainBtn.textContent = 'Build Crafting Chain';
            }
        });

        // Show advanced tactics
        showTacticsBtn.addEventListener('click', async () => {
            try {
                const result = await ipcRenderer.invoke('get-advanced-tactics');
                if (result.success) {
                    displayAdvancedTactics(result.data);
                    tacticsModal.style.display = 'block';
                }
            } catch (err) {
                alert(`Failed to load tactics: ${err.message}`);
            }
        });

        // Show education guide
        showEducationBtn.addEventListener('click', async () => {
            try {
                const result = await ipcRenderer.invoke('get-crafting-education');
                if (result.success) {
                    displayEducationContent(result.data);
                    educationModal.style.display = 'block';
                }
            } catch (err) {
                alert(`Failed to load guide: ${err.message}`);
            }
        });

        // Close modals
        closeTacticsBtn.addEventListener('click', () => {
            tacticsModal.style.display = 'none';
        });

        closeEducationBtn.addEventListener('click', () => {
            educationModal.style.display = 'none';
        });

        function displayCraftingChain(chain) {
            // Display steps
            chainStepsList.innerHTML = chain.steps.map(step => `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 5px; border-left: 3px solid #ffd700;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="color: #ffd700; margin: 0;">
                            Step ${step.stepNumber}: ${step.method.replace(/_/g, ' ').toUpperCase()}
                        </h4>
                        <span style="background: rgba(255,215,0,0.2); padding: 3px 8px; border-radius: 3px; font-size: 0.8em; color: #ffd700;">
                            ${step.expectedAttempts} attempts
                        </span>
                    </div>

                    <p style="color: #fff; margin-bottom: 10px;">${step.explanation}</p>

                    <div style="color: #ccc; font-size: 0.9em; margin-bottom: 10px;">
                        <strong>Materials:</strong> ${step.materials.map(m =>
                            `${m.quantity}x ${m.name}`
                        ).join(', ')}
                    </div>

                    ${step.tips && step.tips.length > 0 ? `
                        <details style="margin-top: 10px;">
                            <summary style="color: #90EE90; cursor: pointer; font-size: 0.9em;">üí° Tips & Tricks</summary>
                            <ul style="margin-top: 8px; padding-left: 20px; color: #ccc; font-size: 0.85em;">
                                ${step.tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </details>
                    ` : ''}
                </div>
            `).join('');

            // Display educational notes
            educationalNotes.innerHTML = chain.educationalNotes.map(note =>
                `<p style="color: #fff; margin-bottom: 8px;">‚Ä¢ ${note}</p>`
            ).join('');

            // Display stats
            document.getElementById('chainTotalCost').textContent = `${chain.totalCost.toFixed(0)}c`;
            document.getElementById('chainSuccessRate').textContent = `${(chain.totalSuccessRate * 100).toFixed(1)}%`;

            const difficultyEl = document.getElementById('chainDifficulty');
            difficultyEl.textContent = chain.difficulty.toUpperCase();
            difficultyEl.style.color = getDifficultyColor(chain.difficulty);

            craftingChainResults.style.display = 'block';
        }

        function displayAdvancedTactics(tactics) {
            const tacticsList = document.getElementById('tacticsList');
            tacticsList.innerHTML = tactics.map(tactic => `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #ffd700; margin: 0;">${tactic.name}</h4>
                        <span style="background: ${getDifficultyBg(tactic.difficulty)}; padding: 3px 10px; border-radius: 3px; font-size: 0.8em; color: #fff;">
                            ${tactic.difficulty}
                        </span>
                    </div>

                    <p style="color: #ccc; margin-bottom: 10px;">${tactic.description}</p>

                    <p style="color: #90EE90; font-size: 0.9em; margin-bottom: 10px;">
                        <strong>When to use:</strong> ${tactic.whenToUse}
                    </p>

                    <details>
                        <summary style="color: #ffd700; cursor: pointer; margin-bottom: 5px;">üìù Steps</summary>
                        <ol style="margin-top: 8px; padding-left: 20px; color: #ccc; font-size: 0.9em;">
                            ${tactic.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </details>

                    <details style="margin-top: 10px;">
                        <summary style="color: #ffd700; cursor: pointer;">üí∞ Estimated Cost</summary>
                        <p style="color: #ccc; font-size: 0.9em; margin-top: 5px;">
                            Min: ${tactic.estimatedCost.min}c | Avg: ${tactic.estimatedCost.average}c | Max: ${tactic.estimatedCost.max}c
                        </p>
                    </details>

                    ${tactic.examples && tactic.examples.length > 0 ? `
                        <details style="margin-top: 10px;">
                            <summary style="color: #ffd700; cursor: pointer;">üìö Examples</summary>
                            <ul style="margin-top: 8px; padding-left: 20px; color: #ccc; font-size: 0.85em;">
                                ${tactic.examples.map(ex => `<li>${ex}</li>`).join('')}
                            </ul>
                        </details>
                    ` : ''}
                </div>
            `).join('');
        }

        function displayEducationContent(concepts) {
            const educationContent = document.getElementById('educationContent');
            educationContent.innerHTML = concepts.map(concept => `
                <div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 5px; border-left: 3px solid ${getDifficultyColor(concept.difficulty)};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #ffd700; margin: 0;">${concept.concept}</h4>
                        <span style="background: ${getDifficultyBg(concept.difficulty)}; padding: 3px 10px; border-radius: 3px; font-size: 0.8em; color: #fff;">
                            ${concept.difficulty}
                        </span>
                    </div>

                    <p style="color: #fff; margin-bottom: 15px; line-height: 1.6;">${concept.explanation}</p>

                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                        <p style="color: #90EE90; font-weight: bold; margin-bottom: 8px;">Examples:</p>
                        <ul style="padding-left: 20px; color: #ccc; font-size: 0.9em; line-height: 1.5;">
                            ${concept.examples.map(ex => `<li>${ex}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                beginner: '#90EE90',
                intermediate: '#ffd700',
                advanced: '#ff9500',
                expert: '#ff4444'
            };
            return colors[difficulty] || '#ccc';
        }

        function getDifficultyBg(difficulty) {
            const colors = {
                beginner: 'rgba(144, 238, 144, 0.3)',
                intermediate: 'rgba(255, 215, 0, 0.3)',
                advanced: 'rgba(255, 149, 0, 0.3)',
                expert: 'rgba(255, 68, 68, 0.3)'
            };
            return colors[difficulty] || 'rgba(255,255,255,0.1)';
        }
    </script>
</body>
</html>
