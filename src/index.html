<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path of Exile Market Helper</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #ffd700;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: #cccccc;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 5px 5px 0 0;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: bold;
        }

        .tab:hover {
            background: rgba(255,255,255,0.15);
            color: #ffd700;
        }

        .tab.active {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            border-bottom: 3px solid #ffd700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.9em;
        }

        input[type="text"], select {
            padding: 12px;
            border: 2px solid #444;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            font-size: 16px;
            min-width: 200px;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .error {
            background: rgba(255,0,0,0.2);
            color: #ffcccc;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff0000;
        }

        .results-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-title {
            color: #ffd700;
            font-size: 1.5em;
        }

        .results-meta {
            color: #cccccc;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9em;
            color: #cccccc;
            margin-top: 5px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .results-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .results-table tr:hover {
            background: rgba(255,255,255,0.1);
        }

        .price {
            font-weight: bold;
            color: #90EE90;
        }

        .no-results {
            text-align: center;
            color: #cccccc;
            font-style: italic;
            padding: 40px;
        }

        .favorites-section {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .favorites-header {
            color: #ffd700;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .favorite-info {
            flex-grow: 1;
        }

        .favorite-name {
            font-weight: bold;
            color: #ffffff;
        }

        .favorite-meta {
            font-size: 0.8em;
            color: #cccccc;
        }

        .favorite-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4444ff, #0000cc);
            color: white;
        }

        /* Crafting UI Styles */
        .crafting-input-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .mod-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .mod-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
        }

        .crafting-results {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .method-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .method-card.recommended {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .method-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .method-cost {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ade80;
        }

        .method-description {
            color: #cccccc;
            margin-bottom: 15px;
        }

        .method-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .method-stat {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .method-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .method-stat-label {
            font-size: 0.85em;
            color: #999;
        }

        .crafting-steps {
            list-style: none;
            padding: 0;
        }

        .crafting-steps li {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .recommended-badge {
            background: #ffd700;
            color: #1a1a2e;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .base-recommendation {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .base-rec-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            input[type="text"], select {
                min-width: unset;
                width: 100%;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-table {
                font-size: 0.9em;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }

            .mod-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Path of Exile Market Helper</h1>
            <p class="subtitle">Live market data & crafting predictions</p>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="market">Market Search</button>
            <button class="tab" data-tab="crafting">Crafting Prediction</button>
        </div>

        <div id="marketTab" class="tab-content active">
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="itemName">Item Name:</label>
                    <input type="text" id="itemName" placeholder="e.g., Tabula Rasa, Divine Orb, Shaper's Touch" required>
                </div>
                
                <div class="form-group">
                    <label for="league">League:</label>
                    <select id="league">
                        <option value="Crucible">Crucible</option>
                        <option value="Hardcore Crucible">Hardcore Crucible</option>
                        <option value="Standard">Standard</option>
                        <option value="Hardcore">Hardcore</option>
                    </select>
                </div>
                
                <button type="submit" id="searchBtn">Search</button>
                <button type="button" id="favoriteBtn" style="display: none;">Add to Favorites</button>
            </form>
        </section>

        <div id="loading" class="loading" style="display: none;">
            üîç Searching poe.ninja...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Search Results</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="minPrice">-</div>
                    <div class="stat-label">Min Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="medianPrice">-</div>
                    <div class="stat-label">Median Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxPrice">-</div>
                    <div class="stat-label">Max Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalListings">-</div>
                    <div class="stat-label">Total Listings</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Base Type</th>
                            <th>Chaos Value</th>
                            <th>Listings</th>
                            <th>Links</th>
                            <th>Variant</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                No items found matching your search.
            </div>
        </section>

        <section class="favorites-section">
            <div class="favorites-header">
                <span>Favorites</span>
                <button type="button" id="refreshFavoritesBtn" class="btn-small">Refresh All</button>
            </div>
            <div id="favoritesList"></div>
            <div id="noFavorites" class="no-results" style="display: none;">
                No favorites added yet. Search for items and add them to your favorites!
            </div>
        </section>
        </div> <!-- End Market Tab -->

        <div id="craftingTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Crafting Prediction Calculator</h2>

            <form id="craftingForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftBaseItem">Base Item:</label>
                    <input type="text" id="craftBaseItem" placeholder="e.g., Vaal Regalia, Siege Axe, Steel Ring" required>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftItemClass">Item Class:</label>
                    <select id="craftItemClass" required>
                        <option value="">Select Item Class</option>
                        <option value="Body Armour">Body Armour</option>
                        <option value="Helmet">Helmet</option>
                        <option value="Gloves">Gloves</option>
                        <option value="Boots">Boots</option>
                        <option value="Shield">Shield</option>
                        <option value="One Hand Sword">One Hand Sword</option>
                        <option value="Two Hand Sword">Two Hand Sword</option>
                        <option value="One Hand Axe">One Hand Axe</option>
                        <option value="Two Hand Axe">Two Hand Axe</option>
                        <option value="One Hand Mace">One Hand Mace</option>
                        <option value="Two Hand Mace">Two Hand Mace</option>
                        <option value="Bow">Bow</option>
                        <option value="Wand">Wand</option>
                        <option value="Dagger">Dagger</option>
                        <option value="Claw">Claw</option>
                        <option value="Sceptre">Sceptre</option>
                        <option value="Staff">Staff</option>
                        <option value="Ring">Ring</option>
                        <option value="Amulet">Amulet</option>
                        <option value="Belt">Belt</option>
                        <option value="Quiver">Quiver</option>
                        <option value="Jewel">Jewel</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftLeague">League:</label>
                    <select id="craftLeague">
                        <option value="Crucible">Crucible</option>
                        <option value="Hardcore Crucible">Hardcore Crucible</option>
                        <option value="Standard">Standard</option>
                        <option value="Hardcore">Hardcore</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Desired Mods:</label>
                    <div id="modsList"></div>
                    <button type="button" id="addModBtn" class="btn-success" style="margin-top: 10px;">+ Add Mod</button>
                </div>

                <button type="submit" id="calculateBtn">Calculate Best Crafting Method</button>
            </form>
        </section>

        <div id="craftingLoading" class="loading" style="display: none;">
            üîÆ Calculating crafting methods...
        </div>

        <div id="craftingError" class="error" style="display: none;"></div>

        <section id="craftingResults" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Crafting Recommendations</h2>
            <div id="craftingResultsContent"></div>
        </section>
        </div> <!-- End Crafting Tab -->

    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const itemNameInput = document.getElementById('itemName');
        const leagueSelect = document.getElementById('league');
        const searchBtn = document.getElementById('searchBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsMeta = document.getElementById('resultsMeta');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResults = document.getElementById('noResults');
        const favoritesList = document.getElementById('favoritesList');
        const noFavorites = document.getElementById('noFavorites');
        const refreshFavoritesBtn = document.getElementById('refreshFavoritesBtn');

        // State
        let currentSearchResult = null;
        let favorites = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
        });

        // Search form handler
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemName = itemNameInput.value.trim();
            const league = leagueSelect.value;
            
            if (!itemName) {
                showError('Please enter an item name');
                return;
            }

            await searchItem(itemName, league);
        });

        // Add to favorites handler
        favoriteBtn.addEventListener('click', async () => {
            if (!currentSearchResult) return;

            try {
                const itemName = itemNameInput.value.trim();
                const league = leagueSelect.value;
                
                await ipcRenderer.invoke('add-favorite', {
                    name: itemName,
                    league: league
                });

                showSuccess('Added to favorites!');
                favoriteBtn.style.display = 'none';
                await loadFavorites();
            } catch (err) {
                showError(`Failed to add to favorites: ${err.message}`);
            }
        });

        // Refresh favorites handler
        refreshFavoritesBtn.addEventListener('click', async () => {
            refreshFavoritesBtn.disabled = true;
            refreshFavoritesBtn.textContent = 'Refreshing...';
            
            try {
                for (const favorite of favorites) {
                    await searchItem(favorite.name, favorite.league, false);
                }
                showSuccess('All favorites refreshed!');
            } catch (err) {
                showError(`Failed to refresh favorites: ${err.message}`);
            } finally {
                refreshFavoritesBtn.disabled = false;
                refreshFavoritesBtn.textContent = 'Refresh All';
            }
        });

        async function searchItem(itemName, league, showUI = true) {
            try {
                if (showUI) {
                    showLoading();
                    hideError();
                    hideResults();
                }

                searchBtn.disabled = true;
                searchBtn.textContent = 'Searching...';

                const result = await ipcRenderer.invoke('search-item', itemName, league);
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                currentSearchResult = result.data;
                
                if (showUI) {
                    displayResults(result.data);
                    updateFavoriteButton(itemName, league);
                }
            } catch (err) {
                if (showUI) {
                    showError(`Search failed: ${err.message}`);
                }
                console.error('Search error:', err);
            } finally {
                if (showUI) {
                    hideLoading();
                }
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function displayResults(searchResult) {
            const { itemName, league, results, timestamp, minPrice, maxPrice, medianPrice, totalListings } = searchResult;
            
            resultsTitle.textContent = `Results for "${itemName}"`;
            resultsMeta.textContent = `League: ${league} | Updated: ${new Date(timestamp).toLocaleString()}`;
            
            // Update stats
            document.getElementById('minPrice').textContent = minPrice.toFixed(2);
            document.getElementById('medianPrice').textContent = medianPrice.toFixed(2);
            document.getElementById('maxPrice').textContent = maxPrice.toFixed(2);
            document.getElementById('totalListings').textContent = totalListings;
            
            // Clear previous results
            resultsTableBody.innerHTML = '';
            
            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsSection.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            // Populate table
            results.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.baseType || '-')}</td>
                    <td class="price">${item.chaosValue.toFixed(2)}</td>
                    <td>${item.listingCount || item.count || '-'}</td>
                    <td>${item.links || '-'}</td>
                    <td>${escapeHtml(item.variant || '-')}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            
            resultsSection.style.display = 'block';
        }

        async function loadFavorites() {
            try {
                const result = await ipcRenderer.invoke('get-favorites');
                if (result.success) {
                    favorites = result.data;
                    displayFavorites();
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        function displayFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavorites.style.display = 'block';
                return;
            }
            
            noFavorites.style.display = 'none';
            
            favorites.forEach(favorite => {
                const favoriteDiv = document.createElement('div');
                favoriteDiv.className = 'favorite-item';
                
                favoriteDiv.innerHTML = `
                    <div class="favorite-info">
                        <div class="favorite-name">${escapeHtml(favorite.name)}</div>
                        <div class="favorite-meta">
                            League: ${escapeHtml(favorite.league)} | 
                            Added: ${new Date(favorite.addedAt).toLocaleDateString()}
                            ${favorite.lastPrice ? ` | Last Price: ${favorite.lastPrice.toFixed(2)} chaos` : ''}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="btn-small btn-info" onclick="searchFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Search
                        </button>
                        <button class="btn-small btn-danger" onclick="removeFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Remove
                        </button>
                    </div>
                `;
                
                favoritesList.appendChild(favoriteDiv);
            });
        }

        async function searchFavorite(name, league) {
            itemNameInput.value = name;
            leagueSelect.value = league;
            await searchItem(name, league);
        }

        async function removeFavorite(name, league) {
            try {
                await ipcRenderer.invoke('remove-favorite', name);
                showSuccess('Removed from favorites!');
                await loadFavorites();
                updateFavoriteButton(itemNameInput.value.trim(), leagueSelect.value);
            } catch (err) {
                showError(`Failed to remove favorite: ${err.message}`);
            }
        }

        function updateFavoriteButton(itemName, league) {
            const isFavorite = favorites.some(fav => 
                fav.name.toLowerCase() === itemName.toLowerCase() && 
                fav.league === league
            );
            
            favoriteBtn.style.display = currentSearchResult && !isFavorite ? 'inline-block' : 'none';
        }

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'error'; // Reuse error styling but green
            successDiv.style.background = 'rgba(0,255,0,0.2)';
            successDiv.style.color = '#ccffcc';
            successDiv.style.borderColor = '#00ff00';
            successDiv.textContent = message;
            
            error.parentNode.insertBefore(successDiv, error.nextSibling);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-complete functionality (simple implementation)
        const commonItems = [
            'Tabula Rasa', 'Divine Orb', 'Chaos Orb', 'Exalted Orb', 'Ancient Orb',
            'Shaper\'s Touch', 'Goldrim', 'Wanderlust', 'Meginord\'s Girdle',
            'The Baron', 'Belly of the Beast', 'Shavronne\'s Wrappings',
            'Atziri\'s Promise', 'Taste of Hate', 'Dying Sun', 'The Wise Oak'
        ];

        itemNameInput.addEventListener('input', (e) => {
            // Simple auto-suggest could be added here
            // For now, just basic functionality
        });

        // ===== TAB SWITCHING =====
        const tabs = document.querySelectorAll('.tab');
        const marketTab = document.getElementById('marketTab');
        const craftingTab = document.getElementById('craftingTab');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Hide all tab contents
                marketTab.classList.remove('active');
                craftingTab.classList.remove('active');

                // Show selected tab
                if (tabName === 'market') {
                    marketTab.classList.add('active');
                } else if (tabName === 'crafting') {
                    craftingTab.classList.add('active');
                    initializeCrafting();
                }
            });
        });

        // ===== CRAFTING FUNCTIONALITY =====
        let craftingInitialized = false;
        let desiredMods = [];
        let modCounter = 0;

        const craftingForm = document.getElementById('craftingForm');
        const modsList = document.getElementById('modsList');
        const addModBtn = document.getElementById('addModBtn');
        const craftingLoading = document.getElementById('craftingLoading');
        const craftingError = document.getElementById('craftingError');
        const craftingResults = document.getElementById('craftingResults');
        const craftingResultsContent = document.getElementById('craftingResultsContent');

        async function initializeCrafting() {
            if (craftingInitialized) return;

            try {
                const league = document.getElementById('craftLeague').value;
                const result = await ipcRenderer.invoke('initialize-crafting', league);
                if (result.success) {
                    console.log('Crafting data initialized');
                    craftingInitialized = true;
                } else {
                    showCraftingError('Failed to initialize crafting data: ' + result.error);
                }
            } catch (err) {
                console.error('Crafting initialization error:', err);
            }
        }

        function addModInput() {
            const modId = modCounter++;
            const modDiv = document.createElement('div');
            modDiv.className = 'mod-input-group';
            modDiv.setAttribute('data-mod-id', modId);
            modDiv.innerHTML = `
                <div class="mod-inputs">
                    <div class="form-group">
                        <label>Mod Name:</label>
                        <input type="text" class="mod-name" placeholder="e.g., increased Energy Shield, Life" required>
                    </div>
                    <div class="form-group">
                        <label>Type:</label>
                        <select class="mod-type" required>
                            <option value="prefix">Prefix</option>
                            <option value="suffix">Suffix</option>
                        </select>
                    </div>
                    <button type="button" class="btn-danger btn-small" onclick="removeMod(${modId})">Remove</button>
                </div>
            `;
            modsList.appendChild(modDiv);
        }

        window.removeMod = function(modId) {
            const modDiv = document.querySelector(`[data-mod-id="${modId}"]`);
            if (modDiv) {
                modDiv.remove();
            }
        };

        addModBtn.addEventListener('click', addModInput);

        // Add initial mod input
        addModInput();

        craftingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const baseItem = document.getElementById('craftBaseItem').value;
            const itemClass = document.getElementById('craftItemClass').value;
            const league = document.getElementById('craftLeague').value;

            // Collect mods
            const modInputs = document.querySelectorAll('.mod-input-group');
            const desiredMods = [];

            modInputs.forEach(modDiv => {
                const name = modDiv.querySelector('.mod-name').value;
                const type = modDiv.querySelector('.mod-type').value;
                if (name) {
                    desiredMods.push({ name, type });
                }
            });

            if (desiredMods.length === 0) {
                showCraftingError('Please add at least one desired mod');
                return;
            }

            // Show loading
            craftingLoading.style.display = 'block';
            craftingError.style.display = 'none';
            craftingResults.style.display = 'none';

            try {
                const result = await ipcRenderer.invoke('calculate-crafting', {
                    desiredMods,
                    baseItemName: baseItem,
                    itemClass,
                    league
                });

                craftingLoading.style.display = 'none';

                if (result.success) {
                    displayCraftingResults(result.data);
                } else {
                    showCraftingError(result.error);
                }
            } catch (err) {
                craftingLoading.style.display = 'none';
                showCraftingError('Calculation failed: ' + err.message);
            }
        });

        function displayCraftingResults(data) {
            craftingResults.style.display = 'block';

            let html = '';

            // Base recommendation
            if (data.baseRecommendation) {
                const base = data.baseRecommendation;
                html += `
                    <div class="base-recommendation">
                        <div class="base-rec-title">üíé Recommended Base</div>
                        <p><strong>Type:</strong> ${base.baseType.toUpperCase()}</p>
                        <p><strong>Item:</strong> ${base.itemName}</p>
                        <p><strong>Cost:</strong> ${formatPrice(base.averageCost, data.preferredCurrency)}</p>
                        <p><strong>Reason:</strong> ${base.reason}</p>
                    </div>
                `;
            }

            // Total cost summary
            html += `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${formatPrice(data.totalCostChaos, data.preferredCurrency)}</div>
                        <div class="stat-label">Total Estimated Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.methods.length}</div>
                        <div class="stat-label">Methods Available</div>
                    </div>
                </div>
            `;

            // Methods
            data.methods.forEach((method, index) => {
                const isRecommended = index === 0;
                html += `
                    <div class="method-card ${isRecommended ? 'recommended' : ''}">
                        <div class="method-header">
                            <div>
                                <span class="method-name">${method.name}</span>
                                ${isRecommended ? '<span class="recommended-badge">‚≠ê RECOMMENDED</span>' : ''}
                            </div>
                            <div class="method-cost">${formatPrice(method.averageCost, data.preferredCurrency)}</div>
                        </div>
                        <div class="method-description">${method.description}</div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${(method.probability * 100).toFixed(2)}%</div>
                                <div class="method-stat-label">Success Rate</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${method.expectedAttempts}</div>
                                <div class="method-stat-label">Avg. Attempts</div>
                            </div>
                        </div>
                        <div>
                            <strong style="color: #ffd700;">Currency Needed:</strong>
                            <ul class="crafting-steps" style="margin-top: 10px;">
                                ${Object.entries(method.currencyUsed).map(([currency, amount]) =>
                                    `<li>${Math.ceil(amount)}x ${currency}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong style="color: #ffd700;">Steps:</strong>
                            <ol class="crafting-steps" style="margin-top: 10px;">
                                ${method.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            });

            craftingResultsContent.innerHTML = html;
        }

        function formatPrice(chaosValue, preferredCurrency = 'chaos') {
            const divinePrice = 200; // This should be fetched from poe.ninja

            if (preferredCurrency === 'divine' || chaosValue >= divinePrice * 2) {
                const divineValue = chaosValue / divinePrice;
                return `${divineValue.toFixed(2)} Divine`;
            }

            return `${chaosValue.toFixed(1)} Chaos`;
        }

        function showCraftingError(message) {
            craftingError.textContent = message;
            craftingError.style.display = 'block';
            setTimeout(() => {
                craftingError.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
