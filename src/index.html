<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path of Exile Market Helper</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #ffd700;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: #cccccc;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 5px 5px 0 0;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: bold;
        }

        .tab:hover {
            background: rgba(255,255,255,0.15);
            color: #ffd700;
        }

        .tab.active {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            border-bottom: 3px solid #ffd700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.9em;
        }

        input[type="text"], select {
            padding: 12px;
            border: 2px solid #444;
            border-radius: 5px;
            background: rgba(30, 30, 40, 0.95);
            color: #ffffff;
            font-size: 16px;
            min-width: 200px;
        }

        /* Dark mode dropdown options */
        select option {
            background: #1a1a2e;
            color: #ffffff;
            padding: 10px;
        }

        select option:hover,
        select option:focus,
        select option:checked {
            background: #2a2a3e;
            color: #ffd700;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .error {
            background: rgba(255,0,0,0.2);
            color: #ffcccc;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff0000;
        }

        .results-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-title {
            color: #ffd700;
            font-size: 1.5em;
        }

        .results-meta {
            color: #cccccc;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9em;
            color: #cccccc;
            margin-top: 5px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .results-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .results-table tr:hover {
            background: rgba(255,255,255,0.1);
        }

        .price {
            font-weight: bold;
            color: #90EE90;
        }

        .no-results {
            text-align: center;
            color: #cccccc;
            font-style: italic;
            padding: 40px;
        }

        .favorites-section {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .favorites-header {
            color: #ffd700;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .favorite-info {
            flex-grow: 1;
        }

        .favorite-name {
            font-weight: bold;
            color: #ffffff;
        }

        .favorite-meta {
            font-size: 0.8em;
            color: #cccccc;
        }

        .favorite-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4444ff, #0000cc);
            color: white;
        }

        /* Crafting UI Styles */
        .crafting-input-section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .mod-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .mod-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
        }

        .crafting-results {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .method-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .method-card.recommended {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .method-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .method-cost {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ade80;
        }

        .method-description {
            color: #cccccc;
            margin-bottom: 15px;
        }

        .method-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .method-stat {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .method-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .method-stat-label {
            font-size: 0.85em;
            color: #999;
        }

        .crafting-steps {
            list-style: none;
            padding: 0;
        }

        .crafting-steps li {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .recommended-badge {
            background: #ffd700;
            color: #1a1a2e;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .base-recommendation {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .base-rec-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            input[type="text"], select {
                min-width: unset;
                width: 100%;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-table {
                font-size: 0.9em;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }

            .mod-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Path of Exile Market Helper</h1>
            <p class="subtitle">Live market data & crafting helper</p>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="market">Market Search</button>
            <button class="tab" data-tab="insights">Market Insights</button>
            <button class="tab" data-tab="crafting">Crafting Helper</button>
            <button class="tab" data-tab="guide">Learn to Craft</button>
        </div>

        <div id="marketTab" class="tab-content active">
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="itemName">Item Name:</label>
                    <input type="text" id="itemName" placeholder="e.g., Tabula Rasa, Divine Orb, Shaper's Touch" required>
                </div>
                
                <div class="form-group">
                    <label for="league">League:</label>
                    <select id="league">
                        <option value="">Loading leagues...</option>
                    </select>
                </div>
                
                <button type="submit" id="searchBtn">Search</button>
                <button type="button" id="favoriteBtn" style="display: none;">Add to Favorites</button>
            </form>
        </section>

        <div id="loading" class="loading" style="display: none;">
            üîç Searching poe.ninja...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Search Results</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="minPrice">-</div>
                    <div class="stat-label">Min Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="medianPrice">-</div>
                    <div class="stat-label">Median Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxPrice">-</div>
                    <div class="stat-label">Max Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalListings">-</div>
                    <div class="stat-label">Total Listings</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Base Type</th>
                            <th>Chaos Value</th>
                            <th>Listings</th>
                            <th>Links</th>
                            <th>Variant</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                No items found matching your search.
            </div>
        </section>

        <section class="favorites-section">
            <div class="favorites-header">
                <span>Favorites</span>
                <button type="button" id="refreshFavoritesBtn" class="btn-small">Refresh All</button>
            </div>
            <div id="favoritesList"></div>
            <div id="noFavorites" class="no-results" style="display: none;">
                No favorites added yet. Search for items and add them to your favorites!
            </div>
        </section>
        </div> <!-- End Market Tab -->

        <div id="insightsTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üìä Market Insights & Profit Opportunities</h2>

            <div class="form-group" style="margin-bottom: 20px;">
                <label for="insightsLeague">League:</label>
                <select id="insightsLeague">
                    <option value="">Loading leagues...</option>
                </select>
                <button type="button" id="refreshInsightsBtn" style="margin-left: 10px;">Refresh Data</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="stat-card" style="cursor: pointer;" onclick="showSection('popular')">
                    <div class="stat-value" id="popularCount">0</div>
                    <div class="stat-label">üî• Popular Items</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showSection('profitable')">
                    <div class="stat-value" id="profitableCount">0</div>
                    <div class="stat-label">üí∞ Profitable Crafts</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showSection('trending')">
                    <div class="stat-value" id="trendingCount">0</div>
                    <div class="stat-label">üìà Trending Items</div>
                </div>
            </div>
        </section>

        <div id="insightsLoading" class="loading" style="display: none;">
            üìä Loading market data...
        </div>

        <div id="insightsError" class="error" style="display: none;"></div>

        <!-- Popular Items Section -->
        <section id="popularSection" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üî• Most Popular Items (High Demand)</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">These items have the highest trading volume and are frequently used in meta builds.</p>
            <div id="popularItemsList"></div>
        </section>

        <!-- Profitable Items Section -->
        <section id="profitableSection" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üí∞ Best Craftable Items for Profit</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">
                <strong>Craftable rare base types</strong> with the best profit margins. These are NOT drop-only uniques like Headhunter or Mageblood - these are items you can actually craft!
            </p>
            <div style="background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <p style="color: #ffd700; margin: 0; font-weight: bold;">‚ÑπÔ∏è How to Use This Data:</p>
                <ul style="color: #cccccc; margin: 10px 0 0 20px;">
                    <li>Check the "Suggested Method" for each item</li>
                    <li>Go to "Crafting Helper" tab to calculate exact costs</li>
                    <li>Compare your craft cost vs the market "Sell Price"</li>
                    <li>Look for High/Medium demand items for faster sales</li>
                </ul>
            </div>
            <div id="profitableItemsList"></div>
        </section>

        <!-- Trending Items Section -->
        <section id="trendingSection" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üìà Trending Items</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">Items currently in high demand based on value and listing activity.</p>
            <div id="trendingItemsList"></div>
        </section>
        </div> <!-- End Insights Tab -->

        <div id="craftingTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Crafting Helper</h2>

            <!-- Item Paste Area -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px dashed #ffd700; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                <label for="itemPaste" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px;">
                    üìã Paste Item from PoE (Ctrl+C in game):
                </label>
                <textarea
                    id="itemPaste"
                    placeholder="Paste your copied item here... (Copy item from PoE with Ctrl+C)"
                    style="width: 100%; min-height: 100px; background: rgba(30, 30, 40, 0.95); color: #ffffff; border: 2px solid #444; border-radius: 5px; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical;"
                ></textarea>
                <p style="color: #888; font-size: 12px; margin-top: 5px;">Item data will auto-fill the fields below</p>
            </div>

            <form id="craftingForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftBaseItem">Base Item:</label>
                    <input type="text" id="craftBaseItem" placeholder="e.g., Vaal Regalia, Siege Axe, Steel Ring" required>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftItemLevel">Item Level (ilvl):</label>
                    <input type="number" id="craftItemLevel" placeholder="e.g., 86" min="1" max="100">
                    <p style="color: #888; font-size: 12px; margin-top: 5px;">Higher ilvl allows better mods (T1 mods usually require ilvl 82-86)</p>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftItemClass">Item Class:</label>
                    <select id="craftItemClass" required>
                        <option value="">Select Item Class</option>
                        <option value="Body Armour">Body Armour</option>
                        <option value="Helmet">Helmet</option>
                        <option value="Gloves">Gloves</option>
                        <option value="Boots">Boots</option>
                        <option value="Shield">Shield</option>
                        <option value="One Hand Sword">One Hand Sword</option>
                        <option value="Two Hand Sword">Two Hand Sword</option>
                        <option value="One Hand Axe">One Hand Axe</option>
                        <option value="Two Hand Axe">Two Hand Axe</option>
                        <option value="One Hand Mace">One Hand Mace</option>
                        <option value="Two Hand Mace">Two Hand Mace</option>
                        <option value="Bow">Bow</option>
                        <option value="Wand">Wand</option>
                        <option value="Dagger">Dagger</option>
                        <option value="Claw">Claw</option>
                        <option value="Sceptre">Sceptre</option>
                        <option value="Staff">Staff</option>
                        <option value="Ring">Ring</option>
                        <option value="Amulet">Amulet</option>
                        <option value="Belt">Belt</option>
                        <option value="Quiver">Quiver</option>
                        <option value="Jewel">Jewel</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftLeague">League:</label>
                    <select id="craftLeague">
                        <option value="">Loading leagues...</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Desired Mods:</label>
                    <div id="modsList"></div>
                    <button type="button" id="addModBtn" class="btn-success" style="margin-top: 10px;">+ Add Mod</button>
                </div>

                <button type="submit" id="calculateBtn">Calculate Best Crafting Method</button>
            </form>
        </section>

        <div id="craftingLoading" class="loading" style="display: none;">
            üîÆ Calculating crafting methods...
        </div>

        <div id="craftingError" class="error" style="display: none;"></div>

        <section id="craftingResults" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Crafting Recommendations</h2>
            <div id="craftingResultsContent"></div>
        </section>
        </div> <!-- End Crafting Tab -->

        <div id="guideTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Learn to Craft This Item</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">Paste an item from Path of Exile to learn how to craft it yourself!</p>

            <!-- Item Paste Area for Guide -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px dashed #ffd700; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                <label for="guidePaste" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px;">
                    üìã Paste Your Target Item (Ctrl+C in game):
                </label>
                <textarea
                    id="guidePaste"
                    placeholder="Paste the item you want to learn how to craft... (Copy from PoE with Ctrl+C)"
                    style="width: 100%; min-height: 150px; background: rgba(30, 30, 40, 0.95); color: #ffffff; border: 2px solid #444; border-radius: 5px; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical;"
                ></textarea>
                <button type="button" id="analyzeItemBtn" style="margin-top: 10px;">Analyze Item & Generate Crafting Guide</button>
            </div>

            <!-- Analysis Results -->
            <div id="guideLoading" class="loading" style="display: none;">
                üîç Analyzing item and generating crafting guide...
            </div>

            <div id="guideError" class="error" style="display: none;"></div>

            <section id="guideResults" style="display: none;">
                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">Item Analysis</h3>
                    <div id="guideItemInfo" style="color: #cccccc;"></div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">üìñ Step-by-Step Crafting Guide</h3>
                    <div id="guideCraftingSteps" style="color: #cccccc;"></div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">üí° Tips & Considerations</h3>
                    <div id="guideTips" style="color: #cccccc;"></div>
                </div>
            </section>
        </section>
        </div> <!-- End Guide Tab -->

    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const itemNameInput = document.getElementById('itemName');
        const leagueSelect = document.getElementById('league');
        const searchBtn = document.getElementById('searchBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsMeta = document.getElementById('resultsMeta');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResults = document.getElementById('noResults');
        const favoritesList = document.getElementById('favoritesList');
        const noFavorites = document.getElementById('noFavorites');
        const refreshFavoritesBtn = document.getElementById('refreshFavoritesBtn');

        // State
        let currentSearchResult = null;
        let favorites = [];

        // Mod Database - Common mods by item class
        const MOD_DATABASE = {
            // Universal mods (work on most items)
            universal: {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1-T5', ilvl: 44 },
                    { name: '+# to maximum Mana', tier: 'T1-T5', ilvl: 2 },
                    { name: '+# to maximum Energy Shield', tier: 'T1-T5', ilvl: 12 },
                    { name: '+# to Strength', tier: 'T1-T5', ilvl: 11 },
                    { name: '+# to Dexterity', tier: 'T1-T5', ilvl: 11 },
                    { name: '+# to Intelligence', tier: 'T1-T5', ilvl: 11 },
                    { name: '+# to all Attributes', tier: 'T1-T3', ilvl: 60 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1-T6', ilvl: 18 },
                    { name: '+#% to Cold Resistance', tier: 'T1-T6', ilvl: 18 },
                    { name: '+#% to Lightning Resistance', tier: 'T1-T6', ilvl: 18 },
                    { name: '+#% to Chaos Resistance', tier: 'T1-T5', ilvl: 16 },
                    { name: '+#% to all Elemental Resistances', tier: 'T1-T3', ilvl: 60 },
                    { name: '#% increased Rarity of Items found', tier: 'T1-T5', ilvl: 20 }
                ]
            },
            'Body Armour': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (100-109)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (175-200)', ilvl: 82 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 },
                    { name: '#% increased Armour', tier: 'T1-T10', ilvl: 11 },
                    { name: '#% increased Evasion Rating', tier: 'T1-T10', ilvl: 11 },
                    { name: '#% increased Energy Shield', tier: 'T1-T10', ilvl: 12 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1-T6', ilvl: 50 },
                    { name: '+# to Level of Socketed Gems', tier: 'T1-T2', ilvl: 50 }
                ],
                suffix: [
                    { name: '+#% to all Elemental Resistances', tier: 'T1 (15-16%)', ilvl: 60 },
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '#% increased Stun and Block Recovery', tier: 'T1-T6', ilvl: 18 }
                ]
            },
            'Helmet': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (90-99)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (110-125)', ilvl: 82 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 },
                    { name: '#% increased Armour', tier: 'T1-T10', ilvl: 11 },
                    { name: 'Nearby Enemies have -#% to Fire Resistance', tier: 'T1-T3', ilvl: 75 },
                    { name: '+# to Level of Socketed Minion Gems', tier: 'T1-T3', ilvl: 50 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to Accuracy Rating', tier: 'T1-T8', ilvl: 20 }
                ]
            },
            'Gloves': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (80-89)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (75-85)', ilvl: 82 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1 (16-19)', ilvl: 74 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to Accuracy Rating', tier: 'T1 (400-450)', ilvl: 74 },
                    { name: '#% increased Attack Speed', tier: 'T1-T6', ilvl: 35 }
                ]
            },
            'Boots': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (80-89)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (60-70)', ilvl: 82 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 },
                    { name: '#% increased Movement Speed', tier: 'T1 (30-35%)', ilvl: 55 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '#% increased Stun and Block Recovery', tier: 'T1-T6', ilvl: 18 }
                ]
            },
            'Ring': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (70-79)', ilvl: 82 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (60-65)', ilvl: 79 },
                    { name: '+# to maximum Mana', tier: 'T1 (70-75)', ilvl: 80 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1-T8', ilvl: 44 },
                    { name: '#% increased Elemental Damage with Attack Skills', tier: 'T1-T9', ilvl: 4 },
                    { name: 'Curse Enemies with Level # Assassin\'s Mark on Hit', tier: 'T1-T8', ilvl: 38 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to all Attributes', tier: 'T1 (51-55)', ilvl: 85 },
                    { name: '+# to Accuracy Rating', tier: 'T1 (400-450)', ilvl: 74 },
                    { name: '#% increased Rarity of Items found', tier: 'T1-T8', ilvl: 20 }
                ]
            },
            'Amulet': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (70-79)', ilvl: 82 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (55-62)', ilvl: 80 },
                    { name: '#% increased Global Critical Strike Chance', tier: 'T1-T10', ilvl: 20 },
                    { name: '+# to Level of all Skill Gems', tier: 'T1 (+2)', ilvl: 65 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1-T8', ilvl: 44 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to all Attributes', tier: 'T1 (51-55)', ilvl: 85 },
                    { name: '#% to Global Critical Strike Multiplier', tier: 'T1-T10', ilvl: 20 }
                ]
            },
            'Belt': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (90-99)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (50-60)', ilvl: 79 },
                    { name: '#% increased Flask Life Recovery rate', tier: 'T1-T7', ilvl: 16 },
                    { name: '#% increased Flask Mana Recovery rate', tier: 'T1-T7', ilvl: 16 },
                    { name: '#% increased Armour', tier: 'T1-T10', ilvl: 11 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '#% increased Flask Charges gained', tier: 'T1-T7', ilvl: 8 }
                ]
            },
            'Weapon': {
                prefix: [
                    { name: '+# to Level of Socketed Gems', tier: 'T1 (+2)', ilvl: 55 },
                    { name: 'Adds # to # Physical Damage', tier: 'T1-T10', ilvl: 11 },
                    { name: '#% increased Physical Damage', tier: 'T1-T10', ilvl: 11 },
                    { name: '+# to Accuracy Rating', tier: 'T1 (500-600)', ilvl: 79 },
                    { name: '#% increased Attack Speed', tier: 'T1-T10', ilvl: 2 },
                    { name: '#% increased Critical Strike Chance', tier: 'T1-T10', ilvl: 20 }
                ],
                suffix: [
                    { name: 'Adds # to # Fire Damage', tier: 'T1-T10', ilvl: 2 },
                    { name: 'Adds # to # Cold Damage', tier: 'T1-T10', ilvl: 2 },
                    { name: 'Adds # to # Lightning Damage', tier: 'T1-T10', ilvl: 2 },
                    { name: '+#% to Global Critical Strike Multiplier', tier: 'T1-T10', ilvl: 20 },
                    { name: '#% chance to gain Onslaught on Kill', tier: 'T1-T3', ilvl: 55 }
                ]
            }
        };

        // Get available mods for a specific item class
        function getModsForItemClass(itemClass, modType) {
            if (!itemClass) return [];

            let mods = [];

            // Add universal mods
            if (MOD_DATABASE.universal[modType]) {
                mods = mods.concat(MOD_DATABASE.universal[modType]);
            }

            // Add class-specific mods
            if (MOD_DATABASE[itemClass] && MOD_DATABASE[itemClass][modType]) {
                mods = mods.concat(MOD_DATABASE[itemClass][modType]);
            }

            // For weapon classes, add weapon mods
            if (itemClass.includes('Sword') || itemClass.includes('Axe') ||
                itemClass.includes('Mace') || itemClass.includes('Bow') ||
                itemClass.includes('Wand') || itemClass.includes('Dagger') ||
                itemClass.includes('Claw') || itemClass.includes('Sceptre') ||
                itemClass.includes('Staff')) {
                if (MOD_DATABASE.Weapon[modType]) {
                    mods = mods.concat(MOD_DATABASE.Weapon[modType]);
                }
            }

            // Remove duplicates
            const uniqueMods = Array.from(new Set(mods.map(m => m.name)))
                .map(name => mods.find(m => m.name === name));

            return uniqueMods;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
        });

        // Search form handler
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemName = itemNameInput.value.trim();
            const league = leagueSelect.value;
            
            if (!itemName) {
                showError('Please enter an item name');
                return;
            }

            await searchItem(itemName, league);
        });

        // Add to favorites handler
        favoriteBtn.addEventListener('click', async () => {
            if (!currentSearchResult) return;

            try {
                const itemName = itemNameInput.value.trim();
                const league = leagueSelect.value;
                
                await ipcRenderer.invoke('add-favorite', {
                    name: itemName,
                    league: league
                });

                showSuccess('Added to favorites!');
                favoriteBtn.style.display = 'none';
                await loadFavorites();
            } catch (err) {
                showError(`Failed to add to favorites: ${err.message}`);
            }
        });

        // Refresh favorites handler
        refreshFavoritesBtn.addEventListener('click', async () => {
            refreshFavoritesBtn.disabled = true;
            refreshFavoritesBtn.textContent = 'Refreshing...';
            
            try {
                for (const favorite of favorites) {
                    await searchItem(favorite.name, favorite.league, false);
                }
                showSuccess('All favorites refreshed!');
            } catch (err) {
                showError(`Failed to refresh favorites: ${err.message}`);
            } finally {
                refreshFavoritesBtn.disabled = false;
                refreshFavoritesBtn.textContent = 'Refresh All';
            }
        });

        async function searchItem(itemName, league, showUI = true) {
            try {
                if (showUI) {
                    showLoading();
                    hideError();
                    hideResults();
                }

                searchBtn.disabled = true;
                searchBtn.textContent = 'Searching...';

                const result = await ipcRenderer.invoke('search-item', itemName, league);
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                currentSearchResult = result.data;
                
                if (showUI) {
                    displayResults(result.data);
                    updateFavoriteButton(itemName, league);
                }
            } catch (err) {
                if (showUI) {
                    showError(`Search failed: ${err.message}`);
                }
                console.error('Search error:', err);
            } finally {
                if (showUI) {
                    hideLoading();
                }
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function displayResults(searchResult) {
            const { itemName, league, results, timestamp, minPrice, maxPrice, medianPrice, totalListings } = searchResult;
            
            resultsTitle.textContent = `Results for "${itemName}"`;
            resultsMeta.textContent = `League: ${league} | Updated: ${new Date(timestamp).toLocaleString()}`;
            
            // Update stats
            document.getElementById('minPrice').textContent = minPrice.toFixed(2);
            document.getElementById('medianPrice').textContent = medianPrice.toFixed(2);
            document.getElementById('maxPrice').textContent = maxPrice.toFixed(2);
            document.getElementById('totalListings').textContent = totalListings;
            
            // Clear previous results
            resultsTableBody.innerHTML = '';
            
            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsSection.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            // Populate table
            results.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.baseType || '-')}</td>
                    <td class="price">${item.chaosValue.toFixed(2)}</td>
                    <td>${item.listingCount || item.count || '-'}</td>
                    <td>${item.links || '-'}</td>
                    <td>${escapeHtml(item.variant || '-')}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            
            resultsSection.style.display = 'block';
        }

        async function loadFavorites() {
            try {
                const result = await ipcRenderer.invoke('get-favorites');
                if (result.success) {
                    favorites = result.data;
                    displayFavorites();
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        function displayFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavorites.style.display = 'block';
                return;
            }
            
            noFavorites.style.display = 'none';
            
            favorites.forEach(favorite => {
                const favoriteDiv = document.createElement('div');
                favoriteDiv.className = 'favorite-item';
                
                favoriteDiv.innerHTML = `
                    <div class="favorite-info">
                        <div class="favorite-name">${escapeHtml(favorite.name)}</div>
                        <div class="favorite-meta">
                            League: ${escapeHtml(favorite.league)} | 
                            Added: ${new Date(favorite.addedAt).toLocaleDateString()}
                            ${favorite.lastPrice ? ` | Last Price: ${favorite.lastPrice.toFixed(2)} chaos` : ''}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="btn-small btn-info" onclick="searchFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Search
                        </button>
                        <button class="btn-small btn-danger" onclick="removeFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Remove
                        </button>
                    </div>
                `;
                
                favoritesList.appendChild(favoriteDiv);
            });
        }

        async function searchFavorite(name, league) {
            itemNameInput.value = name;
            leagueSelect.value = league;
            await searchItem(name, league);
        }

        async function removeFavorite(name, league) {
            try {
                await ipcRenderer.invoke('remove-favorite', name);
                showSuccess('Removed from favorites!');
                await loadFavorites();
                updateFavoriteButton(itemNameInput.value.trim(), leagueSelect.value);
            } catch (err) {
                showError(`Failed to remove favorite: ${err.message}`);
            }
        }

        function updateFavoriteButton(itemName, league) {
            const isFavorite = favorites.some(fav => 
                fav.name.toLowerCase() === itemName.toLowerCase() && 
                fav.league === league
            );
            
            favoriteBtn.style.display = currentSearchResult && !isFavorite ? 'inline-block' : 'none';
        }

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'error'; // Reuse error styling but green
            successDiv.style.background = 'rgba(0,255,0,0.2)';
            successDiv.style.color = '#ccffcc';
            successDiv.style.borderColor = '#00ff00';
            successDiv.textContent = message;
            
            error.parentNode.insertBefore(successDiv, error.nextSibling);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-complete functionality (simple implementation)
        const commonItems = [
            'Tabula Rasa', 'Divine Orb', 'Chaos Orb', 'Exalted Orb', 'Ancient Orb',
            'Shaper\'s Touch', 'Goldrim', 'Wanderlust', 'Meginord\'s Girdle',
            'The Baron', 'Belly of the Beast', 'Shavronne\'s Wrappings',
            'Atziri\'s Promise', 'Taste of Hate', 'Dying Sun', 'The Wise Oak'
        ];

        itemNameInput.addEventListener('input', (e) => {
            // Simple auto-suggest could be added here
            // For now, just basic functionality
        });

        // ===== DYNAMIC LEAGUE LOADING =====
        let availableLeagues = [];

        async function loadLeagues() {
            try {
                const result = await ipcRenderer.invoke('get-leagues');
                if (result.success && result.data.length > 0) {
                    availableLeagues = result.data;
                    updateLeagueSelectors();
                } else {
                    // Fallback
                    availableLeagues = ['Keepers of the Flame', 'Standard', 'Hardcore'];
                    updateLeagueSelectors();
                }
            } catch (error) {
                console.error('Failed to load leagues:', error);
                availableLeagues = ['Keepers of the Flame', 'Standard', 'Hardcore'];
                updateLeagueSelectors();
            }
        }

        function updateLeagueSelectors() {
            const leagueSelectors = [
                document.getElementById('league'),
                document.getElementById('craftLeague'),
                document.getElementById('insightsLeague')
            ];

            leagueSelectors.forEach(selector => {
                if (selector) {
                    const currentValue = selector.value; // Save current selection
                    selector.innerHTML = '';
                    availableLeagues.forEach((league, index) => {
                        const option = document.createElement('option');
                        option.value = league;
                        option.textContent = league;
                        // Set first league (current league) as default if no previous selection
                        if (index === 0 && !currentValue) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                    // Restore previous selection if it still exists
                    if (currentValue && availableLeagues.includes(currentValue)) {
                        selector.value = currentValue;
                    }
                }
            });
        }

        // Load leagues on startup
        loadLeagues();

        // ===== TAB SWITCHING =====
        const tabs = document.querySelectorAll('.tab');
        const marketTab = document.getElementById('marketTab');
        const insightsTab = document.getElementById('insightsTab');
        const craftingTab = document.getElementById('craftingTab');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Hide all tab contents
                marketTab.classList.remove('active');
                insightsTab.classList.remove('active');
                craftingTab.classList.remove('active');

                // Show selected tab
                if (tabName === 'market') {
                    marketTab.classList.add('active');
                } else if (tabName === 'insights') {
                    insightsTab.classList.add('active');
                    loadMarketInsights();
                } else if (tabName === 'crafting') {
                    craftingTab.classList.add('active');
                    initializeCrafting();
                }
            });
        });

        // ===== CRAFTING FUNCTIONALITY =====
        let craftingInitialized = false;
        let desiredMods = [];
        let modCounter = 0;

        const craftingForm = document.getElementById('craftingForm');
        const modsList = document.getElementById('modsList');
        const addModBtn = document.getElementById('addModBtn');
        const craftingLoading = document.getElementById('craftingLoading');
        const craftingError = document.getElementById('craftingError');
        const craftingResults = document.getElementById('craftingResults');
        const craftingResultsContent = document.getElementById('craftingResultsContent');

        async function initializeCrafting() {
            if (craftingInitialized) return;

            try {
                const league = document.getElementById('craftLeague').value;
                const result = await ipcRenderer.invoke('initialize-crafting', league);
                if (result.success) {
                    console.log('Crafting data initialized');
                    craftingInitialized = true;
                } else {
                    showCraftingError('Failed to initialize crafting data: ' + result.error);
                }
            } catch (err) {
                console.error('Crafting initialization error:', err);
            }
        }

        function addModInput() {
            const modId = modCounter++;
            const modDiv = document.createElement('div');
            modDiv.className = 'mod-input-group';
            modDiv.setAttribute('data-mod-id', modId);

            // Get current item class
            const itemClass = document.getElementById('craftItemClass').value;

            modDiv.innerHTML = `
                <div class="mod-inputs">
                    <div class="form-group">
                        <label>Type:</label>
                        <select class="mod-type" data-mod-id="${modId}" required>
                            <option value="">Select Type First</option>
                            <option value="prefix">Prefix</option>
                            <option value="suffix">Suffix</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mod Name:</label>
                        <select class="mod-name" data-mod-id="${modId}" required>
                            <option value="">Select type first...</option>
                        </select>
                    </div>
                    <button type="button" class="btn-danger btn-small" onclick="removeMod(${modId})">Remove</button>
                </div>
            `;
            modsList.appendChild(modDiv);

            // Add event listener to mod type selector
            const modTypeSelect = modDiv.querySelector('.mod-type');
            const modNameSelect = modDiv.querySelector('.mod-name');

            modTypeSelect.addEventListener('change', function() {
                updateModNameOptions(modNameSelect, this.value, itemClass);
            });
        }

        // Update mod name dropdown based on type and item class
        function updateModNameOptions(selectElement, modType, itemClass) {
            if (!modType) {
                selectElement.innerHTML = '<option value="">Select type first...</option>';
                return;
            }

            const mods = getModsForItemClass(itemClass, modType);

            if (mods.length === 0) {
                selectElement.innerHTML = '<option value="">No mods available</option>';
                return;
            }

            selectElement.innerHTML = '<option value="">Choose a mod...</option>';
            mods.forEach(mod => {
                const option = document.createElement('option');
                option.value = mod.name;
                option.textContent = `${mod.name} (${mod.tier}, ilvl ${mod.ilvl}+)`;
                selectElement.appendChild(option);
            });
        }

        // Update all mod dropdowns when item class changes
        function updateAllModDropdowns() {
            const itemClass = document.getElementById('craftItemClass').value;
            const modInputs = document.querySelectorAll('.mod-input-group');

            modInputs.forEach(modInput => {
                const modTypeSelect = modInput.querySelector('.mod-type');
                const modNameSelect = modInput.querySelector('.mod-name');

                if (modTypeSelect && modTypeSelect.value) {
                    updateModNameOptions(modNameSelect, modTypeSelect.value, itemClass);
                }
            });
        }

        // Add event listener to item class selector
        const craftItemClassSelect = document.getElementById('craftItemClass');
        if (craftItemClassSelect) {
            craftItemClassSelect.addEventListener('change', updateAllModDropdowns);
        }

        window.removeMod = function(modId) {
            const modDiv = document.querySelector(`[data-mod-id="${modId}"]`);
            if (modDiv) {
                modDiv.remove();
            }
        };

        addModBtn.addEventListener('click', addModInput);

        // Item paste parser
        const itemPasteArea = document.getElementById('itemPaste');
        if (itemPasteArea) {
            itemPasteArea.addEventListener('input', function() {
                const pastedText = this.value.trim();
                if (!pastedText) return;

                try {
                    const parsedData = parsePoEItem(pastedText);

                    // Auto-fill the form fields
                    if (parsedData.baseName) {
                        document.getElementById('craftBaseItem').value = parsedData.baseName;
                    }

                    if (parsedData.itemLevel) {
                        document.getElementById('craftItemLevel').value = parsedData.itemLevel;
                    }

                    if (parsedData.itemClass) {
                        const itemClassSelect = document.getElementById('craftItemClass');
                        // Try to match the item class
                        for (let option of itemClassSelect.options) {
                            if (option.value.toLowerCase().includes(parsedData.itemClass.toLowerCase()) ||
                                parsedData.itemClass.toLowerCase().includes(option.value.toLowerCase())) {
                                itemClassSelect.value = option.value;
                                break;
                            }
                        }
                    }

                    // Visual feedback
                    itemPasteArea.style.borderColor = '#00ff00';
                    setTimeout(() => {
                        itemPasteArea.style.borderColor = '#444';
                    }, 1000);

                } catch (err) {
                    console.error('Error parsing item:', err);
                    itemPasteArea.style.borderColor = '#ff4444';
                    setTimeout(() => {
                        itemPasteArea.style.borderColor = '#444';
                    }, 1000);
                }
            });
        }

        // Parse PoE item text
        function parsePoEItem(itemText) {
            const lines = itemText.split('\n').map(line => line.trim()).filter(line => line);
            const result = {
                baseName: null,
                itemLevel: null,
                itemClass: null,
                rarity: null
            };

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Parse rarity (first line usually)
                if (line.startsWith('Rarity:')) {
                    result.rarity = line.replace('Rarity:', '').trim();
                }

                // Parse item level
                if (line.match(/Item Level:|ItemLevel:|ilvl:/i)) {
                    const ilvlMatch = line.match(/(\d+)/);
                    if (ilvlMatch) {
                        result.itemLevel = parseInt(ilvlMatch[1]);
                    }
                }

                // Parse base name - usually after rarity line or second non-empty line
                // For magic/rare items, look for "--------" separator and get the line after
                if (line === '--------') {
                    // Base type is usually after the separator
                    for (let j = i + 1; j < lines.length; j++) {
                        const nextLine = lines[j];
                        // Skip requirement lines and look for base
                        if (!nextLine.match(/Requirements?:|Sockets:|Item Level:|Quality:/i)) {
                            result.baseName = nextLine;
                            break;
                        }
                    }
                }

                // For white items, base name is the second line after rarity
                if (result.rarity && result.rarity.toLowerCase() === 'normal' && i === 1) {
                    result.baseName = line;
                }

                // Try to extract item class from item text
                // Common patterns: "Body Armour", "Ring", "Amulet", etc.
                if (line.match(/Body Armour|Helmet|Gloves|Boots|Shield|Ring|Amulet|Belt|Sword|Axe|Mace|Bow|Wand|Dagger|Claw|Sceptre|Staff|Quiver|Jewel/i)) {
                    const classMatch = line.match(/Body Armour|Helmet|Gloves|Boots|Shield|Ring|Amulet|Belt|Sword|Axe|Mace|Bow|Wand|Dagger|Claw|Sceptre|Staff|Quiver|Jewel/i);
                    if (classMatch) {
                        result.itemClass = classMatch[0];
                    }
                }
            }

            // If no base name found yet, try to get it from the name lines
            if (!result.baseName && lines.length >= 2) {
                // For magic/rare items: line after the item name is usually the base
                // Skip the first line (rarity) and second line (item name if rare/magic)
                if (lines.length >= 3 && result.rarity && result.rarity.toLowerCase() !== 'normal') {
                    result.baseName = lines[2];
                }
            }

            return result;
        }

        // Add initial mod input
        addModInput();

        craftingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const baseItem = document.getElementById('craftBaseItem').value;
            const itemClass = document.getElementById('craftItemClass').value;
            const league = document.getElementById('craftLeague').value;

            // Collect mods
            const modInputs = document.querySelectorAll('.mod-input-group');
            const desiredMods = [];

            modInputs.forEach(modDiv => {
                const name = modDiv.querySelector('.mod-name').value;
                const type = modDiv.querySelector('.mod-type').value;
                if (name) {
                    desiredMods.push({ name, type });
                }
            });

            if (desiredMods.length === 0) {
                showCraftingError('Please add at least one desired mod');
                return;
            }

            // Show loading
            craftingLoading.style.display = 'block';
            craftingError.style.display = 'none';
            craftingResults.style.display = 'none';

            try {
                const result = await ipcRenderer.invoke('calculate-crafting', {
                    desiredMods,
                    baseItemName: baseItem,
                    itemClass,
                    league
                });

                craftingLoading.style.display = 'none';

                if (result.success) {
                    displayCraftingResults(result.data);
                } else {
                    showCraftingError(result.error);
                }
            } catch (err) {
                craftingLoading.style.display = 'none';
                showCraftingError('Calculation failed: ' + err.message);
            }
        });

        function displayCraftingResults(data) {
            craftingResults.style.display = 'block';

            let html = '';

            // Base recommendation
            if (data.baseRecommendation) {
                const base = data.baseRecommendation;
                html += `
                    <div class="base-recommendation">
                        <div class="base-rec-title">üíé Recommended Base</div>
                        <p><strong>Type:</strong> ${base.baseType.toUpperCase()}</p>
                        <p><strong>Item:</strong> ${base.itemName}</p>
                        <p><strong>Cost:</strong> ${formatPrice(base.averageCost, data.preferredCurrency)}</p>
                        <p><strong>Reason:</strong> ${base.reason}</p>
                    </div>
                `;
            }

            // Total cost summary
            html += `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${formatPrice(data.totalCostChaos, data.preferredCurrency)}</div>
                        <div class="stat-label">Total Estimated Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.methods.length}</div>
                        <div class="stat-label">Methods Available</div>
                    </div>
                </div>
            `;

            // Methods
            data.methods.forEach((method, index) => {
                const isRecommended = index === 0;
                html += `
                    <div class="method-card ${isRecommended ? 'recommended' : ''}">
                        <div class="method-header">
                            <div>
                                <span class="method-name">${method.name}</span>
                                ${isRecommended ? '<span class="recommended-badge">‚≠ê RECOMMENDED</span>' : ''}
                            </div>
                            <div class="method-cost">${formatPrice(method.averageCost, data.preferredCurrency)}</div>
                        </div>
                        <div class="method-description">${method.description}</div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${(method.probability * 100).toFixed(2)}%</div>
                                <div class="method-stat-label">Success Rate</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${method.expectedAttempts}</div>
                                <div class="method-stat-label">Avg. Attempts</div>
                            </div>
                        </div>
                        <div>
                            <strong style="color: #ffd700;">Currency Needed:</strong>
                            <ul class="crafting-steps" style="margin-top: 10px;">
                                ${Object.entries(method.currencyUsed).map(([currency, amount]) =>
                                    `<li>${Math.ceil(amount)}x ${currency}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong style="color: #ffd700;">Steps:</strong>
                            <ol class="crafting-steps" style="margin-top: 10px;">
                                ${method.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            });

            craftingResultsContent.innerHTML = html;
        }

        function formatPrice(chaosValue, preferredCurrency = 'chaos') {
            const divinePrice = 200; // This should be fetched from poe.ninja

            if (preferredCurrency === 'divine' || chaosValue >= divinePrice * 2) {
                const divineValue = chaosValue / divinePrice;
                return `${divineValue.toFixed(2)} Divine`;
            }

            return `${chaosValue.toFixed(1)} Chaos`;
        }

        function showCraftingError(message) {
            craftingError.textContent = message;
            craftingError.style.display = 'block';
            setTimeout(() => {
                craftingError.style.display = 'none';
            }, 5000);
        }

        // ===== CRAFTING GUIDE (LEARN TO CRAFT) FUNCTIONALITY =====
        const analyzeItemBtn = document.getElementById('analyzeItemBtn');
        const guidePaste = document.getElementById('guidePaste');
        const guideLoading = document.getElementById('guideLoading');
        const guideError = document.getElementById('guideError');
        const guideResults = document.getElementById('guideResults');
        const guideItemInfo = document.getElementById('guideItemInfo');
        const guideCraftingSteps = document.getElementById('guideCraftingSteps');
        const guideTips = document.getElementById('guideTips');

        if (analyzeItemBtn) {
            analyzeItemBtn.addEventListener('click', function() {
                const itemText = guidePaste.value.trim();

                if (!itemText) {
                    showGuideError('Please paste an item first!');
                    return;
                }

                try {
                    guideLoading.style.display = 'block';
                    guideError.style.display = 'none';
                    guideResults.style.display = 'none';

                    // Parse the item
                    const itemData = parsePoEItem(itemText);
                    const modsOnItem = parseItemMods(itemText);

                    setTimeout(() => {
                        displayCraftingGuide(itemData, modsOnItem, itemText);
                        guideLoading.style.display = 'none';
                        guideResults.style.display = 'block';
                    }, 500);

                } catch (err) {
                    guideLoading.style.display = 'none';
                    showGuideError('Error analyzing item: ' + err.message);
                }
            });
        }

        function parseItemMods(itemText) {
            const lines = itemText.split('\n').map(line => line.trim()).filter(line => line);
            const mods = {
                explicit: [],
                implicit: [],
                crafted: []
            };

            let inExplicitMods = false;
            let inImplicitMods = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Skip header lines
                if (line.startsWith('Rarity:') || line.startsWith('Item Level:') ||
                    line.match(/Requirements?:|Sockets:|Quality:/i) || line === '--------') {
                    if (line === '--------') {
                        inExplicitMods = false;
                        inImplicitMods = true;
                    }
                    continue;
                }

                // Detect explicit mods (after item base)
                if (inImplicitMods && line && !line.match(/Requirements?:|Sockets:|Item Level:/i)) {
                    if (line.match(/^\+|^\d|^#|increased|reduced|to maximum|Resistance|Damage|Adds/i)) {
                        if (line.includes('(crafted)')) {
                            mods.crafted.push(line.replace('(crafted)', '').trim());
                        } else if (line.includes('(implicit)')) {
                            mods.implicit.push(line.replace('(implicit)', '').trim());
                        } else {
                            mods.explicit.push(line);
                        }
                    }
                }
            }

            return mods;
        }

        function displayCraftingGuide(itemData, modsOnItem, rawText) {
            // Display item info
            let infoHTML = `
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                    <strong style="color: #ffd700; font-size: 18px;">${itemData.baseName || 'Unknown Item'}</strong><br>
                    <span style="color: #aaa;">Item Level: ${itemData.itemLevel || '?'}</span><br>
                    <span style="color: #aaa;">Item Class: ${itemData.itemClass || 'Unknown'}</span>
                </div>
            `;

            if (modsOnItem.implicit.length > 0) {
                infoHTML += `<div style="margin-bottom: 10px;"><strong style="color: #8888ff;">Implicit Mods:</strong><ul style="margin: 5px 0;">`;
                modsOnItem.implicit.forEach(mod => {
                    infoHTML += `<li style="color: #aaf;">${mod}</li>`;
                });
                infoHTML += `</ul></div>`;
            }

            if (modsOnItem.explicit.length > 0) {
                infoHTML += `<div style="margin-bottom: 10px;"><strong style="color: #88ff88;">Explicit Mods:</strong><ul style="margin: 5px 0;">`;
                modsOnItem.explicit.forEach(mod => {
                    infoHTML += `<li style="color: #afa;">${mod}</li>`;
                });
                infoHTML += `</ul></div>`;
            }

            if (modsOnItem.crafted.length > 0) {
                infoHTML += `<div><strong style="color: #ffaa00;">Crafted Mods:</strong><ul style="margin: 5px 0;">`;
                modsOnItem.crafted.forEach(mod => {
                    infoHTML += `<li style="color: #fa0;">${mod}</li>`;
                });
                infoHTML += `</ul></div>`;
            }

            guideItemInfo.innerHTML = infoHTML;

            // Generate crafting steps based on mods
            let stepsHTML = generateCraftingSteps(itemData, modsOnItem);
            guideCraftingSteps.innerHTML = stepsHTML;

            // Generate tips
            let tipsHTML = generateCraftingTips(itemData, modsOnItem);
            guideTips.innerHTML = tipsHTML;
        }

        function generateCraftingSteps(itemData, modsOnItem) {
            const modCount = modsOnItem.explicit.length;
            const hasLife = modsOnItem.explicit.some(m => m.includes('Life'));
            const hasResists = modsOnItem.explicit.some(m => m.includes('Resistance'));
            const hasES = modsOnItem.explicit.some(m => m.includes('Energy Shield'));

            let stepsHTML = `<ol style="color: #ddd; line-height: 1.8;">`;

            // Step 1: Acquire base
            stepsHTML += `<li><strong style="color: #ffd700;">Acquire the Base Item</strong><br>
                <span style="color: #aaa;">‚Ä¢ Get a <strong>${itemData.baseName || 'base item'}</strong> with item level <strong>${itemData.itemLevel || '82-86'}</strong></span><br>
                <span style="color: #aaa;">‚Ä¢ Higher ilvl = better mod tiers (T1 mods usually need ilvl 82-86)</span>
            </li>`;

            // Step 2: Crafting method based on mod count
            if (modCount <= 2) {
                stepsHTML += `<li><strong style="color: #ffd700;">Alt-Regal Method (For 1-2 Mods)</strong><br>
                    <span style="color: #aaa;">‚Ä¢ Use <strong>Orbs of Alteration</strong> on a white (normal) base until you hit one of your desired mods</span><br>
                    <span style="color: #aaa;">‚Ä¢ Use an <strong>Orb of Augmentation</strong> to add a second mod if needed</span><br>
                    <span style="color: #aaa;">‚Ä¢ Use a <strong>Regal Orb</strong> to make it rare (adds one more random mod)</span><br>
                    <span style="color: #aaa;">‚Ä¢ Continue with crafting bench or other methods</span>
                </li>`;
            } else if (modCount <= 4) {
                stepsHTML += `<li><strong style="color: #ffd700;">Chaos Spam Method (For 3-4 Mods)</strong><br>
                    <span style="color: #aaa;">‚Ä¢ Spam <strong>Chaos Orbs</strong> on the item until you hit 2-3 desired mods</span><br>
                    <span style="color: #aaa;">‚Ä¢ Use <strong>Harvest crafts</strong> to improve bad mods if available</span><br>
                    <span style="color: #aaa;">‚Ä¢ Can be expensive but straightforward</span>
                </li>`;
            } else {
                stepsHTML += `<li><strong style="color: #ffd700;">Essence or Fossil Crafting (For 5+ Mods)</strong><br>
                    <span style="color: #aaa;">‚Ä¢ Use <strong>Essences</strong> to guarantee one specific mod tier</span><br>
                    <span style="color: #aaa;">‚Ä¢ Or use <strong>Fossils + Resonators</strong> to weight specific mod types</span><br>
                    <span style="color: #aaa;">‚Ä¢ This is advanced crafting for multiple T1 mods</span>
                </li>`;
            }

            // Step 3: Fine-tuning
            stepsHTML += `<li><strong style="color: #ffd700;">Fine-Tune with Crafting Bench</strong><br>
                <span style="color: #aaa;">‚Ä¢ Visit your hideout crafting bench</span><br>
                <span style="color: #aaa;">‚Ä¢ Add missing resists or stats if you have an open affix</span><br>
                <span style="color: #aaa;">‚Ä¢ Craft "Prefixes Cannot Be Changed" or "Suffixes Cannot Be Changed" for advanced crafting</span>
            </li>`;

            // Step 4: Advanced techniques
            stepsHTML += `<li><strong style="color: #ffd700;">Advanced Techniques (Optional)</strong><br>
                <span style="color: #aaa;">‚Ä¢ <strong>Harvest Reforge:</strong> Reroll with weighted mods (Life, Caster, etc.)</span><br>
                <span style="color: #aaa;">‚Ä¢ <strong>Veiled Chaos Orb:</strong> Reroll + add veiled mod</span><br>
                <span style="color: #aaa;">‚Ä¢ <strong>Eldritch Crafting:</strong> For influenced items (Eldritch Chaos/Exalt/Annul)</span>
            </li>`;

            stepsHTML += `</ol>`;

            return stepsHTML;
        }

        function generateCraftingTips(itemData, modsOnItem) {
            let tipsHTML = `<ul style="color: #ddd; line-height: 1.8;">`;

            tipsHTML += `<li>üí∞ <strong>Cost Estimate:</strong> Expect to spend 10-100+ chaos orbs depending on mod rarity and your luck</li>`;
            tipsHTML += `<li>üé≤ <strong>RNG Warning:</strong> Crafting is gambling! Budget accordingly and don't spend your last currency</li>`;
            tipsHTML += `<li>üìä <strong>Use Craft of Exile:</strong> Visit <a href="https://www.craftofexile.com" target="_blank" style="color: #ffd700;">craftofexile.com</a> for exact probabilities</li>`;
            tipsHTML += `<li>üîç <strong>Check poe.trade First:</strong> Sometimes it's cheaper to buy than craft!</li>`;

            if (itemData.itemLevel && itemData.itemLevel >= 86) {
                tipsHTML += `<li>‚ú® <strong>Great ilvl!</strong> Your ilvl ${itemData.itemLevel} base can roll T1 mods on most slots</li>`;
            } else if (itemData.itemLevel && itemData.itemLevel >= 82) {
                tipsHTML += `<li>‚úÖ <strong>Good ilvl!</strong> Your ilvl ${itemData.itemLevel} base can roll most T1 mods</li>`;
            } else if (itemData.itemLevel && itemData.itemLevel < 82) {
                tipsHTML += `<li>‚ö†Ô∏è <strong>Low ilvl:</strong> ilvl ${itemData.itemLevel} may not be able to roll T1 mods (need 82-86)</li>`;
            }

            const modCount = modsOnItem.explicit.length;
            if (modCount >= 5) {
                tipsHTML += `<li>üéØ <strong>Complex Item:</strong> With ${modCount} mods, this will be expensive to replicate. Consider Harvest or Fossil crafting.</li>`;
            }

            tipsHTML += `</ul>`;

            return tipsHTML;
        }

        function showGuideError(message) {
            guideError.textContent = message;
            guideError.style.display = 'block';
            setTimeout(() => {
                guideError.style.display = 'none';
            }, 5000);
        }

        // ===== MARKET INSIGHTS FUNCTIONALITY =====
        let insightsData = {
            popular: [],
            profitable: [],
            trending: []
        };

        const insightsLoading = document.getElementById('insightsLoading');
        const insightsError = document.getElementById('insightsError');
        const refreshInsightsBtn = document.getElementById('refreshInsightsBtn');

        async function loadMarketInsights() {
            const league = document.getElementById('insightsLeague').value;
            if (!league) return;

            insightsLoading.style.display = 'block';
            insightsError.style.display = 'none';

            // Hide all sections
            document.getElementById('popularSection').style.display = 'none';
            document.getElementById('profitableSection').style.display = 'none';
            document.getElementById('trendingSection').style.display = 'none';

            try {
                // Fetch all data in parallel
                const [popularResult, profitableResult, trendingResult] = await Promise.all([
                    ipcRenderer.invoke('get-popular-items', league, 20),
                    ipcRenderer.invoke('get-profitable-items', league, 20),
                    ipcRenderer.invoke('get-trending-items', league, 10)
                ]);

                if (popularResult.success) {
                    insightsData.popular = popularResult.data;
                    document.getElementById('popularCount').textContent = insightsData.popular.length;
                }

                if (profitableResult.success) {
                    insightsData.profitable = profitableResult.data;
                    document.getElementById('profitableCount').textContent = insightsData.profitable.length;
                }

                if (trendingResult.success) {
                    insightsData.trending = trendingResult.data;
                    document.getElementById('trendingCount').textContent = insightsData.trending.length;
                }

                insightsLoading.style.display = 'none';

                // Show first section by default
                showSection('popular');
            } catch (error) {
                insightsLoading.style.display = 'none';
                showInsightsError('Failed to load market data: ' + error.message);
            }
        }

        window.showSection = function(section) {
            // Hide all sections
            document.getElementById('popularSection').style.display = 'none';
            document.getElementById('profitableSection').style.display = 'none';
            document.getElementById('trendingSection').style.display = 'none';

            // Show selected section
            if (section === 'popular') {
                document.getElementById('popularSection').style.display = 'block';
                displayPopularItems();
            } else if (section === 'profitable') {
                document.getElementById('profitableSection').style.display = 'block';
                displayProfitableItems();
            } else if (section === 'trending') {
                document.getElementById('trendingSection').style.display = 'block';
                displayTrendingItems();
            }
        };

        function displayPopularItems() {
            const container = document.getElementById('popularItemsList');
            if (insightsData.popular.length === 0) {
                container.innerHTML = '<p>No data available</p>';
                return;
            }

            let html = '';
            insightsData.popular.forEach((item, index) => {
                const formattedPrice = formatPriceForDisplay(item.chaosValue);
                const readableBaseType = formatBaseType(item.baseType || item.name);

                html += `
                    <div class="method-card">
                        <div class="method-header">
                            <div>
                                <span class="method-name">#${index + 1} ${item.name}</span>
                                ${item.variant ? `<span style="color: #999; margin-left: 10px;">${item.variant}</span>` : ''}
                            </div>
                            <div class="method-cost">${formattedPrice}</div>
                        </div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${item.listingCount || 0}</div>
                                <div class="method-stat-label">Listings</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${readableBaseType}</div>
                                <div class="method-stat-label">Type</div>
                            </div>
                            ${item.links ? `
                            <div class="method-stat">
                                <div class="method-stat-value">${item.links}L</div>
                                <div class="method-stat-label">Links</div>
                            </div>
                            ` : ''}
                        </div>
                        <p style="color: #4ade80; margin-top: 10px;">
                            üí° High demand item - Good for trading and crafting for profit
                        </p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayProfitableItems() {
            const container = document.getElementById('profitableItemsList');
            if (insightsData.profitable.length === 0) {
                container.innerHTML = '<p style="color: #cccccc; padding: 20px;">No craftable items found. Try refreshing or selecting a different league.</p>';
                return;
            }

            let html = '';
            insightsData.profitable.forEach((data, index) => {
                const item = data.item;
                const profitPercent = ((data.profitMargin / data.sellPrice) * 100).toFixed(1);
                const formattedSellPrice = formatPriceForDisplay(data.sellPrice);
                const formattedProfit = formatPriceForDisplay(data.profitMargin);
                const readableBaseType = formatBaseType(item.baseType || item.name);

                html += `
                    <div class="method-card">
                        <div class="method-header">
                            <div>
                                <span class="method-name">#${index + 1} ${item.name}</span>
                                ${item.variant ? `<span style="color: #999; margin-left: 10px;">${item.variant}</span>` : ''}
                                <span style="background: rgba(74, 222, 128, 0.2); color: #4ade80; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">
                                    ‚úì Craftable
                                </span>
                            </div>
                            <div class="method-cost">${formattedProfit} Profit</div>
                        </div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${formattedSellPrice}</div>
                                <div class="method-stat-label">Market Price</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${data.craftingMethod}</div>
                                <div class="method-stat-label">Suggested Method</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${data.demand}</div>
                                <div class="method-stat-label">Demand</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${item.listingCount || 0}</div>
                                <div class="method-stat-label">Listings</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-left: 3px solid #4ade80; border-radius: 5px;">
                            <p style="color: #4ade80; margin: 0;">
                                üí∞ <strong>Profit Margin:</strong> ${formattedProfit} (${profitPercent}%)
                            </p>
                            <p style="color: #cccccc; margin: 5px 0 0 0; font-size: 0.9em;">
                                ${item.levelRequired ? `Level ${item.levelRequired} ‚Ä¢ ` : ''}${readableBaseType}
                            </p>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayTrendingItems() {
            const container = document.getElementById('trendingItemsList');
            if (insightsData.trending.length === 0) {
                container.innerHTML = '<p>No data available</p>';
                return;
            }

            let html = '';
            insightsData.trending.forEach((item, index) => {
                const formattedPrice = formatPriceForDisplay(item.chaosValue);
                const readableBaseType = formatBaseType(item.baseType || item.name);

                html += `
                    <div class="method-card">
                        <div class="method-header">
                            <div>
                                <span class="method-name">#${index + 1} ${item.name}</span>
                                ${item.variant ? `<span style="color: #999; margin-left: 10px;">${item.variant}</span>` : ''}
                            </div>
                            <div class="method-cost">${formattedPrice}</div>
                        </div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${item.listingCount || 0}</div>
                                <div class="method-stat-label">Listings</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${readableBaseType}</div>
                                <div class="method-stat-label">Type</div>
                            </div>
                        </div>
                        <p style="color: #ffd700; margin-top: 10px;">
                            üìà Trending - High value and activity
                        </p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Helper function to format prices (Chaos vs Divine)
        function formatPriceForDisplay(chaosValue) {
            const divinePrice = 200; // Approximate Divine Orb price in Chaos

            if (chaosValue >= divinePrice) {
                const divineValue = (chaosValue / divinePrice).toFixed(2);
                return `${divineValue} Divine`;
            } else if (chaosValue >= 10) {
                return `${Math.round(chaosValue)} Chaos`;
            } else {
                return `${chaosValue.toFixed(1)} Chaos`;
            }
        }

        // Helper function to format base type names for readability
        function formatBaseType(baseType) {
            if (!baseType || baseType === 'N/A') return 'Base Item';

            // Remove common prefixes that make names too long
            let formatted = baseType
                .replace(/^(Metadata\/Items\/)/i, '')
                .replace(/^(Currency\/)/i, '')
                .replace(/^(UniqueItems\/)/i, '');

            // Handle camelCase and PascalCase - add spaces
            formatted = formatted.replace(/([a-z])([A-Z])/g, '$1 $2');

            // Handle underscores
            formatted = formatted.replace(/_/g, ' ');

            // Capitalize first letter of each word
            formatted = formatted.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            // Truncate if too long
            if (formatted.length > 25) {
                formatted = formatted.substring(0, 22) + '...';
            }

            return formatted;
        }

        refreshInsightsBtn.addEventListener('click', loadMarketInsights);

        document.getElementById('insightsLeague').addEventListener('change', () => {
            // Reset counts
            document.getElementById('popularCount').textContent = '0';
            document.getElementById('profitableCount').textContent = '0';
            document.getElementById('trendingCount').textContent = '0';
        });

        function showInsightsError(message) {
            insightsError.textContent = message;
            insightsError.style.display = 'block';
            setTimeout(() => {
                insightsError.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
