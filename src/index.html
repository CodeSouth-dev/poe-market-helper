<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path of Exile Market Helper</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            --transition-speed: 0.3s;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9ecef;
            --bg-hover: #f8f9fa;
            --bg-glass: rgba(255, 255, 255, 0.8);

            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-tertiary: #718096;

            --accent-primary: #d97706;
            --accent-secondary: #f59e0b;
            --accent-gradient: linear-gradient(135deg, #f59e0b, #fbbf24);

            --border-color: #e2e8f0;
            --border-color-hover: #cbd5e0;

            --success: #10b981;
            --success-bg: #d1fae5;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --error: #ef4444;
            --error-bg: #fee2e2;

            --confidence-high: #10b981;
            --confidence-high-bg: rgba(16, 185, 129, 0.15);
            --confidence-medium: #f59e0b;
            --confidence-medium-bg: rgba(245, 158, 11, 0.15);
            --confidence-low: #ef4444;
            --confidence-low-bg: rgba(239, 68, 68, 0.15);

            --popular-badge-bg: linear-gradient(45deg, #f59e0b, #fbbf24);
            --popular-badge-text: #78350f;

            --table-header-bg: rgba(249, 250, 251, 0.9);
            --table-row-hover: rgba(249, 250, 251, 0.5);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --bg-glass: rgba(30, 41, 59, 0.8);

            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;

            --accent-primary: #fbbf24;
            --accent-secondary: #f59e0b;
            --accent-gradient: linear-gradient(135deg, #fbbf24, #f59e0b);

            --border-color: #334155;
            --border-color-hover: #475569;

            --success: #34d399;
            --success-bg: rgba(16, 185, 129, 0.2);
            --warning: #fbbf24;
            --warning-bg: rgba(245, 158, 11, 0.2);
            --error: #f87171;
            --error-bg: rgba(239, 68, 68, 0.2);

            --confidence-high: #34d399;
            --confidence-high-bg: rgba(52, 211, 153, 0.2);
            --confidence-medium: #fbbf24;
            --confidence-medium-bg: rgba(251, 191, 36, 0.2);
            --confidence-low: #f87171;
            --confidence-low-bg: rgba(248, 113, 113, 0.2);

            --popular-badge-bg: linear-gradient(45deg, #fbbf24, #fde047);
            --popular-badge-text: #422006;

            --table-header-bg: rgba(51, 65, 85, 0.8);
            --table-row-hover: rgba(51, 65, 85, 0.4);
        }

        /* Auto-detect system preference */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --bg-tertiary: #334155;
                --bg-hover: #475569;
                --bg-glass: rgba(30, 41, 59, 0.8);

                --text-primary: #f1f5f9;
                --text-secondary: #cbd5e1;
                --text-tertiary: #94a3b8;

                --accent-primary: #fbbf24;
                --accent-secondary: #f59e0b;
                --accent-gradient: linear-gradient(135deg, #fbbf24, #f59e0b);

                --border-color: #334155;
                --border-color-hover: #475569;

                --success: #34d399;
                --success-bg: rgba(16, 185, 129, 0.2);
                --warning: #fbbf24;
                --warning-bg: rgba(245, 158, 11, 0.2);
                --error: #f87171;
                --error-bg: rgba(239, 68, 68, 0.2);

                --confidence-high: #34d399;
                --confidence-high-bg: rgba(52, 211, 153, 0.2);
                --confidence-medium: #fbbf24;
                --confidence-medium-bg: rgba(251, 191, 36, 0.2);
                --confidence-low: #f87171;
                --confidence-low-bg: rgba(248, 113, 113, 0.2);

                --popular-badge-bg: linear-gradient(45deg, #fbbf24, #fde047);
                --popular-badge-text: #422006;

                --table-header-bg: rgba(51, 65, 85, 0.8);
                --table-row-hover: rgba(51, 65, 85, 0.4);
            }
        }

        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) {
                --bg-primary: #f5f7fa;
                --bg-secondary: #ffffff;
                --bg-tertiary: #e9ecef;
                --bg-hover: #f8f9fa;
                --bg-glass: rgba(255, 255, 255, 0.8);

                --text-primary: #1a202c;
                --text-secondary: #4a5568;
                --text-tertiary: #718096;

                --accent-primary: #d97706;
                --accent-secondary: #f59e0b;
                --accent-gradient: linear-gradient(135deg, #f59e0b, #fbbf24);

                --border-color: #e2e8f0;
                --border-color-hover: #cbd5e0;

                --success: #10b981;
                --success-bg: #d1fae5;
                --warning: #f59e0b;
                --warning-bg: #fef3c7;
                --error: #ef4444;
                --error-bg: #fee2e2;

                --confidence-high: #10b981;
                --confidence-high-bg: rgba(16, 185, 129, 0.15);
                --confidence-medium: #f59e0b;
                --confidence-medium-bg: rgba(245, 158, 11, 0.15);
                --confidence-low: #ef4444;
                --confidence-low-bg: rgba(239, 68, 68, 0.15);

                --popular-badge-bg: linear-gradient(45deg, #f59e0b, #fbbf24);
                --popular-badge-text: #78350f;

                --table-header-bg: rgba(249, 250, 251, 0.9);
                --table-row-hover: rgba(249, 250, 251, 0.5);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        h1 {
            color: var(--accent-primary);
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
            font-weight: 400;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .theme-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .theme-btn.active {
            background: var(--accent-gradient);
            color: var(--popular-badge-text);
            border-color: var(--accent-primary);
        }

        .search-section {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-speed);
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
            margin-bottom: 6px;
        }

        input[type="text"], select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            min-width: 200px;
            transition: all var(--transition-speed);
        }

        input[type="text"]:hover, select:hover {
            border-color: var(--border-color-hover);
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--confidence-medium-bg);
        }

        button {
            padding: 12px 24px;
            background: var(--accent-gradient);
            color: var(--popular-badge-text);
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            font-size: 15px;
            box-shadow: var(--shadow-sm);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            color: var(--accent-primary);
            font-size: 1.2em;
            margin: 20px 0;
            font-weight: 500;
        }

        .error {
            background: var(--error-bg);
            color: var(--error);
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            margin: 16px 0;
            border-left: 4px solid var(--error);
            font-weight: 500;
        }

        .results-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-speed);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-title {
            color: var(--accent-primary);
            font-size: 1.5em;
            font-weight: 700;
        }

        .results-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 8px;
            font-weight: 500;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table th {
            background: var(--table-header-bg);
            color: var(--accent-primary);
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .results-table tr {
            transition: background-color var(--transition-speed);
        }

        .results-table tr:hover {
            background: var(--table-row-hover);
        }

        .price {
            font-weight: 600;
            color: var(--success);
        }

        .confidence {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .confidence-high {
            background: var(--confidence-high-bg);
            color: var(--confidence-high);
        }

        .confidence-medium {
            background: var(--confidence-medium-bg);
            color: var(--confidence-medium);
        }

        .confidence-low {
            background: var(--confidence-low-bg);
            color: var(--confidence-low);
        }

        .popular-badge {
            display: inline-block;
            background: var(--popular-badge-bg);
            color: var(--popular-badge-text);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 700;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .no-results {
            text-align: center;
            color: var(--text-tertiary);
            font-style: italic;
            padding: 40px;
            font-size: 1.1em;
        }

        .favorites-section {
            margin-top: 24px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-speed);
        }

        .favorites-header {
            color: var(--accent-primary);
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-tertiary);
            margin-bottom: 10px;
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--accent-primary);
            transition: all var(--transition-speed);
        }

        .favorite-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .favorite-info {
            flex-grow: 1;
        }

        .favorite-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.05em;
        }

        .favorite-meta {
            font-size: 0.85em;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .favorite-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--error), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-info {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-info:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        @media (max-width: 768px) {
            header {
                margin-bottom: 30px;
            }

            .theme-toggle {
                position: relative;
                width: 100%;
                margin-bottom: 20px;
                justify-content: center;
            }

            .header-text {
                width: 100%;
            }

            h1 {
                font-size: 2em;
            }

            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            input[type="text"], select {
                min-width: unset;
                width: 100%;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-table {
                font-size: 0.85em;
            }

            .results-table th,
            .results-table td {
                padding: 10px 8px;
            }

            .favorite-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .favorite-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="theme-toggle">
                <button class="theme-btn" id="autoTheme" title="Auto (System)">
                    <span>Auto</span>
                </button>
                <button class="theme-btn" id="lightTheme" title="Light Mode">
                    <span>‚òÄÔ∏è</span>
                </button>
                <button class="theme-btn" id="darkTheme" title="Dark Mode">
                    <span>üåô</span>
                </button>
            </div>
            <div class="header-text">
                <h1>Path of Exile Market Helper</h1>
                <p class="subtitle">Live market data from poe.ninja</p>
            </div>
        </header>

        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="itemName">Item Name:</label>
                    <input type="text" id="itemName" placeholder="e.g., Tabula Rasa, Divine Orb, Shaper's Touch" required>
                </div>
                
                <div class="form-group">
                    <label for="league">League:</label>
                    <select id="league">
                        <option value="Crucible">Crucible</option>
                        <option value="Hardcore Crucible">Hardcore Crucible</option>
                        <option value="Standard">Standard</option>
                        <option value="Hardcore">Hardcore</option>
                    </select>
                </div>
                
                <button type="submit" id="searchBtn">Search</button>
                <button type="button" id="favoriteBtn" style="display: none;">Add to Favorites</button>
            </form>
        </section>

        <div id="loading" class="loading" style="display: none;">
            üîç Searching poe.ninja...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Search Results</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="minPrice">-</div>
                    <div class="stat-label">Min Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="medianPrice">-</div>
                    <div class="stat-label">Median Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxPrice">-</div>
                    <div class="stat-label">Max Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalListings">-</div>
                    <div class="stat-label">Total Listings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalVolume">-</div>
                    <div class="stat-label">Volume/Hour</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="averageConfidence">-</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="mostPopular">-</div>
                    <div class="stat-label">Most Popular</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Base Type</th>
                            <th>Value (Adaptive)</th>
                            <th>Listings</th>
                            <th>Volume/Hr</th>
                            <th>Confidence</th>
                            <th>Links</th>
                            <th>Variant</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                No items found matching your search.
            </div>
        </section>

        <section class="favorites-section">
            <div class="favorites-header">
                <span>Favorites</span>
                <button type="button" id="refreshFavoritesBtn" class="btn-small">Refresh All</button>
            </div>
            <div id="favoritesList"></div>
            <div id="noFavorites" class="no-results" style="display: none;">
                No favorites added yet. Search for items and add them to your favorites!
            </div>
        </section>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const itemNameInput = document.getElementById('itemName');
        const leagueSelect = document.getElementById('league');
        const searchBtn = document.getElementById('searchBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsMeta = document.getElementById('resultsMeta');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResults = document.getElementById('noResults');
        const favoritesList = document.getElementById('favoritesList');
        const noFavorites = document.getElementById('noFavorites');
        const refreshFavoritesBtn = document.getElementById('refreshFavoritesBtn');

        // State
        let currentSearchResult = null;
        let favorites = [];

        // Theme Management
        const themeButtons = {
            auto: document.getElementById('autoTheme'),
            light: document.getElementById('lightTheme'),
            dark: document.getElementById('darkTheme')
        };

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
        }

        // Apply theme
        function applyTheme(theme) {
            const root = document.documentElement;

            if (theme === 'auto') {
                root.removeAttribute('data-theme');
            } else {
                root.setAttribute('data-theme', theme);
            }

            // Update button states
            Object.keys(themeButtons).forEach(key => {
                themeButtons[key].classList.toggle('active', key === theme);
            });

            // Save preference
            localStorage.setItem('theme', theme);
        }

        // Theme button event listeners
        themeButtons.auto.addEventListener('click', () => applyTheme('auto'));
        themeButtons.light.addEventListener('click', () => applyTheme('light'));
        themeButtons.dark.addEventListener('click', () => applyTheme('dark'));

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadFavorites();
            loadLeagues();
        });

        // Load leagues dynamically from API
        async function loadLeagues() {
            try {
                const result = await ipcRenderer.invoke('get-leagues');
                if (result.success && result.data.length > 0) {
                    leagueSelect.innerHTML = '';
                    result.data.forEach(league => {
                        const option = document.createElement('option');
                        option.value = league;
                        option.textContent = league;
                        leagueSelect.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Failed to load leagues:', err);
                // Keep default leagues if fetch fails
            }
        }

        // Search form handler
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemName = itemNameInput.value.trim();
            const league = leagueSelect.value;
            
            if (!itemName) {
                showError('Please enter an item name');
                return;
            }

            await searchItem(itemName, league);
        });

        // Add to favorites handler
        favoriteBtn.addEventListener('click', async () => {
            if (!currentSearchResult) return;

            try {
                const itemName = itemNameInput.value.trim();
                const league = leagueSelect.value;
                
                await ipcRenderer.invoke('add-favorite', {
                    name: itemName,
                    league: league
                });

                showSuccess('Added to favorites!');
                favoriteBtn.style.display = 'none';
                await loadFavorites();
            } catch (err) {
                showError(`Failed to add to favorites: ${err.message}`);
            }
        });

        // Refresh favorites handler
        refreshFavoritesBtn.addEventListener('click', async () => {
            refreshFavoritesBtn.disabled = true;
            refreshFavoritesBtn.textContent = 'Refreshing...';
            
            try {
                for (const favorite of favorites) {
                    await searchItem(favorite.name, favorite.league, false);
                }
                showSuccess('All favorites refreshed!');
            } catch (err) {
                showError(`Failed to refresh favorites: ${err.message}`);
            } finally {
                refreshFavoritesBtn.disabled = false;
                refreshFavoritesBtn.textContent = 'Refresh All';
            }
        });

        async function searchItem(itemName, league, showUI = true) {
            try {
                if (showUI) {
                    showLoading();
                    hideError();
                    hideResults();
                }

                searchBtn.disabled = true;
                searchBtn.textContent = 'Searching...';

                const result = await ipcRenderer.invoke('search-item', itemName, league);
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                currentSearchResult = result.data;
                
                if (showUI) {
                    displayResults(result.data);
                    updateFavoriteButton(itemName, league);
                }
            } catch (err) {
                if (showUI) {
                    showError(`Search failed: ${err.message}`);
                }
                console.error('Search error:', err);
            } finally {
                if (showUI) {
                    hideLoading();
                }
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function displayResults(searchResult) {
            const { itemName, league, results, timestamp, minPrice, maxPrice, medianPrice, totalListings,
                    mostPopular, totalVolume, averageConfidence } = searchResult;

            resultsTitle.textContent = `Results for "${itemName}"`;
            resultsMeta.textContent = `League: ${league} | Updated: ${new Date(timestamp).toLocaleString()}`;

            // Update stats
            document.getElementById('minPrice').textContent = minPrice.toFixed(2);
            document.getElementById('medianPrice').textContent = medianPrice.toFixed(2);
            document.getElementById('maxPrice').textContent = maxPrice.toFixed(2);
            document.getElementById('totalListings').textContent = totalListings;

            // Update new economy metrics
            document.getElementById('totalVolume').textContent = totalVolume ? totalVolume.toFixed(1) : '-';

            const confidenceEl = document.getElementById('averageConfidence');
            if (averageConfidence) {
                confidenceEl.innerHTML = formatConfidenceBadge(averageConfidence);
            } else {
                confidenceEl.textContent = '-';
            }

            document.getElementById('mostPopular').textContent = mostPopular
                ? (mostPopular.name.length > 20 ? mostPopular.name.substring(0, 20) + '...' : mostPopular.name)
                : '-';

            // Clear previous results
            resultsTableBody.innerHTML = '';

            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsSection.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';

            // Populate table with enhanced data
            results.forEach(item => {
                const row = document.createElement('tr');
                const adaptiveValue = formatAdaptiveValue(item);
                const volumePerHour = item.volumePerHour ? item.volumePerHour.toFixed(1) : '-';
                const popularBadge = item.isPopular ? '<span class="popular-badge">POPULAR</span>' : '';

                row.innerHTML = `
                    <td>${escapeHtml(item.name)}${popularBadge}</td>
                    <td>${escapeHtml(item.baseType || '-')}</td>
                    <td class="price">${adaptiveValue}</td>
                    <td>${item.listingCount || item.count || '-'}</td>
                    <td>${volumePerHour}</td>
                    <td>${formatConfidenceBadge(item.confidenceLevel || 'medium')}</td>
                    <td>${item.links || '-'}</td>
                    <td>${escapeHtml(item.variant || '-')}</td>
                `;
                resultsTableBody.appendChild(row);
            });

            resultsSection.style.display = 'block';
        }

        // Format adaptive value for display
        function formatAdaptiveValue(item) {
            const chaos = item.chaosValue || 0;
            const divine = item.divineValue || 0;
            const exalted = item.exaltedValue || 0;

            // If item is worth more than 10 divine, display in divine
            if (divine >= 10) {
                return `${divine.toFixed(2)}<span style="color: #ffd700;">d</span>`;
            }

            // If item is worth more than 100 chaos but less than 10 divine, show both
            if (chaos >= 100 && divine > 0) {
                return `${divine.toFixed(2)}<span style="color: #ffd700;">d</span> (${chaos.toFixed(0)}c)`;
            }

            // If exalted value is significant (legacy support)
            if (exalted >= 10) {
                return `${exalted.toFixed(2)}<span style="color: #silver;">ex</span>`;
            }

            // Default to chaos
            return `${chaos.toFixed(2)}<span style="color: #ffd700;">c</span>`;
        }

        // Format confidence badge
        function formatConfidenceBadge(level) {
            if (!level) return '-';
            const levelUpper = level.toUpperCase();
            return `<span class="confidence confidence-${level}">${levelUpper}</span>`;
        }

        async function loadFavorites() {
            try {
                const result = await ipcRenderer.invoke('get-favorites');
                if (result.success) {
                    favorites = result.data;
                    displayFavorites();
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        function displayFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavorites.style.display = 'block';
                return;
            }
            
            noFavorites.style.display = 'none';
            
            favorites.forEach(favorite => {
                const favoriteDiv = document.createElement('div');
                favoriteDiv.className = 'favorite-item';
                
                favoriteDiv.innerHTML = `
                    <div class="favorite-info">
                        <div class="favorite-name">${escapeHtml(favorite.name)}</div>
                        <div class="favorite-meta">
                            League: ${escapeHtml(favorite.league)} | 
                            Added: ${new Date(favorite.addedAt).toLocaleDateString()}
                            ${favorite.lastPrice ? ` | Last Price: ${favorite.lastPrice.toFixed(2)} chaos` : ''}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="btn-small btn-info" onclick="searchFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Search
                        </button>
                        <button class="btn-small btn-danger" onclick="removeFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Remove
                        </button>
                    </div>
                `;
                
                favoritesList.appendChild(favoriteDiv);
            });
        }

        async function searchFavorite(name, league) {
            itemNameInput.value = name;
            leagueSelect.value = league;
            await searchItem(name, league);
        }

        async function removeFavorite(name, league) {
            try {
                await ipcRenderer.invoke('remove-favorite', name);
                showSuccess('Removed from favorites!');
                await loadFavorites();
                updateFavoriteButton(itemNameInput.value.trim(), leagueSelect.value);
            } catch (err) {
                showError(`Failed to remove favorite: ${err.message}`);
            }
        }

        function updateFavoriteButton(itemName, league) {
            const isFavorite = favorites.some(fav => 
                fav.name.toLowerCase() === itemName.toLowerCase() && 
                fav.league === league
            );
            
            favoriteBtn.style.display = currentSearchResult && !isFavorite ? 'inline-block' : 'none';
        }

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'error'; // Reuse error styling
            successDiv.style.background = 'var(--success-bg)';
            successDiv.style.color = 'var(--success)';
            successDiv.style.borderColor = 'var(--success)';
            successDiv.textContent = message;

            error.parentNode.insertBefore(successDiv, error.nextSibling);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-complete functionality (simple implementation)
        const commonItems = [
            'Tabula Rasa', 'Divine Orb', 'Chaos Orb', 'Exalted Orb', 'Ancient Orb',
            'Shaper\'s Touch', 'Goldrim', 'Wanderlust', 'Meginord\'s Girdle',
            'The Baron', 'Belly of the Beast', 'Shavronne\'s Wrappings',
            'Atziri\'s Promise', 'Taste of Hate', 'Dying Sun', 'The Wise Oak'
        ];

        itemNameInput.addEventListener('input', (e) => {
            // Simple auto-suggest could be added here
            // For now, just basic functionality
        });
    </script>
</body>
</html>
