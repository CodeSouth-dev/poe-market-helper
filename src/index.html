<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path of Exile Market Helper</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        h1 {
            color: #ffd700;
            font-size: 1.8em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: #cccccc;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 5px 5px 0 0;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
        }

        .tab:hover {
            background: rgba(255,255,255,0.15);
            color: #ffd700;
        }

        .tab.active {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            border-bottom: 3px solid #ffd700;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Custom scrollbar */
        .tab-content::-webkit-scrollbar {
            width: 8px;
        }

        .tab-content::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background: rgba(255,215,0,0.5);
            border-radius: 10px;
        }

        .tab-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255,215,0,0.7);
        }

        .search-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.9em;
        }

        input[type="text"], input[type="number"], select {
            padding: 8px;
            border: 2px solid #444;
            border-radius: 5px;
            background: rgba(30, 30, 40, 0.95);
            color: #ffffff;
            font-size: 16px;
            min-width: 200px;
        }

        /* Dark mode dropdown options */
        select option {
            background: #1a1a2e;
            color: #ffffff;
            padding: 10px;
        }

        select option:hover,
        select option:focus,
        select option:checked {
            background: #2a2a3e;
            color: #ffd700;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        button {
            padding: 8px 20px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .error {
            background: rgba(255,0,0,0.2);
            color: #ffcccc;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff0000;
        }

        .results-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-title {
            color: #ffd700;
            font-size: 1.5em;
        }

        .results-meta {
            color: #cccccc;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9em;
            color: #cccccc;
            margin-top: 5px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .results-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .results-table tr:hover {
            background: rgba(255,255,255,0.1);
        }

        .price {
            font-weight: bold;
            color: #90EE90;
        }

        .no-results {
            text-align: center;
            color: #cccccc;
            font-style: italic;
            padding: 40px;
        }

        .favorites-section {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .favorites-header {
            color: #ffd700;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .favorite-info {
            flex-grow: 1;
        }

        .favorite-name {
            font-weight: bold;
            color: #ffffff;
        }

        .favorite-meta {
            font-size: 0.8em;
            color: #cccccc;
        }

        .favorite-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4444ff, #0000cc);
            color: white;
        }

        /* Crafting UI Styles */
        .crafting-input-section {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .mod-input-group {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .mod-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #218838);
        }

        .crafting-results {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .method-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .method-card.recommended {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .method-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .method-cost {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ade80;
        }

        .method-description {
            color: #cccccc;
            margin-bottom: 15px;
        }

        .method-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .method-stat {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .method-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .method-stat-label {
            font-size: 0.85em;
            color: #999;
        }

        .crafting-steps {
            list-style: none;
            padding: 0;
        }

        .crafting-steps li {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .recommended-badge {
            background: #ffd700;
            color: #1a1a2e;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .base-recommendation {
            background: rgba(255,215,0,0.1);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .base-rec-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            input[type="text"], select {
                min-width: unset;
                width: 100%;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-table {
                font-size: 0.9em;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }

            .mod-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Path of Exile Market Helper</h1>
            <p class="subtitle">Live market data & crafting helper</p>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="market">Market Search</button>
            <button class="tab" data-tab="insights">Market Insights</button>
            <button class="tab" data-tab="crafting">Crafting Helper</button>
            <button class="tab" data-tab="guide">Learn to Craft</button>
        </div>

        <div id="marketTab" class="tab-content active">
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="itemName">Item Name:</label>
                    <input type="text" id="itemName" placeholder="e.g., Tabula Rasa, Divine Orb, Shaper's Touch" required>
                </div>
                
                <div class="form-group">
                    <label for="league">League:</label>
                    <select id="league">
                        <option value="">Loading leagues...</option>
                    </select>
                </div>
                
                <button type="submit" id="searchBtn">Search</button>
                <button type="button" id="favoriteBtn" style="display: none;">Add to Favorites</button>
            </form>
        </section>

        <div id="loading" class="loading" style="display: none;">
            üîç Searching poe.ninja...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <section id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Search Results</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="minPrice">-</div>
                    <div class="stat-label">Min Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="medianPrice">-</div>
                    <div class="stat-label">Median Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxPrice">-</div>
                    <div class="stat-label">Max Price (Chaos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalListings">-</div>
                    <div class="stat-label">Total Listings</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Base Type</th>
                            <th>Chaos Value</th>
                            <th>Listings</th>
                            <th>Links</th>
                            <th>Variant</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="noResults" class="no-results" style="display: none;">
                No items found matching your search.
            </div>
        </section>

        <section class="favorites-section">
            <div class="favorites-header">
                <span>Favorites</span>
                <button type="button" id="refreshFavoritesBtn" class="btn-small">Refresh All</button>
            </div>
            <div id="favoritesList"></div>
            <div id="noFavorites" class="no-results" style="display: none;">
                No favorites added yet. Search for items and add them to your favorites!
            </div>
        </section>
        </div> <!-- End Market Tab -->

        <div id="insightsTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üìä Market Insights & Profit Opportunities</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label for="insightsLeague">League:</label>
                    <select id="insightsLeague">
                        <option value="">Loading leagues...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currentWealth">üí∞ Current Wealth (Chaos Orbs):</label>
                    <input type="number" id="currentWealth" placeholder="Enter your budget (e.g., 500)" min="0" value="1000" style="width: 100%;">
                    <p style="color: #888; font-size: 11px; margin-top: 3px;">Only show crafts you can afford</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button type="button" id="refreshInsightsBtn" class="btn-success">üîÑ Load Market Data</button>
                <button type="button" id="scrapeBuildsBtn" class="btn-success" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üîç Scrape Builds Data</button>
            </div>

            <div id="buildDataStatus" style="background: rgba(139, 92, 246, 0.15); border: 2px solid #8b5cf6; padding: 12px; margin-bottom: 20px; border-radius: 8px; display: none;">
                <p style="color: #8b5cf6; margin: 0; font-size: 0.9em;">
                    <strong>Build Data:</strong> <span id="buildDataInfo">Not loaded</span>
                </p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="stat-card" style="cursor: pointer;" onclick="showSection('popular')">
                    <div class="stat-value" id="popularCount">0</div>
                    <div class="stat-label">üî• Popular Items</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showSection('profitable')">
                    <div class="stat-value" id="profitableCount">0</div>
                    <div class="stat-label">üí∞ Profitable Crafts</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="showSection('trending')">
                    <div class="stat-value" id="trendingCount">0</div>
                    <div class="stat-label">üìà Trending Items</div>
                </div>
            </div>
        </section>

        <div id="insightsLoading" class="loading" style="display: none;">
            üìä Loading market data...
        </div>

        <div id="insightsError" class="error" style="display: none;"></div>

        <!-- Popular Items Section -->
        <section id="popularSection" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üî• Most Popular Items (High Demand)</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">These items have the highest trading volume and are frequently used in meta builds.</p>
            <div id="popularItemsList"></div>
        </section>

        <!-- Profitable Items Section -->
        <section id="profitableSection" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üí∞ Best Craftable Items for Profit</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">
                <strong>Craftable rare base types</strong> with the best profit margins. These are NOT drop-only uniques like Headhunter or Mageblood - these are items you can actually craft!
            </p>
            <div style="background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <p style="color: #ffd700; margin: 0; font-weight: bold;">‚ÑπÔ∏è How to Use This Data:</p>
                <ul style="color: #cccccc; margin: 10px 0 0 20px;">
                    <li>Check the "Suggested Method" for each item</li>
                    <li>Go to "Crafting Helper" tab to calculate exact costs</li>
                    <li>Compare your craft cost vs the market "Sell Price"</li>
                    <li>Look for High/Medium demand items for faster sales</li>
                </ul>
            </div>
            <div id="profitableItemsList"></div>
        </section>

        <!-- Trending Items Section -->
        <section id="trendingSection" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">üìà Trending Items</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">Items currently in high demand based on value and listing activity.</p>
            <div id="trendingItemsList"></div>
        </section>
        </div> <!-- End Insights Tab -->

        <div id="craftingTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Crafting Helper</h2>

            <!-- Item Paste Area -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px dashed #ffd700; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                <label for="itemPaste" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px;">
                    üìã Paste Item from PoE (Ctrl+C in game):
                </label>
                <textarea
                    id="itemPaste"
                    placeholder="Paste your copied item here... (Copy item from PoE with Ctrl+C)"
                    style="width: 100%; min-height: 100px; background: rgba(30, 30, 40, 0.95); color: #ffffff; border: 2px solid #444; border-radius: 5px; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical;"
                ></textarea>
                <p style="color: #888; font-size: 12px; margin-top: 5px;">Item data will auto-fill the fields below</p>
            </div>

            <form id="craftingForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftBaseItem">Base Item:</label>
                    <input type="text" id="craftBaseItem" placeholder="e.g., Vaal Regalia, Siege Axe, Steel Ring" required>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftItemLevel">Item Level (ilvl):</label>
                    <input type="number" id="craftItemLevel" placeholder="e.g., 86" min="1" max="100">
                    <p style="color: #888; font-size: 12px; margin-top: 5px;">Higher ilvl allows better mods (T1 mods usually require ilvl 82-86)</p>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftItemClass">Item Class:</label>
                    <select id="craftItemClass" required>
                        <option value="">Select Item Class</option>
                        <option value="Body Armour">Body Armour</option>
                        <option value="Helmet">Helmet</option>
                        <option value="Gloves">Gloves</option>
                        <option value="Boots">Boots</option>
                        <option value="Shield">Shield</option>
                        <option value="One Hand Sword">One Hand Sword</option>
                        <option value="Two Hand Sword">Two Hand Sword</option>
                        <option value="One Hand Axe">One Hand Axe</option>
                        <option value="Two Hand Axe">Two Hand Axe</option>
                        <option value="One Hand Mace">One Hand Mace</option>
                        <option value="Two Hand Mace">Two Hand Mace</option>
                        <option value="Bow">Bow</option>
                        <option value="Wand">Wand</option>
                        <option value="Dagger">Dagger</option>
                        <option value="Claw">Claw</option>
                        <option value="Sceptre">Sceptre</option>
                        <option value="Staff">Staff</option>
                        <option value="Ring">Ring</option>
                        <option value="Amulet">Amulet</option>
                        <option value="Belt">Belt</option>
                        <option value="Quiver">Quiver</option>
                        <option value="Jewel">Jewel</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="craftLeague">League:</label>
                    <select id="craftLeague">
                        <option value="">Loading leagues...</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Desired Mods:</label>
                    <div id="modsList"></div>
                    <button type="button" id="addModBtn" class="btn-success" style="margin-top: 10px;">+ Add Mod</button>
                </div>

                <button type="submit" id="calculateBtn">Calculate Best Crafting Method</button>
            </form>
        </section>

        <div id="craftingLoading" class="loading" style="display: none;">
            üîÆ Calculating crafting methods...
        </div>

        <div id="craftingError" class="error" style="display: none;"></div>

        <section id="craftingResults" class="crafting-results" style="display: none;">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Crafting Recommendations</h2>
            <div id="craftingResultsContent"></div>
        </section>
        </div> <!-- End Crafting Tab -->

        <div id="guideTab" class="tab-content">
        <section class="crafting-input-section">
            <h2 style="color: #ffd700; margin-bottom: 20px;">Learn to Craft This Item</h2>
            <p style="color: #cccccc; margin-bottom: 20px;">Paste an item from Path of Exile to get the most cost-effective crafting method!</p>

            <!-- Budget Selection -->
            <div style="margin-bottom: 20px;">
                <label for="craftingBudget" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px;">
                    üí∞ Your Crafting Budget:
                </label>
                <select id="craftingBudget" style="padding: 10px; background: rgba(30,30,40,0.95); color: #fff; border: 2px solid #ffd700; border-radius: 5px; font-size: 14px; width: 100%; max-width: 400px;">
                    <option value="low">Low Budget (1-20 chaos)</option>
                    <option value="medium" selected>Medium Budget (20-100 chaos)</option>
                    <option value="high">High Budget (100-500 chaos)</option>
                    <option value="very-high">Very High Budget (500+ chaos / 2.5+ divine)</option>
                </select>
                <p style="color: #aaa; margin-top: 5px; font-size: 13px;">The guide will recommend crafting methods within your budget.</p>
            </div>

            <!-- Item Paste Area for Guide -->
            <div style="background: rgba(255, 215, 0, 0.1); border: 2px dashed #ffd700; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                <label for="guidePaste" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px;">
                    üìã Paste Your Target Item (Ctrl+C in game):
                </label>
                <textarea
                    id="guidePaste"
                    placeholder="Paste the item you want to learn how to craft... (Copy from PoE with Ctrl+C)"
                    style="width: 100%; min-height: 150px; background: rgba(30, 30, 40, 0.95); color: #ffffff; border: 2px solid #444; border-radius: 5px; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical;"
                ></textarea>
                <button type="button" id="analyzeItemBtn" style="margin-top: 10px;">Analyze Item & Generate Crafting Guide</button>
            </div>

            <!-- Analysis Results -->
            <div id="guideLoading" class="loading" style="display: none;">
                üîç Analyzing item and generating crafting guide...
            </div>

            <div id="guideError" class="error" style="display: none;"></div>

            <section id="guideResults" style="display: none;">
                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">Item Analysis</h3>
                    <div id="guideItemInfo" style="color: #cccccc;"></div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">üìñ Step-by-Step Crafting Guide</h3>
                    <div id="guideCraftingSteps" style="color: #cccccc;"></div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px;">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">üí° Tips & Considerations</h3>
                    <div id="guideTips" style="color: #cccccc;"></div>
                </div>
            </section>
        </section>
        </div> <!-- End Guide Tab -->

    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const itemNameInput = document.getElementById('itemName');
        const leagueSelect = document.getElementById('league');
        const searchBtn = document.getElementById('searchBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsMeta = document.getElementById('resultsMeta');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResults = document.getElementById('noResults');
        const favoritesList = document.getElementById('favoritesList');
        const noFavorites = document.getElementById('noFavorites');
        const refreshFavoritesBtn = document.getElementById('refreshFavoritesBtn');

        // State
        let currentSearchResult = null;
        let favorites = [];

        // Mod Database - Common mods by item class
        const MOD_DATABASE = {
            // Universal mods (work on most items)
            universal: {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1-T5', ilvl: 44 },
                    { name: '+# to maximum Mana', tier: 'T1-T5', ilvl: 2 },
                    { name: '+# to maximum Energy Shield', tier: 'T1-T5', ilvl: 12 },
                    { name: '+# to Strength', tier: 'T1-T5', ilvl: 11 },
                    { name: '+# to Dexterity', tier: 'T1-T5', ilvl: 11 },
                    { name: '+# to Intelligence', tier: 'T1-T5', ilvl: 11 },
                    { name: '+# to all Attributes', tier: 'T1-T3', ilvl: 60 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1-T6', ilvl: 18 },
                    { name: '+#% to Cold Resistance', tier: 'T1-T6', ilvl: 18 },
                    { name: '+#% to Lightning Resistance', tier: 'T1-T6', ilvl: 18 },
                    { name: '+#% to Chaos Resistance', tier: 'T1-T5', ilvl: 16 },
                    { name: '+#% to all Elemental Resistances', tier: 'T1-T3', ilvl: 60 },
                    { name: '#% increased Rarity of Items found', tier: 'T1-T5', ilvl: 20 }
                ]
            },
            'Body Armour': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (100-109)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (175-200)', ilvl: 82 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 },
                    { name: '#% increased Armour', tier: 'T1-T10', ilvl: 11 },
                    { name: '#% increased Evasion Rating', tier: 'T1-T10', ilvl: 11 },
                    { name: '#% increased Energy Shield', tier: 'T1-T10', ilvl: 12 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1-T6', ilvl: 50 },
                    { name: '+# to Level of Socketed Gems', tier: 'T1-T2', ilvl: 50 }
                ],
                suffix: [
                    { name: '+#% to all Elemental Resistances', tier: 'T1 (15-16%)', ilvl: 60 },
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '#% increased Stun and Block Recovery', tier: 'T1-T6', ilvl: 18 }
                ]
            },
            'Helmet': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (90-99)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (110-125)', ilvl: 82 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 },
                    { name: '#% increased Armour', tier: 'T1-T10', ilvl: 11 },
                    { name: 'Nearby Enemies have -#% to Fire Resistance', tier: 'T1-T3', ilvl: 75 },
                    { name: '+# to Level of Socketed Minion Gems', tier: 'T1-T3', ilvl: 50 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to Accuracy Rating', tier: 'T1-T8', ilvl: 20 }
                ]
            },
            'Gloves': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (80-89)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (75-85)', ilvl: 82 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1 (16-19)', ilvl: 74 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to Accuracy Rating', tier: 'T1 (400-450)', ilvl: 74 },
                    { name: '#% increased Attack Speed', tier: 'T1-T6', ilvl: 35 }
                ]
            },
            'Boots': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (80-89)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (60-70)', ilvl: 82 },
                    { name: '+# to Armour', tier: 'T1-T10', ilvl: 35 },
                    { name: '+# to Evasion Rating', tier: 'T1-T10', ilvl: 35 },
                    { name: '#% increased Movement Speed', tier: 'T1 (30-35%)', ilvl: 55 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '#% increased Stun and Block Recovery', tier: 'T1-T6', ilvl: 18 }
                ]
            },
            'Ring': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (70-79)', ilvl: 82 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (60-65)', ilvl: 79 },
                    { name: '+# to maximum Mana', tier: 'T1 (70-75)', ilvl: 80 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1-T8', ilvl: 44 },
                    { name: '#% increased Elemental Damage with Attack Skills', tier: 'T1-T9', ilvl: 4 },
                    { name: 'Curse Enemies with Level # Assassin\'s Mark on Hit', tier: 'T1-T8', ilvl: 38 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to all Attributes', tier: 'T1 (51-55)', ilvl: 85 },
                    { name: '+# to Accuracy Rating', tier: 'T1 (400-450)', ilvl: 74 },
                    { name: '#% increased Rarity of Items found', tier: 'T1-T8', ilvl: 20 }
                ]
            },
            'Amulet': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (70-79)', ilvl: 82 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (55-62)', ilvl: 80 },
                    { name: '#% increased Global Critical Strike Chance', tier: 'T1-T10', ilvl: 20 },
                    { name: '+# to Level of all Skill Gems', tier: 'T1 (+2)', ilvl: 65 },
                    { name: 'Adds # to # Physical Damage to Attacks', tier: 'T1-T8', ilvl: 44 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+# to all Attributes', tier: 'T1 (51-55)', ilvl: 85 },
                    { name: '#% to Global Critical Strike Multiplier', tier: 'T1-T10', ilvl: 20 }
                ]
            },
            'Belt': {
                prefix: [
                    { name: '+# to maximum Life', tier: 'T1 (90-99)', ilvl: 86 },
                    { name: '+# to maximum Energy Shield', tier: 'T1 (50-60)', ilvl: 79 },
                    { name: '#% increased Flask Life Recovery rate', tier: 'T1-T7', ilvl: 16 },
                    { name: '#% increased Flask Mana Recovery rate', tier: 'T1-T7', ilvl: 16 },
                    { name: '#% increased Armour', tier: 'T1-T10', ilvl: 11 }
                ],
                suffix: [
                    { name: '+#% to Fire Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Cold Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '+#% to Lightning Resistance', tier: 'T1 (46-48%)', ilvl: 84 },
                    { name: '#% increased Flask Charges gained', tier: 'T1-T7', ilvl: 8 }
                ]
            },
            'Weapon': {
                prefix: [
                    { name: '+# to Level of Socketed Gems', tier: 'T1 (+2)', ilvl: 55 },
                    { name: 'Adds # to # Physical Damage', tier: 'T1-T10', ilvl: 11 },
                    { name: '#% increased Physical Damage', tier: 'T1-T10', ilvl: 11 },
                    { name: '+# to Accuracy Rating', tier: 'T1 (500-600)', ilvl: 79 },
                    { name: '#% increased Attack Speed', tier: 'T1-T10', ilvl: 2 },
                    { name: '#% increased Critical Strike Chance', tier: 'T1-T10', ilvl: 20 }
                ],
                suffix: [
                    { name: 'Adds # to # Fire Damage', tier: 'T1-T10', ilvl: 2 },
                    { name: 'Adds # to # Cold Damage', tier: 'T1-T10', ilvl: 2 },
                    { name: 'Adds # to # Lightning Damage', tier: 'T1-T10', ilvl: 2 },
                    { name: '+#% to Global Critical Strike Multiplier', tier: 'T1-T10', ilvl: 20 },
                    { name: '#% chance to gain Onslaught on Kill', tier: 'T1-T3', ilvl: 55 }
                ]
            }
        };

        // Get available mods for a specific item class
        function getModsForItemClass(itemClass, modType, itemLevel = 100) {
            if (!itemClass) return [];

            let mods = [];

            // Add universal mods
            if (MOD_DATABASE.universal[modType]) {
                mods = mods.concat(MOD_DATABASE.universal[modType]);
            }

            // Add class-specific mods
            if (MOD_DATABASE[itemClass] && MOD_DATABASE[itemClass][modType]) {
                mods = mods.concat(MOD_DATABASE[itemClass][modType]);
            }

            // For weapon classes, add weapon mods
            if (itemClass.includes('Sword') || itemClass.includes('Axe') ||
                itemClass.includes('Mace') || itemClass.includes('Bow') ||
                itemClass.includes('Wand') || itemClass.includes('Dagger') ||
                itemClass.includes('Claw') || itemClass.includes('Sceptre') ||
                itemClass.includes('Staff')) {
                if (MOD_DATABASE.Weapon[modType]) {
                    mods = mods.concat(MOD_DATABASE.Weapon[modType]);
                }
            }

            // Remove duplicates
            const uniqueMods = Array.from(new Set(mods.map(m => m.name)))
                .map(name => mods.find(m => m.name === name));

            // Filter by item level - only show mods that can roll on this item
            const filteredByLevel = uniqueMods.filter(mod => {
                return itemLevel >= mod.ilvl;
            });

            // Filter out mods that would conflict with current mods
            // Check if we have room for more prefixes/suffixes
            const maxPrefixes = 3;
            const maxSuffixes = 3;

            if (modType === 'prefix' && currentItemMods.count.prefixes >= maxPrefixes) {
                return []; // No room for more prefixes
            }
            if (modType === 'suffix' && currentItemMods.count.suffixes >= maxSuffixes) {
                return []; // No room for more suffixes
            }

            // Filter out mods that are similar to existing mods (same mod group)
            // This is a simplified check - in reality PoE has complex mod groups
            const currentModTexts = [...currentItemMods.prefixes, ...currentItemMods.suffixes];
            const availableMods = filteredByLevel.filter(mod => {
                // Check if a similar mod already exists
                const modBase = mod.name.replace(/[+#%\d\s\-]/g, '').toLowerCase();
                const hasSimilar = currentModTexts.some(currentMod => {
                    const currentModBase = currentMod.replace(/[+#%\d\s\-]/g, '').toLowerCase();
                    return currentModBase.includes(modBase) || modBase.includes(currentModBase);
                });
                return !hasSimilar;
            });

            return availableMods;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
        });

        // Search form handler
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemName = itemNameInput.value.trim();
            const league = leagueSelect.value;
            
            if (!itemName) {
                showError('Please enter an item name');
                return;
            }

            await searchItem(itemName, league);
        });

        // Add to favorites handler
        favoriteBtn.addEventListener('click', async () => {
            if (!currentSearchResult) return;

            try {
                const itemName = itemNameInput.value.trim();
                const league = leagueSelect.value;
                
                await ipcRenderer.invoke('add-favorite', {
                    name: itemName,
                    league: league
                });

                showSuccess('Added to favorites!');
                favoriteBtn.style.display = 'none';
                await loadFavorites();
            } catch (err) {
                showError(`Failed to add to favorites: ${err.message}`);
            }
        });

        // Refresh favorites handler
        refreshFavoritesBtn.addEventListener('click', async () => {
            refreshFavoritesBtn.disabled = true;
            refreshFavoritesBtn.textContent = 'Refreshing...';
            
            try {
                for (const favorite of favorites) {
                    await searchItem(favorite.name, favorite.league, false);
                }
                showSuccess('All favorites refreshed!');
            } catch (err) {
                showError(`Failed to refresh favorites: ${err.message}`);
            } finally {
                refreshFavoritesBtn.disabled = false;
                refreshFavoritesBtn.textContent = 'Refresh All';
            }
        });

        async function searchItem(itemName, league, showUI = true) {
            try {
                if (showUI) {
                    showLoading();
                    hideError();
                    hideResults();
                }

                searchBtn.disabled = true;
                searchBtn.textContent = 'Searching...';

                const result = await ipcRenderer.invoke('search-item', itemName, league);
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                currentSearchResult = result.data;
                
                if (showUI) {
                    displayResults(result.data);
                    updateFavoriteButton(itemName, league);
                }
            } catch (err) {
                if (showUI) {
                    showError(`Search failed: ${err.message}`);
                }
                console.error('Search error:', err);
            } finally {
                if (showUI) {
                    hideLoading();
                }
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function displayResults(searchResult) {
            const { itemName, league, results, timestamp, minPrice, maxPrice, medianPrice, totalListings } = searchResult;
            
            resultsTitle.textContent = `Results for "${itemName}"`;
            resultsMeta.textContent = `League: ${league} | Updated: ${new Date(timestamp).toLocaleString()}`;
            
            // Update stats
            document.getElementById('minPrice').textContent = minPrice.toFixed(2);
            document.getElementById('medianPrice').textContent = medianPrice.toFixed(2);
            document.getElementById('maxPrice').textContent = maxPrice.toFixed(2);
            document.getElementById('totalListings').textContent = totalListings;
            
            // Clear previous results
            resultsTableBody.innerHTML = '';
            
            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsSection.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            // Populate table
            results.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(item.name)}</td>
                    <td>${escapeHtml(item.baseType || '-')}</td>
                    <td class="price">${item.chaosValue.toFixed(2)}</td>
                    <td>${item.listingCount || item.count || '-'}</td>
                    <td>${item.links || '-'}</td>
                    <td>${escapeHtml(item.variant || '-')}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            
            resultsSection.style.display = 'block';
        }

        async function loadFavorites() {
            try {
                const result = await ipcRenderer.invoke('get-favorites');
                if (result.success) {
                    favorites = result.data;
                    displayFavorites();
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        function displayFavorites() {
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavorites.style.display = 'block';
                return;
            }
            
            noFavorites.style.display = 'none';
            
            favorites.forEach(favorite => {
                const favoriteDiv = document.createElement('div');
                favoriteDiv.className = 'favorite-item';
                
                favoriteDiv.innerHTML = `
                    <div class="favorite-info">
                        <div class="favorite-name">${escapeHtml(favorite.name)}</div>
                        <div class="favorite-meta">
                            League: ${escapeHtml(favorite.league)} | 
                            Added: ${new Date(favorite.addedAt).toLocaleDateString()}
                            ${favorite.lastPrice ? ` | Last Price: ${favorite.lastPrice.toFixed(2)} chaos` : ''}
                        </div>
                    </div>
                    <div class="favorite-actions">
                        <button class="btn-small btn-info" onclick="searchFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Search
                        </button>
                        <button class="btn-small btn-danger" onclick="removeFavorite('${escapeHtml(favorite.name)}', '${escapeHtml(favorite.league)}')">
                            Remove
                        </button>
                    </div>
                `;
                
                favoritesList.appendChild(favoriteDiv);
            });
        }

        async function searchFavorite(name, league) {
            itemNameInput.value = name;
            leagueSelect.value = league;
            await searchItem(name, league);
        }

        async function removeFavorite(name, league) {
            try {
                await ipcRenderer.invoke('remove-favorite', name);
                showSuccess('Removed from favorites!');
                await loadFavorites();
                updateFavoriteButton(itemNameInput.value.trim(), leagueSelect.value);
            } catch (err) {
                showError(`Failed to remove favorite: ${err.message}`);
            }
        }

        function updateFavoriteButton(itemName, league) {
            const isFavorite = favorites.some(fav => 
                fav.name.toLowerCase() === itemName.toLowerCase() && 
                fav.league === league
            );
            
            favoriteBtn.style.display = currentSearchResult && !isFavorite ? 'inline-block' : 'none';
        }

        function showLoading() {
            loading.style.display = 'block';
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            error.style.display = 'none';
        }

        function hideResults() {
            resultsSection.style.display = 'none';
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'error'; // Reuse error styling but green
            successDiv.style.background = 'rgba(0,255,0,0.2)';
            successDiv.style.color = '#ccffcc';
            successDiv.style.borderColor = '#00ff00';
            successDiv.textContent = message;
            
            error.parentNode.insertBefore(successDiv, error.nextSibling);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-complete functionality (simple implementation)
        const commonItems = [
            'Tabula Rasa', 'Divine Orb', 'Chaos Orb', 'Exalted Orb', 'Ancient Orb',
            'Shaper\'s Touch', 'Goldrim', 'Wanderlust', 'Meginord\'s Girdle',
            'The Baron', 'Belly of the Beast', 'Shavronne\'s Wrappings',
            'Atziri\'s Promise', 'Taste of Hate', 'Dying Sun', 'The Wise Oak'
        ];

        itemNameInput.addEventListener('input', (e) => {
            // Simple auto-suggest could be added here
            // For now, just basic functionality
        });

        // ===== DYNAMIC LEAGUE LOADING =====
        let availableLeagues = [];

        async function loadLeagues() {
            try {
                const result = await ipcRenderer.invoke('get-leagues');
                if (result.success && result.data.length > 0) {
                    availableLeagues = result.data;
                    updateLeagueSelectors();
                } else {
                    // Fallback
                    availableLeagues = ['Keepers of the Flame', 'Standard', 'Hardcore'];
                    updateLeagueSelectors();
                }
            } catch (error) {
                console.error('Failed to load leagues:', error);
                availableLeagues = ['Keepers of the Flame', 'Standard', 'Hardcore'];
                updateLeagueSelectors();
            }
        }

        function updateLeagueSelectors() {
            const leagueSelectors = [
                document.getElementById('league'),
                document.getElementById('craftLeague'),
                document.getElementById('insightsLeague')
            ];

            leagueSelectors.forEach(selector => {
                if (selector) {
                    const currentValue = selector.value; // Save current selection
                    selector.innerHTML = '';
                    availableLeagues.forEach((league, index) => {
                        const option = document.createElement('option');
                        option.value = league;
                        option.textContent = league;
                        // Set first league (current league) as default if no previous selection
                        if (index === 0 && !currentValue) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                    // Restore previous selection if it still exists
                    if (currentValue && availableLeagues.includes(currentValue)) {
                        selector.value = currentValue;
                    }
                }
            });
        }

        // Load leagues on startup
        loadLeagues();

        // ===== TAB SWITCHING =====
        const tabs = document.querySelectorAll('.tab');
        const marketTab = document.getElementById('marketTab');
        const insightsTab = document.getElementById('insightsTab');
        const craftingTab = document.getElementById('craftingTab');
        const guideTab = document.getElementById('guideTab');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Hide all tab contents
                marketTab.classList.remove('active');
                insightsTab.classList.remove('active');
                craftingTab.classList.remove('active');
                if (guideTab) guideTab.classList.remove('active');

                // Show selected tab
                if (tabName === 'market') {
                    marketTab.classList.add('active');
                } else if (tabName === 'insights') {
                    insightsTab.classList.add('active');
                    // Check for cached data instead of auto-loading
                    checkCachedMarketInsights();
                } else if (tabName === 'crafting') {
                    craftingTab.classList.add('active');
                    initializeCrafting();
                } else if (tabName === 'guide') {
                    if (guideTab) guideTab.classList.add('active');
                }
            });
        });

        // ===== CRAFTING FUNCTIONALITY =====
        let craftingInitialized = false;
        let desiredMods = [];
        let modCounter = 0;

        const craftingForm = document.getElementById('craftingForm');
        const modsList = document.getElementById('modsList');
        const addModBtn = document.getElementById('addModBtn');
        const craftingLoading = document.getElementById('craftingLoading');
        const craftingError = document.getElementById('craftingError');
        const craftingResults = document.getElementById('craftingResults');
        const craftingResultsContent = document.getElementById('craftingResultsContent');

        async function initializeCrafting() {
            if (craftingInitialized) return;

            try {
                const league = document.getElementById('craftLeague').value;
                const result = await ipcRenderer.invoke('initialize-crafting', league);
                if (result.success) {
                    console.log('Crafting data initialized');
                    craftingInitialized = true;
                } else {
                    showCraftingError('Failed to initialize crafting data: ' + result.error);
                }
            } catch (err) {
                console.error('Crafting initialization error:', err);
            }
        }

        function addModInput() {
            const modId = modCounter++;
            const modDiv = document.createElement('div');
            modDiv.className = 'mod-input-group';
            modDiv.setAttribute('data-mod-id', modId);

            // Get current item class and level
            const itemClass = document.getElementById('craftItemClass').value;
            const itemLevel = parseInt(document.getElementById('craftItemLevel').value) || 100;

            modDiv.innerHTML = `
                <div class="mod-inputs">
                    <div class="form-group">
                        <label>Type:</label>
                        <select class="mod-type" data-mod-id="${modId}" required>
                            <option value="">Select Type First</option>
                            <option value="prefix">Prefix (${3 - currentItemMods.count.prefixes} slots)</option>
                            <option value="suffix">Suffix (${3 - currentItemMods.count.suffixes} slots)</option>
                        </select>
                    </div>
                    <div class="form-group" style="position: relative; flex: 2;">
                        <label>Mod Name:</label>
                        <input type="text"
                               class="mod-search"
                               data-mod-id="${modId}"
                               placeholder="Type to search mods..."
                               autocomplete="off"
                               required>
                        <input type="hidden" class="mod-name" data-mod-id="${modId}">
                        <div class="mod-dropdown" data-mod-id="${modId}" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: rgba(30, 30, 40, 0.98); border: 2px solid #ffd700; border-radius: 5px; max-height: 300px; overflow-y: auto; z-index: 1000; margin-top: 5px;"></div>
                    </div>
                    <button type="button" class="btn-danger btn-small" onclick="removeMod(${modId})">Remove</button>
                </div>
            `;
            modsList.appendChild(modDiv);

            // Add event listener to mod type selector
            const modTypeSelect = modDiv.querySelector('.mod-type');
            const modSearchInput = modDiv.querySelector('.mod-search');
            const modNameHidden = modDiv.querySelector('.mod-name');
            const modDropdown = modDiv.querySelector('.mod-dropdown');

            modTypeSelect.addEventListener('change', function() {
                updateSearchableModOptions(modSearchInput, modNameHidden, modDropdown, this.value, itemClass, itemLevel);
            });

            // Setup search functionality
            setupModSearch(modSearchInput, modNameHidden, modDropdown, modTypeSelect, itemClass, itemLevel);
        }

        // Setup searchable mod dropdown
        function setupModSearch(searchInput, hiddenInput, dropdown, typeSelect, itemClass, itemLevel) {
            let allMods = [];
            let selectedModName = '';

            // Focus handler - show dropdown with all available mods
            searchInput.addEventListener('focus', function() {
                const modType = typeSelect.value;
                if (modType) {
                    allMods = getModsForItemClass(itemClass, modType, itemLevel);
                    filterAndShowMods('');
                }
            });

            // Input handler - filter mods as user types
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterAndShowMods(searchTerm);
            });

            // Click outside to close dropdown
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });

            function filterAndShowMods(searchTerm) {
                const filteredMods = allMods.filter(mod =>
                    mod.name.toLowerCase().includes(searchTerm)
                );

                if (filteredMods.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 10px; color: #888;">No mods found</div>';
                    dropdown.style.display = 'block';
                    return;
                }

                dropdown.innerHTML = '';
                filteredMods.forEach(mod => {
                    const modItem = document.createElement('div');
                    modItem.style.cssText = 'padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #444;';
                    modItem.innerHTML = `
                        <div style="color: #ffd700;">${mod.name}</div>
                        <div style="color: #888; font-size: 11px;">${mod.tier}, ilvl ${mod.ilvl}+</div>
                    `;

                    modItem.addEventListener('mouseenter', function() {
                        this.style.background = 'rgba(255, 215, 0, 0.2)';
                    });
                    modItem.addEventListener('mouseleave', function() {
                        this.style.background = 'transparent';
                    });
                    modItem.addEventListener('click', function() {
                        searchInput.value = mod.name;
                        hiddenInput.value = mod.name;
                        selectedModName = mod.name;
                        dropdown.style.display = 'none';
                    });

                    dropdown.appendChild(modItem);
                });

                dropdown.style.display = 'block';
            }
        }

        // Update searchable mod options
        function updateSearchableModOptions(searchInput, hiddenInput, dropdown, modType, itemClass, itemLevel) {
            if (!modType) {
                searchInput.disabled = true;
                searchInput.placeholder = 'Select type first...';
                dropdown.style.display = 'none';
                return;
            }

            searchInput.disabled = false;
            searchInput.placeholder = 'Type to search mods...';
            searchInput.value = '';
            hiddenInput.value = '';

            // Update the slot count in the type dropdown
            const modTypeSelect = searchInput.closest('.mod-input-group').querySelector('.mod-type');
            const prefixOption = modTypeSelect.querySelector('option[value="prefix"]');
            const suffixOption = modTypeSelect.querySelector('option[value="suffix"]');

            if (prefixOption) {
                prefixOption.textContent = `Prefix (${3 - currentItemMods.count.prefixes} slots)`;
            }
            if (suffixOption) {
                suffixOption.textContent = `Suffix (${3 - currentItemMods.count.suffixes} slots)`;
            }
        }

        // Update all mod dropdowns when item class or item level changes
        function updateAllModDropdowns() {
            const itemClass = document.getElementById('craftItemClass').value;
            const itemLevel = parseInt(document.getElementById('craftItemLevel').value) || 100;
            const modInputs = document.querySelectorAll('.mod-input-group');

            modInputs.forEach(modInput => {
                const modTypeSelect = modInput.querySelector('.mod-type');
                const modSearchInput = modInput.querySelector('.mod-search');
                const modNameHidden = modInput.querySelector('.mod-name');
                const modDropdown = modInput.querySelector('.mod-dropdown');

                if (modTypeSelect && modTypeSelect.value && modSearchInput) {
                    updateSearchableModOptions(modSearchInput, modNameHidden, modDropdown, modTypeSelect.value, itemClass, itemLevel);
                }

                // Update slot counts in type selector
                const prefixOption = modTypeSelect.querySelector('option[value="prefix"]');
                const suffixOption = modTypeSelect.querySelector('option[value="suffix"]');

                if (prefixOption) {
                    prefixOption.textContent = `Prefix (${3 - currentItemMods.count.prefixes} slots)`;
                }
                if (suffixOption) {
                    suffixOption.textContent = `Suffix (${3 - currentItemMods.count.suffixes} slots)`;
                }
            });
        }

        // Add event listener to item class and item level selectors
        const craftItemClassSelect = document.getElementById('craftItemClass');
        const craftItemLevelInput = document.getElementById('craftItemLevel');

        if (craftItemClassSelect) {
            craftItemClassSelect.addEventListener('change', updateAllModDropdowns);
        }
        if (craftItemLevelInput) {
            craftItemLevelInput.addEventListener('input', updateAllModDropdowns);
        }

        window.removeMod = function(modId) {
            const modDiv = document.querySelector(`[data-mod-id="${modId}"]`);
            if (modDiv) {
                modDiv.remove();
            }
        };

        // Setup add mod button with proper check
        if (addModBtn) {
            addModBtn.addEventListener('click', addModInput);
        } else {
            console.error('Add Mod button not found');
        }

        // Item paste parser
        const itemPasteArea = document.getElementById('itemPaste');
        if (itemPasteArea) {
            itemPasteArea.addEventListener('input', function() {
                const pastedText = this.value.trim();
                if (!pastedText) return;

                try {
                    const parsedData = parsePoEItem(pastedText);

                    // Auto-fill the form fields
                    if (parsedData.baseName) {
                        document.getElementById('craftBaseItem').value = parsedData.baseName;
                    }

                    if (parsedData.itemLevel) {
                        document.getElementById('craftItemLevel').value = parsedData.itemLevel;
                    }

                    if (parsedData.itemClass) {
                        const itemClassSelect = document.getElementById('craftItemClass');
                        // Try to match the item class
                        let matched = false;
                        for (let option of itemClassSelect.options) {
                            if (option.value.toLowerCase().includes(parsedData.itemClass.toLowerCase()) ||
                                parsedData.itemClass.toLowerCase().includes(option.value.toLowerCase())) {
                                itemClassSelect.value = option.value;
                                matched = true;
                                break;
                            }
                        }

                        // If no match found, log it for debugging
                        if (!matched) {
                            console.log('Could not match item class:', parsedData.itemClass);
                        }
                    }

                    // Trigger change event on item class to update mod dropdowns
                    const itemClassSelect = document.getElementById('craftItemClass');
                    if (itemClassSelect) {
                        itemClassSelect.dispatchEvent(new Event('change'));
                    }

                    // Show current mods if any
                    if (parsedData.currentMods && parsedData.currentMods.length > 0) {
                        console.log('Current mods on item:', parsedData.currentMods);
                        console.log('Available mod slots - Prefixes:', 3 - currentItemMods.count.prefixes, ', Suffixes:', 3 - currentItemMods.count.suffixes);

                        // Show visual feedback about available slots
                        this.style.borderColor = '#00ff00';
                        setTimeout(() => {
                            this.style.borderColor = '#ffd700';
                        }, 1000);
                    }

                    // Visual feedback
                    itemPasteArea.style.borderColor = '#00ff00';
                    setTimeout(() => {
                        itemPasteArea.style.borderColor = '#444';
                    }, 1000);

                } catch (err) {
                    console.error('Error parsing item:', err);
                    itemPasteArea.style.borderColor = '#ff4444';
                    setTimeout(() => {
                        itemPasteArea.style.borderColor = '#444';
                    }, 1000);
                }
            });
        }

        // Parse PoE item text
        function parsePoEItem(itemText) {
            const lines = itemText.split('\n').map(line => line.trim()).filter(line => line);
            const result = {
                baseName: null,
                itemLevel: null,
                itemClass: null,
                rarity: null,
                currentMods: []
            };

            let inModSection = false;
            let pastRequirements = false;
            let foundBaseName = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Parse rarity (first line usually)
                if (line.startsWith('Rarity:')) {
                    result.rarity = line.replace('Rarity:', '').trim();
                }

                // Parse item level
                if (line.match(/Item Level:|ItemLevel:|ilvl:/i)) {
                    const ilvlMatch = line.match(/(\d+)/);
                    if (ilvlMatch) {
                        result.itemLevel = parseInt(ilvlMatch[1]);
                    }
                }

                // For rare/magic items: base name is typically line 3 (after Rarity and item name)
                // For normal items: base name is line 2 (after Rarity)
                if (result.rarity && !foundBaseName) {
                    if (result.rarity.toLowerCase() === 'normal' && i === 1) {
                        result.baseName = line;
                        foundBaseName = true;
                    } else if ((result.rarity.toLowerCase() === 'rare' || result.rarity.toLowerCase() === 'magic') && i === 2) {
                        result.baseName = line;
                        foundBaseName = true;
                    }
                }

                // Check for separator
                if (line === '--------') {
                    if (!inModSection) {
                        inModSection = true;
                    }
                }

                // Try to extract item class from base name or explicit mentions
                // First check if line explicitly states item class
                if (line.match(/^Item Class:/i)) {
                    const classMatch = line.match(/Item Class:\s*(.+)/i);
                    if (classMatch) {
                        result.itemClass = classMatch[1].trim();
                    }
                }

                // Also detect item class from base name patterns
                // Check for explicit class keywords
                if (!result.itemClass) {
                    // Body armours
                    if (line.match(/Regalia|Vestment|Garb|Robe|Brigandine|Raiment|Coat|Chainmail|Plate|Lamellar|Armour|Cuirass|Hauberk/i)) {
                        result.itemClass = 'Body Armour';
                    }
                    // Helmets
                    else if (line.match(/Helmet|Helm|Crown|Hood|Circlet|Tricorne|Burgonet|Sallet|Bascinet/i)) {
                        result.itemClass = 'Helmet';
                    }
                    // Gloves
                    else if (line.match(/Gloves|Gauntlets|Mitts|Mittens/i)) {
                        result.itemClass = 'Gloves';
                    }
                    // Boots
                    else if (line.match(/Boots|Greaves|Slippers/i)) {
                        result.itemClass = 'Boots';
                    }
                    // Shields
                    else if (line.match(/Shield|Buckler/i)) {
                        result.itemClass = 'Shield';
                    }
                    // Rings
                    else if (line.match(/Ring$/i) || line.match(/^Ring\s/i)) {
                        result.itemClass = 'Ring';
                    }
                    // Amulets
                    else if (line.match(/Amulet|Talisman|Pendant/i)) {
                        result.itemClass = 'Amulet';
                    }
                    // Belts
                    else if (line.match(/Belt|Sash|Stygian/i)) {
                        result.itemClass = 'Belt';
                    }
                    // Weapons - Swords
                    else if (line.match(/Sword|Blade|Rapier|Foil|Saber/i)) {
                        if (line.match(/Two Hand|2H/i) || line.match(/Zweihander|Exquisite Blade/i)) {
                            result.itemClass = 'Two Hand Sword';
                        } else {
                            result.itemClass = 'One Hand Sword';
                        }
                    }
                    // Axes
                    else if (line.match(/Axe|Cleaver|Hatchet|Labrys/i)) {
                        if (line.match(/Two Hand|2H|Vaal Axe|Fleshripper/i)) {
                            result.itemClass = 'Two Hand Axe';
                        } else {
                            result.itemClass = 'One Hand Axe';
                        }
                    }
                    // Maces
                    else if (line.match(/Mace|Gavel|Hammer|Pernarch/i)) {
                        if (line.match(/Two Hand|2H|Karui Maul/i)) {
                            result.itemClass = 'Two Hand Mace';
                        } else {
                            result.itemClass = 'One Hand Mace';
                        }
                    }
                    // Bows
                    else if (line.match(/Bow$/i) || line.match(/^.*Bow\s/i)) {
                        result.itemClass = 'Bow';
                    }
                    // Wands
                    else if (line.match(/Wand/i)) {
                        result.itemClass = 'Wand';
                    }
                    // Daggers
                    else if (line.match(/Dagger|Kris|Poignard|Skean/i)) {
                        result.itemClass = 'Dagger';
                    }
                    // Claws
                    else if (line.match(/Claw|Awl/i)) {
                        result.itemClass = 'Claw';
                    }
                    // Sceptres
                    else if (line.match(/Sceptre|Sekhem|Opal Sceptre/i)) {
                        result.itemClass = 'Sceptre';
                    }
                    // Staves
                    else if (line.match(/Staff|Quarterstaff|Lathi/i)) {
                        result.itemClass = 'Staff';
                    }
                    // Quivers
                    else if (line.match(/Quiver/i)) {
                        result.itemClass = 'Quiver';
                    }
                    // Jewels
                    else if (line.match(/Jewel/i)) {
                        result.itemClass = 'Jewel';
                    }
                }

                // Track when we pass the requirements section
                if (line.match(/Requirements?:/i)) {
                    pastRequirements = true;
                }

                // Extract mods (after requirements, between separators)
                if (inModSection && pastRequirements && line !== '--------') {
                    // Mods typically have numbers or percentages
                    // Exclude property lines (Armour, Evasion, Energy Shield, etc.)
                    if (line.match(/[+\-]?\d+/) &&
                        !line.match(/^Requirements?:|^Sockets:|^Item Level:|^Quality:|^Armour:|^Evasion:|^Energy Shield:|^Level:|^Str |^Dex |^Int |^Physical Damage:|^Elemental Damage:|^Chaos Damage:|^Attacks per Second:|^Critical Strike Chance:|^Weapon Range:/i)) {
                        result.currentMods.push(line);
                    }
                }
            }

            // Count prefixes and suffixes (rough estimate based on mod patterns)
            // In PoE, rare items can have up to 3 prefixes and 3 suffixes
            currentItemMods.prefixes = [];
            currentItemMods.suffixes = [];
            result.currentMods.forEach(mod => {
                // Common prefix indicators: life, mana, energy shield, flat damage, attributes
                if (mod.match(/maximum Life|maximum Mana|maximum Energy Shield|to Strength|to Dexterity|to Intelligence|to all Attributes|Adds \d+ to \d+|increased Armour|increased Evasion|Level of|increased Physical Damage|increased Spell Damage/i)) {
                    currentItemMods.prefixes.push(mod);
                } else {
                    // Common suffix indicators: resistances, accuracy, attack speed, cast speed
                    currentItemMods.suffixes.push(mod);
                }
            });

            currentItemMods.count = {
                prefixes: currentItemMods.prefixes.length,
                suffixes: currentItemMods.suffixes.length
            };

            return result;
        }

        // Add initial mod input
        addModInput();

        craftingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const baseItem = document.getElementById('craftBaseItem').value;
            const itemClass = document.getElementById('craftItemClass').value;
            const league = document.getElementById('craftLeague').value;

            // Collect mods
            const modInputs = document.querySelectorAll('.mod-input-group');
            const desiredMods = [];

            modInputs.forEach(modDiv => {
                const name = modDiv.querySelector('.mod-name').value;
                const type = modDiv.querySelector('.mod-type').value;
                if (name) {
                    desiredMods.push({ name, type });
                }
            });

            if (desiredMods.length === 0) {
                showCraftingError('Please add at least one desired mod');
                return;
            }

            // Show loading
            craftingLoading.style.display = 'block';
            craftingError.style.display = 'none';
            craftingResults.style.display = 'none';

            try {
                const result = await ipcRenderer.invoke('calculate-crafting', {
                    desiredMods,
                    baseItemName: baseItem,
                    itemClass,
                    league
                });

                craftingLoading.style.display = 'none';

                if (result.success) {
                    displayCraftingResults(result.data);
                } else {
                    showCraftingError(result.error);
                }
            } catch (err) {
                craftingLoading.style.display = 'none';
                showCraftingError('Calculation failed: ' + err.message);
            }
        });

        function displayCraftingResults(data) {
            craftingResults.style.display = 'block';

            let html = '';

            // Base recommendation
            if (data.baseRecommendation) {
                const base = data.baseRecommendation;
                html += `
                    <div class="base-recommendation">
                        <div class="base-rec-title">üíé Recommended Base</div>
                        <p><strong>Type:</strong> ${base.baseType.toUpperCase()}</p>
                        <p><strong>Item:</strong> ${base.itemName}</p>
                        <p><strong>Cost:</strong> ${formatPrice(base.averageCost, data.preferredCurrency)}</p>
                        <p><strong>Reason:</strong> ${base.reason}</p>
                    </div>
                `;
            }

            // Total cost summary
            html += `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${formatPrice(data.totalCostChaos, data.preferredCurrency)}</div>
                        <div class="stat-label">Total Estimated Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.methods.length}</div>
                        <div class="stat-label">Methods Available</div>
                    </div>
                </div>
            `;

            // Methods
            data.methods.forEach((method, index) => {
                const isRecommended = index === 0;
                html += `
                    <div class="method-card ${isRecommended ? 'recommended' : ''}">
                        <div class="method-header">
                            <div>
                                <span class="method-name">${method.name}</span>
                                ${isRecommended ? '<span class="recommended-badge">‚≠ê RECOMMENDED</span>' : ''}
                            </div>
                            <div class="method-cost">${formatPrice(method.averageCost, data.preferredCurrency)}</div>
                        </div>
                        <div class="method-description">${method.description}</div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${(method.probability * 100).toFixed(2)}%</div>
                                <div class="method-stat-label">Success Rate</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${method.expectedAttempts}</div>
                                <div class="method-stat-label">Avg. Attempts</div>
                            </div>
                        </div>
                        <div>
                            <strong style="color: #ffd700;">Currency Needed:</strong>
                            <ul class="crafting-steps" style="margin-top: 10px;">
                                ${Object.entries(method.currencyUsed).map(([currency, amount]) =>
                                    `<li>${Math.ceil(amount)}x ${currency}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong style="color: #ffd700;">Steps:</strong>
                            <ol class="crafting-steps" style="margin-top: 10px;">
                                ${method.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            });

            craftingResultsContent.innerHTML = html;
        }

        function formatPrice(chaosValue, preferredCurrency = 'chaos') {
            const divinePrice = 200; // This should be fetched from poe.ninja

            if (preferredCurrency === 'divine' || chaosValue >= divinePrice * 2) {
                const divineValue = chaosValue / divinePrice;
                return `${divineValue.toFixed(2)} Divine`;
            }

            return `${chaosValue.toFixed(1)} Chaos`;
        }

        function showCraftingError(message) {
            craftingError.textContent = message;
            craftingError.style.display = 'block';
            setTimeout(() => {
                craftingError.style.display = 'none';
            }, 5000);
        }

        // ===== CRAFTING GUIDE (LEARN TO CRAFT) FUNCTIONALITY =====
        const analyzeItemBtn = document.getElementById('analyzeItemBtn');
        const guidePaste = document.getElementById('guidePaste');
        const guideLoading = document.getElementById('guideLoading');
        const guideError = document.getElementById('guideError');
        const guideResults = document.getElementById('guideResults');
        const guideItemInfo = document.getElementById('guideItemInfo');
        const guideCraftingSteps = document.getElementById('guideCraftingSteps');
        const guideTips = document.getElementById('guideTips');

        if (analyzeItemBtn) {
            analyzeItemBtn.addEventListener('click', function() {
                const itemText = guidePaste.value.trim();

                if (!itemText) {
                    showGuideError('Please paste an item first!');
                    return;
                }

                try {
                    guideLoading.style.display = 'block';
                    guideError.style.display = 'none';
                    guideResults.style.display = 'none';

                    // Parse the item
                    const itemData = parsePoEItem(itemText);
                    const modsOnItem = parseItemMods(itemText);

                    setTimeout(() => {
                        displayCraftingGuide(itemData, modsOnItem, itemText);
                        guideLoading.style.display = 'none';
                        guideResults.style.display = 'block';
                    }, 500);

                } catch (err) {
                    guideLoading.style.display = 'none';
                    showGuideError('Error analyzing item: ' + err.message);
                }
            });
        }

        function parseItemMods(itemText) {
            const lines = itemText.split('\n').map(line => line.trim()).filter(line => line);
            const mods = {
                explicit: [],
                implicit: [],
                crafted: []
            };

            let separatorCount = 0;
            let pastHeader = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Track separators
                if (line === '--------') {
                    separatorCount++;
                    pastHeader = true;
                    continue;
                }

                // Skip non-mod lines
                if (line.startsWith('Rarity:') ||
                    line.startsWith('Item Level:') ||
                    line.match(/^Requirements?:/i) ||
                    line.match(/^Sockets:/i) ||
                    line.match(/^Quality:/i) ||
                    line.match(/^Corrupted$/i) ||
                    line.match(/^Mirrored$/i)) {
                    continue;
                }

                // Skip the item base name (comes right after rarity line)
                if (!pastHeader) continue;

                // Detect mod lines (they usually start with numbers, +, or certain keywords)
                if (line.match(/^\+|^\d|^#|increased|reduced|to maximum|Resistance|Damage|Adds|Additional|Cannot|Regenerate|Leeched|Skills|Accuracy|Critical|Attack Speed|Cast Speed|Movement Speed|Attribute|Armour|Evasion|Energy Shield|Life|Mana/i)) {
                    // Check for crafted mod
                    if (line.includes('(crafted)') || line.includes(' (crafted)')) {
                        mods.crafted.push(line.replace(/\(crafted\)/g, '').trim());
                    }
                    // Check for implicit mod
                    else if (line.includes('(implicit)') || separatorCount === 1) {
                        mods.implicit.push(line.replace(/\(implicit\)/g, '').trim());
                    }
                    // Explicit mods come after first separator
                    else if (separatorCount >= 1) {
                        mods.explicit.push(line);
                    }
                }
            }

            return mods;
        }

        function displayCraftingGuide(itemData, modsOnItem, rawText) {
            // Display item info
            let infoHTML = `
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                    <strong style="color: #ffd700; font-size: 18px;">${itemData.baseName || 'Unknown Item'}</strong><br>
                    <span style="color: #aaa;">Item Level: ${itemData.itemLevel || '?'}</span><br>
                    <span style="color: #aaa;">Item Class: ${itemData.itemClass || 'Unknown'}</span>
                </div>
            `;

            if (modsOnItem.implicit.length > 0) {
                infoHTML += `<div style="margin-bottom: 10px;"><strong style="color: #8888ff;">Implicit Mods:</strong><ul style="margin: 5px 0;">`;
                modsOnItem.implicit.forEach(mod => {
                    infoHTML += `<li style="color: #aaf;">${mod}</li>`;
                });
                infoHTML += `</ul></div>`;
            }

            if (modsOnItem.explicit.length > 0) {
                infoHTML += `<div style="margin-bottom: 10px;"><strong style="color: #88ff88;">Explicit Mods:</strong><ul style="margin: 5px 0;">`;
                modsOnItem.explicit.forEach(mod => {
                    infoHTML += `<li style="color: #afa;">${mod}</li>`;
                });
                infoHTML += `</ul></div>`;
            }

            if (modsOnItem.crafted.length > 0) {
                infoHTML += `<div><strong style="color: #ffaa00;">Crafted Mods:</strong><ul style="margin: 5px 0;">`;
                modsOnItem.crafted.forEach(mod => {
                    infoHTML += `<li style="color: #fa0;">${mod}</li>`;
                });
                infoHTML += `</ul></div>`;
            }

            guideItemInfo.innerHTML = infoHTML;

            // Generate crafting steps based on mods
            let stepsHTML = generateCraftingSteps(itemData, modsOnItem);
            guideCraftingSteps.innerHTML = stepsHTML;

            // Generate tips
            let tipsHTML = generateCraftingTips(itemData, modsOnItem);
            guideTips.innerHTML = tipsHTML;
        }

        function detectVendorRecipes(itemData, modsOnItem) {
            const recipes = [];
            const itemClass = (itemData.itemClass || '').toLowerCase();
            const baseName = (itemData.baseName || '').toLowerCase();

            // Check for weapon types that can use +1 gem recipes
            const isWand = itemClass.includes('wand') || baseName.includes('wand');
            const isSceptre = itemClass.includes('sceptre') || baseName.includes('sceptre');
            const isStaff = itemClass.includes('staff') || baseName.includes('staff');
            const isRuneDagger = itemClass.includes('rune dagger') || baseName.includes('rune dagger');
            const isCasterWeapon = isWand || isSceptre || isStaff || isRuneDagger;

            // Check for gem level mods
            const hasFireGems = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m =>
                m.match(/\+\d+\s+to\s+Level\s+of\s+all\s+Fire\s+.*?Gems/i) ||
                m.match(/\+\d+\s+to\s+Level\s+of\s+.*?Fire\s+Spell/i)
            );
            const hasColdGems = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m =>
                m.match(/\+\d+\s+to\s+Level\s+of\s+all\s+Cold\s+.*?Gems/i) ||
                m.match(/\+\d+\s+to\s+Level\s+of\s+.*?Cold\s+Spell/i)
            );
            const hasLightningGems = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m =>
                m.match(/\+\d+\s+to\s+Level\s+of\s+all\s+Lightning\s+.*?Gems/i) ||
                m.match(/\+\d+\s+to\s+Level\s+of\s+.*?Lightning\s+Spell/i)
            );

            // Caster weapon +1 gem recipes (CORRECT METHOD: 40% quality gems)
            if (isCasterWeapon && (hasFireGems || hasColdGems || hasLightningGems)) {
                const weaponType = isWand ? 'Wand' : isSceptre ? 'Sceptre' : isStaff ? 'Staff' : 'Rune Dagger';

                if (hasFireGems) {
                    recipes.push({
                        name: '+1 to Fire Spell Gems (Vendor Recipe)',
                        items: [
                            `Normal (white) ${weaponType}`,
                            'Fire gems with 40% total quality (any fire spell gems)'
                        ],
                        result: '+1 to Level of all Fire Spell Skill Gems',
                        cost: '~1c (white base + vendor gems with quality)',
                        tip: 'Collect any fire spell gems with quality, when they total 40%+ quality, vendor them with a normal (white) ' + weaponType.toLowerCase(),
                        element: 'fire'
                    });
                }
                if (hasColdGems) {
                    recipes.push({
                        name: '+1 to Cold Spell Gems (Vendor Recipe)',
                        items: [
                            `Normal (white) ${weaponType}`,
                            'Cold gems with 40% total quality (any cold spell gems)'
                        ],
                        result: '+1 to Level of all Cold Spell Skill Gems',
                        cost: '~1c (white base + vendor gems with quality)',
                        tip: 'Collect any cold spell gems with quality, when they total 40%+ quality, vendor them with a normal (white) ' + weaponType.toLowerCase(),
                        element: 'cold'
                    });
                }
                if (hasLightningGems) {
                    recipes.push({
                        name: '+1 to Lightning Spell Gems (Vendor Recipe)',
                        items: [
                            `Normal (white) ${weaponType}`,
                            'Lightning gems with 40% total quality (any lightning spell gems)'
                        ],
                        result: '+1 to Level of all Lightning Spell Skill Gems',
                        cost: '~1c (white base + vendor gems with quality)',
                        tip: 'Collect any lightning spell gems with quality, when they total 40%+ quality, vendor them with a normal (white) ' + weaponType.toLowerCase(),
                        element: 'lightning'
                    });
                }
            }

            return recipes;
        }

        function determineBestCraftingMethod(itemData, modsOnItem, vendorRecipes, budgetMax) {
            const explicitModCount = modsOnItem.explicit.length;
            const itemClass = (itemData.itemClass || '').toLowerCase();
            const isJewelry = itemClass.includes('ring') || itemClass.includes('amulet') || itemClass.includes('belt');

            // Priority order (cheapest first):
            // 1. Vendor Recipe (if applicable) - ~1c
            // 2. Alt-Regal (1-2 mods) - ~5-20c
            // 3. Recombinator (2+ mods) - ~10-40c per attempt
            // 4. Essence (specific mod needed) - ~20-100c
            // 5. Harvest (if available) - ~50-200c
            // 6. Chaos Spam (jewelry only, last resort) - ~100-500c

            // Check vendor recipes first
            if (vendorRecipes.length > 0 && budgetMax >= 1) {
                return { type: 'vendor', data: vendorRecipes[0], cost: 1 };
            }

            // Alt-Regal for simple items (1-2 mods)
            if (explicitModCount <= 2 && budgetMax >= 10) {
                return { type: 'alt-regal', cost: 15 };
            }

            // Recombinator for 2+ mods
            if (explicitModCount >= 2 && budgetMax >= 15) {
                return { type: 'recombinator', cost: 20 };
            }

            // Essence for items needing specific mods
            if (budgetMax >= 30) {
                return { type: 'essence', cost: 50 };
            }

            // Harvest for complex items
            if (budgetMax >= 50) {
                return { type: 'harvest', cost: 100 };
            }

            // Chaos spam only for jewelry with high budget
            if (isJewelry && budgetMax >= 200) {
                return { type: 'chaos', cost: 300 };
            }

            // Default to buy from market
            return { type: 'market', cost: 0 };
        }

        function generateCraftingSteps(itemData, modsOnItem) {
            const explicitModCount = modsOnItem.explicit.length;
            const craftedModCount = modsOnItem.crafted.length;
            const totalModCount = explicitModCount + craftedModCount;
            const itemClass = (itemData.itemClass || '').toLowerCase();
            const isJewelry = itemClass.includes('ring') || itemClass.includes('amulet') || itemClass.includes('belt');

            // Get budget from selector
            const budget = document.getElementById('craftingBudget')?.value || 'medium';
            const budgetMax = {
                'low': 20,
                'medium': 100,
                'high': 500,
                'very-high': 10000
            }[budget];

            const hasLife = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m => m.includes('Life'));
            const hasResists = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m => m.includes('Resistance'));
            const hasES = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m => m.includes('Energy Shield'));

            // Detect applicable vendor recipes
            const vendorRecipes = detectVendorRecipes(itemData, modsOnItem);

            // Determine the CHEAPEST/BEST method
            let bestMethod = determineBestCraftingMethod(itemData, modsOnItem, vendorRecipes, budgetMax);

            let stepsHTML = `<div style="margin-bottom: 20px;">
                <h3 style="color: #ffd700; margin-bottom: 10px;">üí∞ Most Cost-Effective Method (Within Your Budget)</h3>
                <p style="color: #aaa; margin-bottom: 15px;">Based on your budget of ${budgetMax}c and item analysis, here's the CHEAPEST way to craft this:</p>
            </div>`;

            // Method 1: Check market first (ALWAYS recommend this)
            stepsHTML += `<div style="background: rgba(255,215,0,0.1); padding: 15px; border-left: 4px solid #ffd700; margin-bottom: 15px;">
                <h4 style="color: #ffd700; margin: 0 0 10px 0;">‚≠ê Method 1: Buy from Market (CHEAPEST)</h4>
                <ol style="color: #ddd; line-height: 1.8; margin: 0;">
                    <li>Search <strong style="color: #ffd700;">poe.trade</strong> or <strong style="color: #ffd700;">pathofexile.com/trade</strong> for this exact item</li>
                    <li>Look for items with similar mods (at least ${Math.max(2, explicitModCount - 1)} out of ${explicitModCount} mods)</li>
                    <li>Compare prices - if it's less than ${totalModCount * 20}c, BUY IT instead of crafting!</li>
                    <li>You can finish the item with bench crafts or harvest</li>
                </ol>
                <p style="color: #afa; margin: 10px 0 0 0;">‚úÖ <strong>Why this is best:</strong> Someone else already took the RNG risk. Often 10x cheaper than crafting!</p>
            </div>`;

            // Method 2: Vendor Recipes (if applicable)
            if (vendorRecipes.length > 0) {
                vendorRecipes.forEach((recipe, index) => {
                    stepsHTML += `<div style="background: rgba(0,255,127,0.1); padding: 15px; border-left: 4px solid #00ff7f; margin-bottom: 15px;">
                        <h4 style="color: #00ff7f; margin: 0 0 10px 0;">‚≠ê Method 2: Vendor Recipe - ${recipe.name}</h4>
                        <p style="color: #ddd; margin: 0 0 10px 0;"><strong>Recipe:</strong></p>
                        <ul style="color: #ddd; line-height: 1.8; margin: 0 0 10px 0;">
                            ${recipe.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                        <p style="color: #ddd; margin: 0 0 10px 0;"><strong>Result:</strong> ${recipe.result}</p>
                        <p style="color: #ddd; margin: 0 0 10px 0;"><strong>Cost:</strong> ${recipe.cost}</p>
                        <p style="color: #afa; margin: 10px 0 0 0;">‚úÖ <strong>Tip:</strong> ${recipe.tip}</p>
                        <p style="color: #8af; margin: 5px 0 0 0;">üí° <strong>How to use:</strong> Sell all items listed above to ANY vendor at the same time to get the result!</p>
                    </div>`;
                });
            }

            // Method 3: Recombinators (for 2+ explicit mods)
            let methodNum = vendorRecipes.length > 0 ? 3 : 2;
            if (explicitModCount >= 2) {
                stepsHTML += `<div style="background: rgba(138,43,226,0.1); padding: 15px; border-left: 4px solid #8a2be2; margin-bottom: 15px;">
                    <h4 style="color: #8a2be2; margin: 0 0 10px 0;">‚≠ê Method ${methodNum}: Recombinator Method (VERY COST-EFFECTIVE)</h4>
                    <p style="color: #ddd; margin: 0 0 10px 0;"><strong>Overview:</strong> Combine two items of the same base to merge their mods. Available in Kingsmarch.</p>
                    <ol style="color: #ddd; line-height: 1.8; margin: 0;">
                        <li><strong style="color: #ffd700;">Prepare Item 1:</strong> Alt-spam a <strong>${itemData.baseName || 'base'}</strong> (ilvl ${itemData.itemLevel || '82+'}) until you hit <strong>1 desired mod</strong>
                            <ul style="margin-top: 5px;">
                                <li>Cost: ~10-50 Alterations (1-5c total)</li>
                                <li>Regal it to make rare when you hit the mod</li>
                            </ul>
                        </li>
                        <li><strong style="color: #ffd700;">Prepare Item 2:</strong> Alt-spam another <strong>identical base</strong> (same item type!) until you hit a <strong>different desired mod</strong>
                            <ul style="margin-top: 5px;">
                                <li>Cost: ~10-50 Alterations (1-5c total)</li>
                                <li>Regal it as well</li>
                            </ul>
                        </li>
                        <li><strong style="color: #ffd700;">Recombine:</strong> Use the Recombinator in Kingsmarch
                            <ul style="margin-top: 5px;">
                                <li>Costs <strong>Gold + Thaumaturgic Dust</strong> (NOT chaos orbs!)</li>
                                <li>Select which mods you want to keep from each item</li>
                                <li>Success chance varies based on mods selected (fewer mods = higher chance)</li>
                                <li>‚ö†Ô∏è <strong>If it fails, BOTH items are destroyed!</strong></li>
                            </ul>
                        </li>
                        <li><strong style="color: #ffd700;">Repeat if needed:</strong> If recombination fails, craft two new bases and try again</li>
                        <li>Fill remaining affixes with bench crafts or continue recombining more mods</li>
                    </ol>
                    <p style="color: #afa; margin: 10px 0 0 0;">‚úÖ <strong>Why this is best:</strong> Main cost is just alterations (0.1-0.2c each) + base items. Total ~5-20c per attempt, way cheaper than chaos spam!</p>
                    <p style="color: #8af; margin: 5px 0 0 0;">üí° <strong>Pro tip:</strong> Start with 1:1 recombination (1 mod from each item) for best success rate. Can do 2:1 or 3:1 for more mods but lower success.</p>
                    <p style="color: #f88; margin: 5px 0 0 0;">‚ö†Ô∏è <strong>Availability:</strong> Check if Kingsmarch Recombinator is available in current league.</p>
                </div>`;
                methodNum++;
            }

            // Method X: Alt-Regal for simple items
            if (explicitModCount <= 3) {
                stepsHTML += `<div style="background: rgba(0,150,200,0.1); padding: 15px; border-left: 4px solid #0096c8; margin-bottom: 15px;">
                    <h4 style="color: #0096c8; margin: 0 0 10px 0;">Method ${methodNum}: Alt-Regal (For Simple Items)</h4>
                    <ol style="color: #ddd; line-height: 1.8; margin: 0;">
                        <li>Use <strong>Orbs of Alteration</strong> on white base until you hit 1-2 desired mods</li>
                        <li>Use <strong>Orb of Augmentation</strong> to add a 2nd mod if needed</li>
                        <li>Use <strong>Regal Orb</strong> to make it rare (adds 1 random mod)</li>
                        <li>Finish with crafting bench for missing mods</li>
                    </ol>
                    <p style="color: #ddd; margin: 10px 0 0 0;">üí∞ <strong>Cost:</strong> ~20-100 Alterations + 1 Regal = ~5-20 chaos total</p>
                </div>`;
                methodNum++;
            }

            // Method X: Essence crafting (for guaranteed mods)
            stepsHTML += `<div style="background: rgba(200,100,0,0.1); padding: 15px; border-left: 4px solid #c86400; margin-bottom: 15px;">
                <h4 style="color: #c86400; margin: 0 0 10px 0;">Method ${methodNum}: Essence Crafting (Guaranteed Mods)</h4>
                <ol style="color: #ddd; line-height: 1.8; margin: 0;">
                    <li>Find the <strong>Essence</strong> that gives you the most important mod (e.g., Essence of Greed for Life)</li>
                    <li>Spam the essence on your base until you hit 1-2 additional desired mods</li>
                    <li>Finish with bench crafts or Harvest</li>
                </ol>
                <p style="color: #ddd; margin: 10px 0 0 0;">üí∞ <strong>Cost:</strong> Depends on essence tier. High-tier essences can be 5-20c each</p>
                <p style="color: #afa; margin: 5px 0 0 0;">‚úÖ <strong>Good for:</strong> Items where you need one specific high-tier mod guaranteed</p>
            </div>`;
            methodNum++;

            // Method X: Harvest Reforge (if available)
            stepsHTML += `<div style="background: rgba(100,200,100,0.1); padding: 15px; border-left: 4px solid #64c864; margin-bottom: 15px;">
                <h4 style="color: #64c864; margin: 0 0 10px 0;">Method ${methodNum}: Harvest Reforge (If Available)</h4>
                <ol style="color: #ddd; line-height: 1.8; margin: 0;">
                    <li>Get a base with any mods (doesn't matter what)</li>
                    <li>Use <strong>Harvest "Reforge with [type] mods"</strong> crafts:`;

            if (hasLife) stepsHTML += `<br><span style="color: #f88;">‚Ä¢ "Reforge with Life mods" for life builds</span>`;
            if (hasResists) stepsHTML += `<br><span style="color: #88f;">‚Ä¢ "Reforge with Cold/Fire/Lightning" for resists</span>`;
            if (hasES) stepsHTML += `<br><span style="color: #8af;">‚Ä¢ "Reforge with Caster mods" for ES</span>`;

            stepsHTML += `</li>
                    <li>Repeat until you hit 2+ desired mods, then bench craft or continue</li>
                </ol>
                <p style="color: #ddd; margin: 10px 0 0 0;">üí∞ <strong>Cost:</strong> Harvest crafts vary. "Reforge more common" can be 10-50c</p>
            </div>`;
            methodNum++;

            // Method X: Chaos spam (only show in specific situations)
            // Only recommend chaos spam for jewelry or when other methods aren't viable
            // Note: itemClass already declared at top of function
            const isInfluenced = [...modsOnItem.explicit, ...modsOnItem.crafted].some(m =>
                m.includes('Shaper') || m.includes('Elder') || m.includes('Crusader') ||
                m.includes('Hunter') || m.includes('Warlord') || m.includes('Redeemer')
            );
            const showChaosSplam = (isJewelry && explicitModCount >= 4) || (isInfluenced && explicitModCount >= 5);

            if (showChaosSplam) {
                stepsHTML += `<div style="background: rgba(200,0,0,0.1); padding: 15px; border-left: 4px solid #c80000; margin-bottom: 15px;">
                    <h4 style="color: #f88; margin: 0 0 10px 0;">Method ${methodNum}: Chaos Spam (USE WITH CAUTION)</h4>
                    <ol style="color: #ddd; line-height: 1.8; margin: 0;">
                        <li>Spam <strong>Chaos Orbs</strong> on the item until you hit 2-3 desired mods</li>
                        <li>Finish with bench craft or harvest</li>
                    </ol>
                    <p style="color: #ffa; margin: 10px 0 0 0;">‚ö†Ô∏è <strong>When to use:</strong> ${isJewelry ? 'Jewelry has smaller mod pools, making chaos spam more viable than on armor/weapons.' : 'Influenced items with many mods where other methods are difficult.'}</p>
                    <p style="color: #f88; margin: 5px 0 0 0;">‚ùå <strong>Cost Warning:</strong> Expect to use 100-500+ chaos orbs. ONLY do this in late league or if you're wealthy!</p>
                    <p style="color: #ddd; margin: 5px 0 0 0;">üí° <strong>Better alternative:</strong> Buy from market or use Harvest/Essence crafting instead!</p>
                </div>`;
            }

            // Bench crafts section
            if (craftedModCount > 0) {
                stepsHTML += `<div style="background: rgba(255,170,0,0.15); padding: 15px; border-left: 4px solid #ffa500; margin-top: 20px;">
                    <h4 style="color: #ffa500; margin: 0 0 10px 0;">üîß This Item Has ${craftedModCount} Bench Craft(s)</h4>
                    <p style="color: #ddd; margin: 0;">The orange "Crafted Mods" you see can be added at your <strong>Hideout Crafting Bench</strong>.</p>
                    <p style="color: #afa; margin: 10px 0 0 0;">‚úÖ You only need to craft the ${explicitModCount} explicit (green) mods, then add bench crafts at the end!</p>
                </div>`;
            }

            return stepsHTML;
        }

        function generateCraftingTips(itemData, modsOnItem) {
            const explicitModCount = modsOnItem.explicit.length;
            const craftedModCount = modsOnItem.crafted.length;

            let tipsHTML = `<h3 style="color: #ffd700; margin-bottom: 10px;">üí° Pro Crafting Tips</h3>
                <ul style="color: #ddd; line-height: 1.8;">`;

            // Market check tip
            tipsHTML += `<li>üõí <strong>ALWAYS Check Trade First:</strong> Search <a href="https://www.pathofexile.com/trade" target="_blank" style="color: #ffd700;">pathofexile.com/trade</a> before crafting. You can often buy similar items for 1/10th the crafting cost!</li>`;

            // Currency efficiency tip
            tipsHTML += `<li>üí∞ <strong>Currency Efficiency:</strong>
                <ul style="margin-top: 5px;">
                    <li><strong style="color: #afa;">Alterations = 0.1-0.2c</strong> (super cheap!)</li>
                    <li><strong style="color: #ffa;">Chaos = 1c</strong> (5-10x more expensive)</li>
                    <li><strong style="color: #f88;">High-tier Essence = 5-20c</strong> (expensive, but guarantees mod)</li>
                </ul>
            </li>`;

            // Recombinator tip
            if (explicitModCount >= 2) {
                tipsHTML += `<li>üîÆ <strong>Recombinator Strategy:</strong> If Kingsmarch is available, this is THE most cost-effective method! Prepare two bases with desired mods using cheap alterations, then recombine. Costs Gold+Thaumaturgic Dust (NOT chaos orbs). Even with risk of failure, way cheaper than chaos spam!</li>`;
            }

            // RNG warning
            tipsHTML += `<li>üé≤ <strong>RNG Warning:</strong> Crafting is gambling! Set a budget before you start and STOP if you hit it. Don't spend your last chaos!</li>`;

            // Resource links
            tipsHTML += `<li>üìä <strong>Essential Crafting Resources:</strong>
                <ul style="margin-top: 5px;">
                    <li><a href="https://www.craftofexile.com" target="_blank" style="color: #ffd700;">Craft of Exile</a> - Calculate exact probabilities for crafting methods</li>
                    <li><a href="https://poedb.tw/us/mod.php" target="_blank" style="color: #ffd700;">PoEDB Mods Database</a> - Look up all mods, tiers, and ilvl requirements</li>
                    <li><a href="https://www.pathofexile.com/trade" target="_blank" style="color: #ffd700;">Official Trade Site</a> - Always check market prices first!</li>
                    <li><a href="https://poedb.tw/us/Crafting_Bench" target="_blank" style="color: #ffd700;">Crafting Bench Mods</a> - All available bench crafts</li>
                </ul>
            </li>`;

            // ilvl specific tips
            if (itemData.itemLevel && itemData.itemLevel >= 86) {
                tipsHTML += `<li>‚ú® <strong>Excellent ilvl!</strong> Your ilvl ${itemData.itemLevel} base can roll T1 mods on all item slots. This is perfect for endgame crafting!</li>`;
            } else if (itemData.itemLevel && itemData.itemLevel >= 82) {
                tipsHTML += `<li>‚úÖ <strong>Good ilvl!</strong> Your ilvl ${itemData.itemLevel} base can roll most T1 mods. Some slots need ilvl 86 for T1, but this is solid!</li>`;
            } else if (itemData.itemLevel && itemData.itemLevel >= 75) {
                tipsHTML += `<li>‚ö†Ô∏è <strong>Medium ilvl:</strong> ilvl ${itemData.itemLevel} can roll T2-T3 mods. You won't get T1 mods (need 82-86), but it's fine for budget items!</li>`;
            } else if (itemData.itemLevel && itemData.itemLevel < 75) {
                tipsHTML += `<li>‚ùå <strong>Low ilvl:</strong> ilvl ${itemData.itemLevel} is too low for endgame crafting. You need ilvl 82+ for T1 mods, 75+ for T2 mods.</li>`;
            }

            // Complexity warning
            if (explicitModCount >= 5) {
                tipsHTML += `<li>üéØ <strong>Very Complex Item:</strong> ${explicitModCount} explicit mods = very expensive to craft (easily 100+ chaos). Strongly recommend buying from market instead!</li>`;
            } else if (explicitModCount >= 3) {
                tipsHTML += `<li>üéØ <strong>Moderate Complexity:</strong> ${explicitModCount} mods will cost ~30-100c to craft depending on method. Compare with market prices!</li>`;
            } else {
                tipsHTML += `<li>‚úÖ <strong>Simple Item:</strong> ${explicitModCount} mods is easy to craft! Alt-spam or recombinators should be very affordable (~10-30c).</li>`;
            }

            // Bench craft info
            if (craftedModCount > 0) {
                tipsHTML += `<li>üîß <strong>Bench Crafts are FREE:</strong> The ${craftedModCount} crafted mod(s) can be added at your hideout bench for just a few chaos. Focus on getting the explicit mods first!</li>`;
            }

            // League economy tip
            tipsHTML += `<li>‚è∞ <strong>League Timing Matters:</strong>
                <ul style="margin-top: 5px;">
                    <li><strong>Early League (Week 1-2):</strong> Chaos orbs are expensive. Use alterations + recombinators!</li>
                    <li><strong>Mid League:</strong> More options available, prices stabilize</li>
                    <li><strong>Late League:</strong> Currency is cheap, market has lots of items to buy</li>
                </ul>
            </li>`;

            // Final tip
            tipsHTML += `<li>üéì <strong>Learn by Doing:</strong> Start with cheap bases and simple items. As you learn, you'll waste less currency and get better results!</li>`;

            tipsHTML += `</ul>`;

            return tipsHTML;
        }

        function showGuideError(message) {
            guideError.textContent = message;
            guideError.style.display = 'block';
            setTimeout(() => {
                guideError.style.display = 'none';
            }, 5000);
        }

        // ===== MARKET INSIGHTS FUNCTIONALITY =====
        let insightsData = {
            popular: [],
            profitable: [],
            trending: []
        };

        const insightsLoading = document.getElementById('insightsLoading');
        const insightsError = document.getElementById('insightsError');
        const refreshInsightsBtn = document.getElementById('refreshInsightsBtn');

        async function loadMarketInsights() {
            const league = document.getElementById('insightsLeague').value;
            if (!league) return;

            insightsLoading.style.display = 'block';
            insightsError.style.display = 'none';

            // Hide all sections
            document.getElementById('popularSection').style.display = 'none';
            document.getElementById('profitableSection').style.display = 'none';
            document.getElementById('trendingSection').style.display = 'none';

            try {
                // Use new cached endpoint
                const result = await ipcRenderer.invoke('load-market-insights', league);

                if (result.success) {
                    const data = result.data;
                    insightsData.popular = data.popular;
                    insightsData.profitable = data.profitable;
                    insightsData.trending = data.trending;

                    document.getElementById('popularCount').textContent = insightsData.popular.length;
                    document.getElementById('profitableCount').textContent = insightsData.profitable.length;
                    document.getElementById('trendingCount').textContent = insightsData.trending.length;

                    insightsLoading.style.display = 'none';

                    // Show first section by default
                    showSection('popular');
                } else {
                    insightsLoading.style.display = 'none';
                    showInsightsError('Failed to load market data: ' + result.error);
                }
            } catch (error) {
                insightsLoading.style.display = 'none';
                showInsightsError('Failed to load market data: ' + error.message);
            }
        }

        // Check for cached market insights on tab switch
        async function checkCachedMarketInsights() {
            const league = document.getElementById('insightsLeague').value;
            if (!league) return;

            try {
                const result = await ipcRenderer.invoke('get-cached-market-insights', league);
                if (result.success) {
                    const data = result.data;
                    insightsData.popular = data.popular;
                    insightsData.profitable = data.profitable;
                    insightsData.trending = data.trending;

                    document.getElementById('popularCount').textContent = insightsData.popular.length;
                    document.getElementById('profitableCount').textContent = insightsData.profitable.length;
                    document.getElementById('trendingCount').textContent = insightsData.trending.length;

                    // Show first section if we have cached data
                    showSection('popular');
                }
            } catch (error) {
                console.log('No cached market insights available');
            }
        }

        window.showSection = function(section) {
            // Hide all sections
            document.getElementById('popularSection').style.display = 'none';
            document.getElementById('profitableSection').style.display = 'none';
            document.getElementById('trendingSection').style.display = 'none';

            // Show selected section
            if (section === 'popular') {
                document.getElementById('popularSection').style.display = 'block';
                displayPopularItems();
            } else if (section === 'profitable') {
                document.getElementById('profitableSection').style.display = 'block';
                displayProfitableItems();
            } else if (section === 'trending') {
                document.getElementById('trendingSection').style.display = 'block';
                displayTrendingItems();
            }
        };

        function displayPopularItems() {
            const container = document.getElementById('popularItemsList');
            if (insightsData.popular.length === 0) {
                container.innerHTML = '<p>No data available</p>';
                return;
            }

            let html = '';
            insightsData.popular.forEach((item, index) => {
                const formattedPrice = formatPriceForDisplay(item.chaosValue);
                const readableBaseType = formatBaseType(item.baseType || item.name);

                html += `
                    <div class="method-card">
                        <div class="method-header">
                            <div>
                                <span class="method-name">#${index + 1} ${item.name}</span>
                                ${item.variant ? `<span style="color: #999; margin-left: 10px;">${item.variant}</span>` : ''}
                            </div>
                            <div class="method-cost">${formattedPrice}</div>
                        </div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${item.listingCount || 0}</div>
                                <div class="method-stat-label">Listings</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${readableBaseType}</div>
                                <div class="method-stat-label">Type</div>
                            </div>
                            ${item.links ? `
                            <div class="method-stat">
                                <div class="method-stat-value">${item.links}L</div>
                                <div class="method-stat-label">Links</div>
                            </div>
                            ` : ''}
                        </div>
                        <p style="color: #4ade80; margin-top: 10px;">
                            üí° High demand item - Good for trading and crafting for profit
                        </p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayProfitableItems() {
            const container = document.getElementById('profitableItemsList');
            if (insightsData.profitable.length === 0) {
                container.innerHTML = '<p style="color: #cccccc; padding: 20px;">No craftable items found. Try refreshing or selecting a different league.</p>';
                return;
            }

            // Get current wealth filter
            const currentWealthInput = document.getElementById('currentWealth');
            const currentWealth = currentWealthInput ? parseFloat(currentWealthInput.value) || Infinity : Infinity;

            // Filter items by wealth
            let filteredItems = insightsData.profitable;
            let showingFiltered = false;

            if (currentWealth !== Infinity) {
                filteredItems = insightsData.profitable.filter(buildItem => {
                    const estimatedCraftCost = buildItem.craftingStrategy.estimatedCost;
                    return estimatedCraftCost <= currentWealth;
                });
                showingFiltered = true;
            }

            // Show filter info
            let filterInfoHtml = '';
            if (showingFiltered) {
                const affordableCount = filteredItems.length;
                const totalCount = insightsData.profitable.length;
                filterInfoHtml = `
                    <div style="background: rgba(74, 222, 128, 0.15); border: 2px solid #4ade80; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                        <p style="color: #4ade80; margin: 0; font-weight: bold;">
                            üí∞ Budget Filter Active: ${formatPriceForDisplay(currentWealth)} available
                        </p>
                        <p style="color: #cccccc; margin: 5px 0 0 0;">
                            Showing ${affordableCount} of ${totalCount} craftable items within your budget
                        </p>
                    </div>
                `;
            }

            if (filteredItems.length === 0) {
                container.innerHTML = filterInfoHtml + '<p style="color: #cccccc; padding: 20px;">No craftable items found within your budget. Try increasing your wealth or refreshing data.</p>';
                return;
            }

            let html = filterInfoHtml;
            filteredItems.forEach((buildItem, index) => {
                const sellPrice = buildItem.chaosValue;
                const estimatedCraftCost = buildItem.craftingStrategy.estimatedCost;
                const profitMargin = sellPrice - estimatedCraftCost;
                const profitPercent = ((profitMargin / sellPrice) * 100).toFixed(1);
                const roi = ((profitMargin / estimatedCraftCost) * 100).toFixed(0);

                const formattedSellPrice = formatPriceForDisplay(sellPrice);
                const formattedProfit = formatPriceForDisplay(profitMargin);
                const formattedCraftCost = formatPriceForDisplay(estimatedCraftCost);

                // Determine affordability status
                const isAffordable = estimatedCraftCost <= currentWealth;
                const affordabilityBadge = isAffordable
                    ? '<span style="background: rgba(74, 222, 128, 0.2); color: #4ade80; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">‚úì Affordable</span>'
                    : '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">‚ö† Over Budget</span>';

                // Difficulty color
                const difficultyColors = {
                    'Easy': '#4ade80',
                    'Medium': '#facc15',
                    'Hard': '#fb923c',
                    'Very Hard': '#ef4444'
                };
                const difficultyColor = difficultyColors[buildItem.craftingStrategy.difficulty] || '#888';

                // Build mods display
                const modsHtml = buildItem.mods.explicit.slice(0, 5).map(mod =>
                    `<div style="color: #8b5cf6; font-size: 0.85em; margin: 3px 0;">‚Ä¢ ${mod}</div>`
                ).join('');

                // Build crafting steps
                const stepsHtml = buildItem.craftingStrategy.steps.map(step =>
                    `<div style="color: #cccccc; font-size: 0.9em; margin: 8px 0; padding-left: 10px;">${step}</div>`
                ).join('');

                html += `
                    <div class="method-card" style="${!isAffordable ? 'opacity: 0.6;' : ''}">
                        <div class="method-header">
                            <div>
                                <span class="method-name">#${index + 1} ${buildItem.name}</span>
                                <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">
                                    ${buildItem.itemClass}
                                </span>
                                ${affordabilityBadge}
                            </div>
                            <div class="method-cost">${formattedProfit} Profit</div>
                        </div>

                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value" style="color: #ffd700;">${formattedCraftCost}</div>
                                <div class="method-stat-label">Est. Craft Cost</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${formattedSellPrice}</div>
                                <div class="method-stat-label">Sell Price</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value" style="color: ${difficultyColor};">${buildItem.craftingStrategy.difficulty}</div>
                                <div class="method-stat-label">Difficulty</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${buildItem.craftingStrategy.successRate}</div>
                                <div class="method-stat-label">Success Rate</div>
                            </div>
                        </div>

                        <div style="margin-top: 15px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-left: 3px solid #8b5cf6; border-radius: 5px;">
                            <p style="color: #8b5cf6; margin: 0 0 8px 0; font-weight: bold;">üìú Example Mods (Target)</p>
                            ${modsHtml}
                            ${buildItem.mods.explicit.length > 5 ? '<div style="color: #888; font-size: 0.85em; margin-top: 3px;">...and more</div>' : ''}
                        </div>

                        <div style="margin-top: 15px; padding: 12px; background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; border-radius: 5px;">
                            <p style="color: #ffd700; margin: 0 0 8px 0; font-weight: bold;">üî® Crafting Method: ${buildItem.craftingStrategy.method}</p>
                            ${stepsHtml}
                        </div>

                        <div style="margin-top: 15px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-left: 3px solid #4ade80; border-radius: 5px;">
                            <p style="color: #4ade80; margin: 0;">
                                üí∞ <strong>Profit:</strong> ${formattedProfit} (${profitPercent}%) ‚Ä¢ <strong>ROI:</strong> ${roi}%
                            </p>
                            <p style="color: #cccccc; margin: 5px 0 0 0; font-size: 0.9em;">
                                ${buildItem.baseType} ‚Ä¢ ${buildItem.listingCount} listings on market
                            </p>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function displayTrendingItems() {
            const container = document.getElementById('trendingItemsList');
            if (insightsData.trending.length === 0) {
                container.innerHTML = '<p>No data available</p>';
                return;
            }

            let html = '';
            insightsData.trending.forEach((item, index) => {
                const formattedPrice = formatPriceForDisplay(item.chaosValue);
                const readableBaseType = formatBaseType(item.baseType || item.name);

                html += `
                    <div class="method-card">
                        <div class="method-header">
                            <div>
                                <span class="method-name">#${index + 1} ${item.name}</span>
                                ${item.variant ? `<span style="color: #999; margin-left: 10px;">${item.variant}</span>` : ''}
                            </div>
                            <div class="method-cost">${formattedPrice}</div>
                        </div>
                        <div class="method-stats">
                            <div class="method-stat">
                                <div class="method-stat-value">${item.listingCount || 0}</div>
                                <div class="method-stat-label">Listings</div>
                            </div>
                            <div class="method-stat">
                                <div class="method-stat-value">${readableBaseType}</div>
                                <div class="method-stat-label">Type</div>
                            </div>
                        </div>
                        <p style="color: #ffd700; margin-top: 10px;">
                            üìà Trending - High value and activity
                        </p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Helper function to format prices (Chaos vs Divine)
        function formatPriceForDisplay(chaosValue) {
            const divinePrice = 200; // Approximate Divine Orb price in Chaos

            if (chaosValue >= divinePrice) {
                const divineValue = (chaosValue / divinePrice).toFixed(2);
                return `${divineValue} Divine`;
            } else if (chaosValue >= 10) {
                return `${Math.round(chaosValue)} Chaos`;
            } else {
                return `${chaosValue.toFixed(1)} Chaos`;
            }
        }

        // Helper function to format base type names for readability
        function formatBaseType(baseType) {
            if (!baseType || baseType === 'N/A') return 'Base Item';

            // Remove common prefixes that make names too long
            let formatted = baseType
                .replace(/^(Metadata\/Items\/)/i, '')
                .replace(/^(Currency\/)/i, '')
                .replace(/^(UniqueItems\/)/i, '');

            // Handle camelCase and PascalCase - add spaces
            formatted = formatted.replace(/([a-z])([A-Z])/g, '$1 $2');

            // Handle underscores
            formatted = formatted.replace(/_/g, ' ');

            // Capitalize first letter of each word
            formatted = formatted.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            // Truncate if too long
            if (formatted.length > 25) {
                formatted = formatted.substring(0, 22) + '...';
            }

            return formatted;
        }

        // Setup refresh button with null check
        if (refreshInsightsBtn) {
            refreshInsightsBtn.addEventListener('click', loadMarketInsights);
        } else {
            console.error('Refresh insights button not found');
        }

        // Setup scrape builds button
        const scrapeBuildsBtn = document.getElementById('scrapeBuildsBtn');
        const buildDataStatus = document.getElementById('buildDataStatus');
        const buildDataInfo = document.getElementById('buildDataInfo');

        if (scrapeBuildsBtn) {
            scrapeBuildsBtn.addEventListener('click', async () => {
                const league = document.getElementById('insightsLeague').value;
                if (!league) {
                    showInsightsError('Please select a league first');
                    return;
                }

                // Show loading state
                scrapeBuildsBtn.disabled = true;
                scrapeBuildsBtn.textContent = '‚è≥ Scraping builds...';
                buildDataStatus.style.display = 'block';
                buildDataInfo.textContent = 'Scraping data from poe.ninja/builds...';

                try {
                    const result = await ipcRenderer.invoke('scrape-builds', league);

                    if (result.success) {
                        const data = result.data;
                        const timestamp = new Date(result.timestamp);
                        const timeStr = timestamp.toLocaleTimeString();

                        buildDataInfo.textContent = `Loaded ${data.totalBuilds} builds at ${timeStr}`;
                        buildDataInfo.style.color = '#4ade80';

                        console.log('Build data scraped:', data);

                        // Optionally reload market data to incorporate build info
                        await loadMarketInsights();
                    } else {
                        buildDataInfo.textContent = `Failed: ${result.error}`;
                        buildDataInfo.style.color = '#ef4444';
                        showInsightsError('Failed to scrape builds: ' + result.error);
                    }
                } catch (error) {
                    buildDataInfo.textContent = `Error: ${error.message}`;
                    buildDataInfo.style.color = '#ef4444';
                    showInsightsError('Error scraping builds: ' + error.message);
                } finally {
                    scrapeBuildsBtn.disabled = false;
                    scrapeBuildsBtn.textContent = 'üîç Scrape Builds Data';
                }
            });
        }

        // Check for cached build data on load
        async function checkCachedBuilds() {
            try {
                const result = await ipcRenderer.invoke('get-cached-builds');
                if (result.success) {
                    const timestamp = new Date(result.timestamp);
                    const timeStr = timestamp.toLocaleTimeString();
                    buildDataStatus.style.display = 'block';
                    buildDataInfo.textContent = `Using cached data from ${timeStr} (${result.data.totalBuilds} builds)`;
                    buildDataInfo.style.color = '#8b5cf6';
                }
            } catch (error) {
                console.log('No cached build data available');
            }
        }

        checkCachedBuilds();

        // Setup league selector - NO auto-load, only check cache
        const insightsLeagueSelect = document.getElementById('insightsLeague');
        if (insightsLeagueSelect) {
            insightsLeagueSelect.addEventListener('change', () => {
                // Reset counts
                document.getElementById('popularCount').textContent = '0';
                document.getElementById('profitableCount').textContent = '0';
                document.getElementById('trendingCount').textContent = '0';

                // Check for cached data instead of auto-loading
                checkCachedMarketInsights();
            });
        }

        // Check for cached data on initial load
        checkCachedMarketInsights();

        // Setup wealth input to trigger filtering
        const currentWealthInput = document.getElementById('currentWealth');
        if (currentWealthInput) {
            currentWealthInput.addEventListener('input', () => {
                // Re-display items with new filter if data already loaded
                if (insightsData.profitable.length > 0) {
                    displayProfitableItems();
                }
            });
        }

        function showInsightsError(message) {
            insightsError.textContent = message;
            insightsError.style.display = 'block';
            setTimeout(() => {
                insightsError.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
